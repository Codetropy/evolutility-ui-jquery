/*   evolutility 0.0.1 */

/*   (c) 2014 Olivier Giulieri */

var Evol=Evol||{};Evol.UI={version:"0.0.1",html:{trTableEnd:"</tr></table>",TdTrTableEnd:"</td></tr></table>",clearer:'<div class="clearfix"></div>',emptyOption:'<option value=""></option>',glyphicon:"glyphicon glyphicon-",required:'<span class="evol-required">*</span>'},fieldLabel:function(a,b){return['<div class="evol-field-label"><label for="',a,'">',b,"</label></div>"].join("")},fieldLabelSpan:function(a,b){return['<span class="evol-field-label"><label for="',a,'">',b,"</label></span>"].join("")},input:{text:function(a,b,c,d,e){var f="evo-field form-control "+(d||"")+Evol.UI.getSizeCSS(e),g=['<input type="text" id="',a,'" value="',b];if(c){if(_.each(["id","min","max","maxlength","placeholder"],function(a){void 0!==c[a]&&g.push('" ',a,'="',c[a])}),c.readonly){var h=c.readonly;(h||"1"==h)&&g.push('" ',item,'="',item)}f&&""!==f&&g.push('" class="',f)}return g.push('">'),g.join("")},textInt:function(a,b,c,d){var e=['<input class="evo-field form-control" type="number" id="',a,'" value="',b];return void 0!==c&&e.push('" min="',c),void 0!==d&&e.push('" max="',d),e.push('" maxlength="12">'),e.join("")},textM:function(a,b,c,d){return['<textarea name="',a,'" id="',a,'" class="evo-field form-control"" rows="',d,c>0?'" onKeyUp="Evol.UI.Validation.checkMaxLen(this,'+c+")":"",'">',b,"</textarea>"].join("")},textMJSON:function(a,b,c){return['<textarea rows="',c,'" class="evol-json">',_.escape(JSON.stringify(b,null,"	")),"</textarea>"].join("")},myType:function(a,b,c){return['<input type="',a,'" id="',b,'" value="',c,'" class="evo-field form-control" size="15">'].join("")},date:function(a,b){return this.myType("date",a,b)},dateTime:function(a,b){return this.myType("datetime-local",a,b)},time:function(a,b){return this.myType("time",a,b)},color:function(a,b){return['<input type="color" id="',a,'" value="',b,'" size="15">'].join("")},checkbox:function(a,b){var c=['<input type="checkbox" id="',a,'"'];return null!==b&&""!==b&&"0"!==b&&c.push(' checked="checked"'),c.push(' value="1">'),c.join("")},checkboxLOV:function(a){var b=[];for(var c in a){var d=a[c];b.push('<input type="checkbox" id="',d.id,'" value="',d.id,'"/>','<label for="',d.id,'">',d.text,"</label> ")}return b.join("")},radio:function(a,b,c,d,e){return['<label for="',e,'"><input id="',e,'" name="',a,'" type="radio" value="',b,d?'" checked="checked':"",'">',c,"</label>&nbsp;"].join("")},lov:function(a,b,c,d){var e=['<select class="evo-field form-control" id="',a,'"><option value="',b,'" selected>',c,"</option>"];return _.each(d,function(a){e.push(this.option(a.id,a.text))}),e.push("</select>"),e.join("")},img:function(a,b){return['<img id=""',a,'" src="',b,'"/>'].join("")},hidden:function(a,b){return['<input type="hidden" name="',a,'" id="',a,'" value="',b,'"/>'].join("")},hiddens:function(a){_.each(function(){a.push('<input type="hidden" name="',fID,'" id="',fID,'" value="',fV,'"/>')})},selectBegin:function(a,b,c){var d=['<select id="',a,'" class="form-control ',b,'">'];return c&&d.push(Evol.UI.html.emptyOption),d.join("")},select:function(a,b,c,d){return[this.selectBegin(a,b,c),this.options(d),"</select>"].join("")},option:function(a,b){return['<option value="',a,'">',b,"</option>"].join("")},options:function(a){var b=Evol.UI.input.option,c=[];return _.each(a,function(a){c.push(b(a.id,a.text))}),c.join("")},button:function(a,b,c){return'<button type="button" data-id="'+a+'" class="btn'+(c?" "+c:"")+'">'+b+"</button>"}},link:function(a,b,c){return['<a class="evo-field" href="',c,'" id="',a,'">',b,"</a>"].join("")},linkEmail:function(a,b,c){return Evol.UI.link(a,b,c?"mailto:"+c:"")},icon:function(a,b){return['<i class="',b?b+" ":"",Evol.UI.html.glyphicon,a,'"></i>'].join("")},iconCustomize:function(a,b){return Evol.UI.iconId(a,b,"wrench")},iconId:function(a,b,c){return['<i class="',Evol.UI.html.glyphicon,c,'" data-id="',a,'" data-type="',b,'"></i>'].join("")},HTMLPanelLabel:function(a){return['<div class="panel-heading">',Evol.UI.icon("chevron-up","evol-title-toggle"),'<h3 class="panel-title">',a,"</h3></div>"].join("")},HTMLEmptyPanel:function(a,b,c){return'<div class="'+b+" panel panel-"+c+'" data-id="'+a+'"></div>'},HTMLMsg:function(a,b,c,d){return['<div data-id="msg" class="alert alert-',c||"info",d?' alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>':'">',"<strong>",a,"</strong> ",b,"</div>"].join("")},formatDate:function(a){return a},formatTime:function(a){return a},formatDateTime:function(a){if(void 0!==a&&""!==a){var b=a.split("-");if(b.length>1)return b[1]+"/"+b[2]+"/"+b[0]}return""},getSizeCSS:function(a){switch(a){case"S":return" input-sm";case"L":return" input-lg"}return""},insertCollection:function(a,b){0===a.length&&_.each(b,function(b){a.create(b)})},capFirstLetter:function(a){return a&&a.length>0?a.substring(0,1).toUpperCase()+a.substring(1):""},trim:function(a){return a?a.replace(/^\s+|\s+$/g,""):""},setVisible:function(a,b){b?a.show():a.hide()}},Evol.UI.Charts={URL:"http://chart.apis.google.com/chart",_HTML:function(a,b,c){return['<div class="evol-chart-holder panel ',c,'"><label class="evol-chart-title">',a,'</label><img src="',b,'"><br></div>'].join("")},Pie:function(a,b,c,d){var e=[this.URL,"?chd=t:",b.join(","),"&amp;chl=",c.join("|"),"&amp;cht=p&amp;chds=0,20&amp;chs=360x200"].join("");return this._HTML(a,e,d||"panel-default")},Bars:function(a,b,c,d){var e=_.max(b),f=[this.URL,"?chbh=a&amp;chs=350x200&cht=bvg&chco=3a87ad,d9edf7&chds=0,",e,"&amp;chd=t:",b.join("|"),"&amp;chp=0.05&amp;chts=676767,10.5&amp;chdl=",c.join("|")].join("");return this._HTML(a,f,d)}},Evol.UI.Validation={checkMaxLen:function(a,b){a.value.length>b&&(a.value=a.value.substring(0,b-1))},checkNum:function(a,b){var c,d=a.value;if("i"==b.substring(0,1))c=parseInt(d,10);else{var e=Evol.i18n.LOCALE;("FR"==e||"DA"==e)&&(d=d.replace(",",".")),c=parseFloat(d)}isNaN(c)?a.value="":d!=c&&(a.value=c)},setValidationFlags:function(a,b){var c=a.find(".text-danger");c.length?c.html(b):a.append('<p class="text-danger">'+b+"</p>"),a.addClass("has-error")},checkFields:function(a,b,c){function d(){var a=Evol.Dico.fieldTypes,b=Evol.UI.trim(n.val());if(""!==b)switch(m.type){case a.integer:case a.email:k[m.type].test(b)||h.setValidationFlags(n.parent(),g(j[m.type]));break;case a.dec:var c=k[m.type+Evol.i18n.LOCALE];null===c&&(c=k[m.type+"EN"]),c.test(b)||h.setValidationFlags(n.parent(),g(j[m.type]));break;case a.date:case a.datetime:case a.time:""===b||_.isDate(new Date(b))||h.setValidationFlags(n.parent(),g(j[m.type]))}}function e(a){var b,c=a.tagName;return b="SELECT"==c&&a.get(0).selectedIndex>-1?"0"==f.options[a.get(0).selectedIndex].value:""===Evol.UI.trim(a.val())}function g(a,b){var c=a.replace("{0}",m.label);return null!==b&&(c=c.replace("{1}",b)),i.push(c),c}var h=this,i=[],j=Evol.i18n.validation,k={email:/^[\w\.\-]+@[\w\.\-]+\.[\w\.\-]+$/,integer:/^-?\d+$/,decimalEN:/^\d+(\.\d+)?$/,decimalFR:/^\d+(\,\d+)?$/,decimalDA:/^\d+(\,\d+)?$/};for(var l in b){var m=b[l],n=a.find("#"+c+"-"+m.id).eq(0),o="html"==m.type;if(o&&n.val(nicEditors.findEditor(f.id).getContent()),n.length>0){var p,q,r=!0;if(m.required>0?e(n,o)?(p=n.parent(),q=g(j.empty),h.setValidationFlags(p,q),r=!1):(n.parent().removeClass("control-group error").find(".evol-warn-error").remove(),d()):d(),null!==m.regex&&void 0!==m.regex){var s=new RegExp(m.regex);n.val().match(s)||(p=n.parent(),q=g(j.regex,m.label),h.setValidationFlags(n.parent(),q))}if(r){var t=Evol.UI.trim(n.val());""!==t&&(null!==m.max&&parseFloat(t)>m.max&&h.setValidationFlags(n.parent(),g(j.max,m.max)),null!==m.min&&parseFloat(t)<m.min&&h.setValidationFlags(n.parent(),g(j.min,m.min)))}}}return i.length>0?[j.intro,"<ul><li>",i.join("<li>"),"</li></ul>"].join(""):""}};var Evol=Evol||{};Evol.i18n={LOCALE:"EN",View:"View",Edit:"Edit",New:"New",NewItem:"New {0}",NewUpload:"New Upload",NewSearch:"New Search",Selections:"Selections",Selection:"Selection",Export:"Export",SearchRes:"Search Result",Delete:"Delete",All:"All",DeleteEntity:'Delete {0} "{1}"?',Back2SearchResults:"Back to search results",nodata:"No data available.",nopix:"No picture.",status:{added:'New {0} "{1}" added.',updated:'{0} "{1}" updated.',deleted:'{0} "{1}" removed.'},validation:{intro:"You are not finished yet:",empty:'"{0}" must have a value.',email:'"{0}" must be a valid email.',integer:'"{0}" must only use numbers.',decimal:'"{0}" must be a valid decimal numbers.',date:'"{0}" must be a valid date, format must be "MM/DD/YYYY" like "12/24/2005".',datetime:'"{0}" must be a valid date/time, format must be "MM/DD/YYYY hh:mm am/pm" like "12/24/2005 10:30 am".',time:'"{0}" must be a valid date/time, format must be "hh:mm am/pm" like "10:30 am".',max:'"{0}" must be smaller or equal to {1}.',min:'"{0}" must be greater or equal to {1}.',regex:'The value "{0}" is not of the expected format.'},"export":{ExportEntity:"Export this {0}",ExportHeader:"Header",ExportSeparator:"Separator",ExportFirstLine:"First line for field names",ExportFormat:"Export format",ExportFields:"Fields to include in the export",IDkey:"ID (Primary Key)",AllFields:"Show all fields",ExportFormats:"Comma separated (CSV, TXT, XLS...)-HTML-SQL Insert Statements (SQL)-Tab separated values (TXT)-XML-Javascript Object Notation (JSON)",xpXMLroot:"Element name",xpSQL:"SQL Options",xpSQLTable:"Table name",xpSQLTrans:"Inside transaction",xpSQLId:"Enable identity insert",DownloadEntity:"Download {0}"},Save:"Save",SaveAdd:"Save and Add Another",Cancel:"Cancel",NoChange:"No Change",NoX:"No {0}",filters:{sEqual:"equals",sNotEqual:"not equal",sStart:"starts with",sContain:"contains",sFinish:"finishes with",sInList:"any of",sIsNull:"is empty",sIsNotNull:"is not empty",sBefore:"before",sAfter:"after",sNumEqual:"&#61;",sNumNotEqual:"!&#61;",sGreater:"&#62;",sSmaller:"&#60;",sOn:"on",sNotOn:"not on",sAt:"at",sNotAt:"not at",sBetween:"between",opAnd:"and",yes:"Yes",no:"No",bNewFilter:"New filter",bAddFilter:"Add filter",bUpdateFilter:"Update filter",bSubmit:"Submit",bCancel:"Cancel"}};var Evol=Evol||{};Evol.Dico={fieldTypes:{text:"text",txtm:"textmultiline",bool:"boolean",dec:"decimal",integer:"integer",date:"date",time:"time",datetime:"datetime",pix:"image",lov:"lov",email:"email",url:"url",color:"color",hidden:"hidden",tag:"tag"},getFields:function(a,b){function c(a){a&&a.elements&&a.elements.length>0?_.each(a.elements,function(a){"panel-list"!=a.type&&c(a)}):d.push(a)}var d=[];return c(a),_.isFunction(b)&&(d=_.filter(d,b)),d},getSubCollecs:function(a){function b(a){"panel-list"===a.type?c.push(a):"panel"!==a.type&&a.elements&&a.elements.length>0?_.each(a.elements,function(a){"panel-list"===a.type?c.push(a):"panel"!==a.type&&b(a)}):c.push(a)}var c=[];return b(a),c},lovText:function(a,b,c){if("list"in b&&b.list.length>0){b.id in a||(a[b.id]={});var d=a[b.id];if(c in d)return d[c];var e=_.find(b.list,function(a){return a.id===c});if(e){var f=e.text;return e.icon&&(f='<img src="'+e.icon+'"> '+f),d[c]=f,f}}return""},isTypeDateOrTime:function(a){return a==EvoDico.fieldTypes.datetime||EvoDico.fieldTypes.date||a==EvoDico.fieldTypes.time},showDesigner:function(a,b,c){var d,e=$('<div class="evol-des-'+b+'"></div>');switch(b){case"field":d=dico_field_ui}return c.closest(".evol-fld").after(e),vw=new Evol.ViewOne.Edit({model:null,uiModel:d,defaultView:"edit",el:e,style:"panel-primary",size:"S",button_addAnother:!1}).render(),e.on("click","button#save,button#cancel",function(){e.remove()}),this},bbComparator:function(a){return function(b,c){return b.get(a)>c.get(a)}},bbComparatorText:function(a){return function(b,c){return(b.get(a)||"").localeCompare(c.get(a)||"")}}};var Evol=Evol||{};Evol.ViewMany=Backbone.View.extend({cardinality:"n",_hashLov:{},options:{style:"panel-info",pageSize:20,title:"#title",selectable:!0},events:{"click .evol-nav-id":"click_navigate","click .evol-sort-icons > i":"click_sort","click .button.edit":"click_pagination","click .evol-field-label .glyphicon-wrench":"click_customize"},initialize:function(a){var b=this;_.extend(this.options,a),this._filter=[],this.collection&&this.collection.on("change",function(){b.render()})},render:function(){var a=this.collection.models;if(this.collection.length){if(this._filter.length){var b=this;a=a.filter(function(a){for(var c=b._filter,d=!0,e=0,f=c.length;f>e&&d;e++){var g=c[e],h=g.value.value,i=a.get(g.field.value);switch(void 0===i&&(i=""),g.operator.value){case"eq":d=h===i;break;case"ne":d=h!==i;break;case"sw":d=0===i.indexOf(h);break;case"ct":d=i.indexOf(h)>-1;break;case"fw":d=i.indexOf(h)===i.length-h.length;break;case"null":d=""===i||void 0===i;break;case"nn":d=""!==i||void 0!==i;break;case"in":d=_.contains(h.split(","),i);break;case 1:d=i;break;case 0:d=!i}}return d})}this._render(a)}else this.$el.html(Evol.UI.HTMLMsg(Evol.i18n.nodata,"","info"));return this._updateTitle(),this},_render:function(){alert("_render must be overwritten")},customize:function(){var a=this.$("th > span");return this._custOn?(a.find("i").remove(),this._custOn=!1):(a.append(Evol.UI.iconCustomize("id","field")),this._custOn=!0),this},setModel:function(a){return a&&a.collection&&(this.collection=a.collection),this.render(),this},setCollection:function(a){return this.collection=a,this.render(),this},setFilter:function(a){return this._filter=a,this},_updateTitle:function(){},getFields:function(){if(!this._fields){this._fields=Evol.Dico.getFields(this.options.uiModel,function(a){return a.viewmany}),this._fieldHash={};var a=this;_.each(this._fields,function(b){a._fieldHash[b.id]=b})}return this._fields},getField:function(a){return this._fieldHash[a]},_HTMLField:function(a,b){var c=Evol.Dico.fieldTypes;switch(a.type){case c.bool:if("true"===b||"1"==b)return Evol.UI.icon("ok");break;case c.lov:if(""!==b)return Evol.Dico.lovText(this._hashLov,a,b);break;case c.date:case c.time:case c.datetime:return Evol.UI.formatDateTime(b);case c.pix:if(b.length)return Evol.UI.input.img(a.id,b);break;default:return b}return""},_paginationSummaryHTML:function(a,b,c,d,e){var f,g=a*b+1;if(1>a){if(0===c)return c+" "+e;if(1===c)return c+" "+d;f=_.min([b,c])}else f=_.min([g+b,c]);return["<p>",g,"-",f," of ",c," ",e,"</p>"].join("")},_paginationHTML:function(a,b,c){var d=a*b+1,e=parseInt(c/b,10),f=e>5?5:e,g=['<ul class="pagination pagination-sm">'];a>0&&g.push('<li data-id="prev"><a href="#">&laquo;</a></li>');for(var h=d;f>h;h++)g.push('<li data-id="',h,'"><a href="#">',h,"</a></li>");return c>(a+1)*b&&g.push('<li data-id="next"><a href="#">&raquo;</a></li>'),g.push("</ul>"),g.join("")},sortList:function(a,b){var c=this.collection,d=Evol.Dico.fieldTypes;void 0!==c&&(c.comparator=a.type==d.text||a.type==d.txtm||a.type==d.email?Evol.Dico.bbComparatorText(a.id):Evol.Dico.bbComparator(a.id),c.sort(),b&&c.models.reverse(),this.renderBody?this.renderBody(c.models):this.render(),this.$el.trigger("list.sort",{id:a.id,direction:b?"down":"up"}))},click_navigate:function(a){var b=$(a.currentTarget),c="list"===this.options.mode?"tr":"div";a.type="list.navigate",this.$el.trigger(a,{id:b.closest(c).data("id")})},click_sort:function(a){var b=$(a.currentTarget),c=b.parent().data("fid"),d=this.getField(c),e=b.attr("class").indexOf("-down")>0;this.sortList(d,e),b.addClass("evol-last-sort")},click_pagination:function(a){this.$el.trigger("list.paginate",{id:$(a.currentTarget).closest("li").data("id")})},click_customize:function(a){var b=$(a.currentTarget),c=b.data("id"),d=b.data("type");Evol.Dico.showDesigner(c,d,b),this.$el.trigger(d+".customize",{id:c,type:d})}});var Evol=Evol||{};Evol.ViewMany.Cards=Evol.ViewMany.extend({viewName:"cards",options:{style:"panel-info",pageSize:20,title:"#title",selectable:!0},customize:function(){var a=this.$("h4 > a.evol-nav-id");return this._custOn?(a.find("i").remove(),this._custOn=!1):(a.append(Evol.UI.iconCustomize("id","field")),this._custOn=!0),this},_render:function(a){var b=[];if(a&&a.length>0){var c=this.options,d=c.uiModel,e=c.pageSize||50,f=this._paginationSummaryHTML(0,e,a.length,d.entity,d.entities);b.push('<div class="evol-many-cards">'),this._HTMLcards(b,this.getFields(),e,d.icon),b.push(f,this._paginationHTML(0,e,a.length),"</div>")}else b.push(Evol.UI.HTMLMsg(Evol.i18n.nodata,"","info"));return this.$el.html(b.join("")),this},_HTMLcards:function(a,b,c,d){var e=this.collection.models,f=_.min([e.length,c]);if(f>0){for(var g=0;f>g;g++){a.push('<div class="panel ',this.options.style,'">');for(var h=0;h<b.length;h++){var i=b[h],j=e[g],k=j.get(i.id);0===h?(a.push('<div data-id="',j.id,'">','<h4><a href="#" id="fg-',i.id,'" class="evol-nav-id">'),d&&a.push('<img class="evol-table-icon" src="pix/',d,'">'),a.push(this._HTMLField(i,k),"</a></h4></div>")):a.push("<div>",this._HTMLField(i,k),"</div>")}a.push("</div>")}a.push(Evol.UI.html.clearer)}else a.push(Evol.UI.HTMLMsg(Evol.i18n.nodata,"","info"))}});var Evol=Evol||{};Evol.ViewMany.Charts=Evol.ViewMany.extend({viewName:"chart",options:{style:"normal",pageSize:20,title:"#title",selectable:!0},events:{"click .evol-field-label .glyphicon-wrench":"click_customize"},render:function(){var a=[];if(this.collection&&this.collection.length>0){var b=this.options;b.uiModel,b.pageSize||50,a.push('<div class="evol-many-',this.viewName,'">'),this._HTMLcharts(a,b.style),a.push("</div>")}else a.push(Evol.UI.HTMLMsg(Evol.i18n.nodata,"","info"));return this._updateTitle(),this.$el.html(a.join("")),this},_HTMLcharts:function(a,b){var c=this,d=Evol.UI,e=Evol.Dico,f=e.fieldTypes,g=this.options.uiModel,h=this.collection.models,i=e.getFields(g,function(a){return a.type==f.lov||a.type==f.bool||a.type==f.integer});i&&i.length?_.each(i,function(i){var j=_.countBy(h,function(a){return a.get(i.id)}),k=j,l=[],m=[];for(var n in k){var o=k[n];l.push(o),i.type==f.lov?m.push(e.lovText(c._hashLov,i,n)+" ("+o+")"):m.push(n+" ("+o+")")}var p=d.capFirstLetter(g.entities);i.type==f.lov?a.push(d.Charts.Pie(p+" by "+i.label,l,m,b)):a.push(d.Charts.Bars(p+": "+i.label,l,m,b))}):a.push(d.HTMLMsg("No charts available","The data structure doesn't allow for autogenerated charts.")),a.push(d.html.clearer)}});var Evol=Evol||{};Evol.ViewMany.List=Evol.ViewMany.extend({viewName:"list",options:{style:"panel-info",pageSize:20,selectable:!0},_render:function(a){var b=[],c=this.getFields(),d=this.options,e=d.uiModel,f=d.pageSize||50,g=this._paginationSummaryHTML(0,f,a.length,e.entity,e.entities);this._models=a,b.push('<div class="evol-many-list">','<table class="table table-bordered table-hover"><thead>');for(var h=0;h<c.length;h++)this._HTMLlistHeader(b,c[h]);b.push("</thead><tbody>"),this._HTMLlistBody(b,c,f,e.icon),b.push("</tbody></table>",g,this._paginationHTML(0,f,a.length),"</div>"),this.$el.html(b.join(""))},renderBody:function(){var a=[],b=this.getFields(),c=this.options,d=c.uiModel,e=c.pageSize||50;this._HTMLlistBody(a,b,e,d.icon),this.$(".table > tbody").html(a.join(""))},_HTMLlistBody:function(a,b,c,d){var e=this._models,f=_.min([e.length,c]);if(f>0)for(var g=0;f>g;g++)this._HTMLlistRow(a,b,e[g],d)},_HTMLlistRow:function(a,b,c,d){a.push('<tr data-id="',c.cid,'">');for(var e=0;e<b.length;e++){var f=b[e],g=c.escape(f.id);a.push("<td>"),0===e&&(a.push('<a href="javascript:void(0)" id="fv-',f.id,'" class="evol-nav-id">'),_.isFunction(d)?a.push('<img class="evol-table-icon" src="pix/',d(c),'">'):""!==d&&a.push('<img class="evol-table-icon" src="pix/',d,'">'),""===g&&(g="("+c.id+")")),a.push(this._HTMLField(f,g)),0===e&&a.push("</a>"),a.push("</td>")}a.push("</tr>")},_HTMLlistHeader:function(a,b){a.push('<th><span id="',b.id,'-lbl">',b.labellist||b.label,'<span class="evol-sort-icons" data-fid="',b.id,'">',Evol.UI.icon("chevron-up"),Evol.UI.icon("chevron-down"),"</span></span></th>")}});var Evol=Evol||{};Evol.ViewOne=Backbone.View.extend({events:{"click .evol-buttons > button":"click_button","click .evol-title-toggle":"click_toggle","click ul.evol-tabs > li > a":"click_tab","click label > .glyphicon-question-sign":"click_help","click .evol-field-label .glyphicon-wrench":"click_customize"},cardinality:"1",options:{button_addAnother:!1,style:"panel-info",titleSelector:"#title"},initialize:function(a){var b=this;_.extend(this.options,a),this._uTitle=void 0!==this.options.titleSelector&&""!==this.options.titleSelector,this.model&&this.model.on("change",function(a){b.setModel(a)})},render:function(){var a=this.options.mode,b=[];return this.renderEdit(b,a),this.$el.html(b.join("")),this.setData(this.model),this.custOn=!1,this},getFields:function(){if(!this._fields){this._fields=Evol.Dico.getFields(this.options.uiModel,this.getFieldsCondition),this._fieldHash={};var a=this;_.each(this._fields,function(b){a._fieldHash[b.id]=b})}return this._fields},getSubCollecs:function(){return this._subCollecs||(this._subCollecs=Evol.Dico.getSubCollecs(this.options.uiModel)),this._subCollecs},setModel:function(a){return this.model=a,this.clearMessages().setData(a)},setUIModel:function(a){this.options.uiModel=a;var b=this.getData();return this.render().setData(b)},modelUpdate:function(a){var b=this;_.each(a.changed,function(a,c){b.setFieldValue(c,a)})},getSummary:function(){if(this.model){var a=this.options.uiModel.leadfield;return _.isFunction(a)?a(this.model):this.model.get(a)}return Evol.UI.capFirstLetter(this.options.uiModel.entity)},getData:function(){var a=this,b={};return _.each(this.getFields(),function(c){b[c.id]=a.getFieldValue(c)}),b},setData:function(a){if(void 0!==a&&null!==a){var b,c,d=this.getFields(),e=this,f=Evol.Dico.fieldTypes,g="#"+e.prefix+"-",h=this.getSubCollecs();_.each(d,function(d){if(b=e.$(g+d.id),c=a.get(d.id),a)switch(d.type){case f.lov:b.children().removeAttr("selected").filter("[value="+c+"]").attr("selected",!0);break;case f.bool:b.prop("checked",c);break;case f.pix:var h=""!==c?'<img src="'+c+'" class="img-thumbnail">':'<p class="">'+Evol.i18n.nopix+"</p>";b.val(c).prev().remove(),b.before(h);break;default:b.val(c)}}),h&&h.length>0&&_.each(h,function(a){var b=[];e._renderPanelListBody(b,a),e.$('[data-pid="'+a.id+'"] tbody').html(b.join(""))})}return this._updateTitle()},clear:function(){var a,b=this.getFields(),c=this,d="#"+c.prefix+"-";return this.clearMessages(),_.each(b,function(b){switch(a=c.$(d+b.id),b.type){case"boolean":a.prop("checked",b.defaultvalue||"");break;default:a.val(b.defaultvalue||"")}}),this},setFieldValue:function(a,b){return this.$("#"+this.fieldViewId(a)).val(b),this},getFieldValue:function(a){var b=this.$("#"+this.fieldViewId(a.id));switch(a.type){case Evol.Dico.fieldTypes.bool:return b.prop("checked");default:return b.val()}},showTab:function(a){var b=this.$(a);return b.length>0&&(b.siblings(".tab-pane").hide(),b.show()),b=this.$('.evol-tabs > li a[href="'+a+'"]').parent(),b.length>0&&(b.siblings("li").removeClass("active"),b.addClass("active")),this.$el.trigger("tab.show"),this},_renderButtons:function(a,b){var c=Evol.UI.getSizeCSS(this.options.size);a.push(Evol.UI.html.clearer,'<div class="evol-buttons">',Evol.UI.input.button("cancel",Evol.i18n.Cancel,"btn-default"+c),Evol.UI.input.button("save",Evol.i18n.Save,"btn-primary"+c)),this.options.button_addAnother&&"json"!==b&&a.push(Evol.UI.input.button("save-add",Evol.i18n.SaveAdd,"btn-default"+c)),a.push("</div>")},renderEdit:function(a,b){var c=-1,d=-1,e=this.options,f=e.uiModel.elements;if("mini"===b){var g=Evol.Dico.getFields(e.uiModel,function(a){return a.searchlist||a.required||a.mini},e.mode),h={type:"panel","class":"evol-mini-holder",label:Evol.UI.capFirstLetter(e.uiModel.entity),width:100,elements:g};this.renderPanel(a,h,"evo-one-mini",b)}else{a.push('<div class="evo-one-',b,'">');for(var i=0,j=f.length;j>i;i++){var k=f[i];switch(k.type){case"tab":d>0&&(a.push("</div>"),d=-1),0>c&&(a.push(Evol.UI.html.clearer),this.renderTabs(a,f),a.push('<div class="tab-content">')),c++,a.push('<div id="evol-tab-',i,'" class="tab-pane',1===i?' active">':'">'),this.renderTab(a,k,b),c==j-1&&a.push("</div>");break;case"panel":0>d&&(a.push('<div class="evol-pnls">'),d=1),this.renderPanel(a,k,"p-"+k.id,b);break;case"panel-list":this._hasSubCollec=!0,0>d&&(a.push(""),d=1),this.renderPanelList(a,k,b)}}d>0&&a.push("</div>"),a.push("</div>")}this._renderButtons(a,b)},renderTabs:function(a,b){var c=!0;a.push('<ul class="nav nav-tabs evol-tabs">'),_.each(b,function(b,d){"tab"==b.type&&(c?(a.push('<li class="active">'),c=!1):a.push("<li>"),a.push('<a href="#evol-tab-',d,'">',b.label,"</a></li>"))}),a.push("</ul>")},renderTab:function(a,b,c){var d=this;a.push('<div class="evol-pnls">'),_.each(b.elements,function(b,e){"panel-list"===b.type?d.renderPanelList(a,b,c):d.renderPanel(a,b,b.id||"pl-"+e,c)}),a.push(Evol.UI.html.clearer,"</div></div>")},renderPanel:function(a,b,c,d){var e=this;a.push('<div data-p-width="',b.width,'" class="evol-pnl'),"mini"===d?a.push(" w-100 ",b.class||"",'">'):a.push(' pull-left" style="width:',b.width,'%">'),a.push('<div class="panel ',this.options.style,'">',Evol.UI.HTMLPanelLabel(b.label,c,"PanelLabel"),'<fieldset data-pid="',c,'">'),"mini"===d?_.each(b.elements,function(b){a.push('<div class="pull-left evol-fld w-100">'),e.renderField(a,b,d),a.push("</div>")}):_.each(b.elements,function(b){a.push('<div style="width:',parseInt(b.width,10),'%" class="pull-left evol-fld">'),e.renderField(a,b,d),a.push("</div>")}),a.push("</fieldset></div></div>")},renderPanelList:function(a,b,c){a.push('<div style="width:',b.width,'%" class="evol-pnl pull-left" data-pid="',b.id,'">','<div class="panel ',this.options.style,'">',Evol.UI.HTMLPanelLabel(b.label,b.id,"PanelLabel"),'<table class="table"><thead><tr>'),_.each(b.elements,function(b){a.push("<th>",b.label,"</th>")}),a.push("</tr></thead><tbody>"),this._renderPanelListBody(a,b,c),a.push("</tbody></table></div></div>")},_renderPanelListBody:function(a,b){var c=this.model.get(b.attr);c&&c.length>0?_.each(c,function(c){a.push("<tr>"),_.each(b.elements,function(b){c[b.id]?a.push("<td>",c[b.id],"</td>"):a.push("<td></td>")}),a.push("</tr>")}):a.push('<tr><td colspan="',b.elements.length,'" class="evol-pl-nodata">',Evol.i18n.nodata,"</td></tr>")},renderField:function(a,b,c){var d,e,f=Evol.UI,g=Evol.Dico.fieldTypes,h=this.fieldViewId(b.id),i=this.options.size;if(this.model&&this.model.has(b.id)&&(d="new"!==c?this.model.get(b.id):b.defaultvalue||""),"mini"===c?(e=b.width,b.width=100,a.push('<div class="evol-mini-label">'),this.renderFieldLabel(a,b,c),a.push('</div><div class="evol-mini-content">')):this.renderFieldLabel(a,b,c),b.readonly>0)a.push('<div id="',h,'" class="FieldReadOnly">',d,"&nbsp;</div>");else switch(b.type){case g.text:a.push(f.input.text(h,d,b,null,i));break;case g.email:"view"===c?a.push(f.link(h,d,"mailto:"+HttpUtility.HtmlEncode(d))):a.push(f.input.text(h,d,b.maxlength));break;case g.url:"view"===c?a.push(f.link(h,d,HttpUtility.HtmlEncode(d))):a.push(f.input.text(h,d,b.maxlength));break;case g.integer:case g.dec:a.push(f.input.textInt(h,d));break;case g.bool:a.push(f.input.checkbox(h,d));break;case g.txtm:case g.html:null===b.height?b.height=5:(fHeight=parseInt(b.height,10),1>fHeight&&(b.height=5)),a.push(f.input.textM(h,d,b.maxlength,b.height));break;case g.date:a.push(f.input.date(h,d));break;case g.datetime:a.push(f.input.dateTime(h,d));break;case g.time:a.push(f.input.time(h,d));break;case g.color:a.push(f.input.color(h,d));break;case g.lov:a.push(f.input.select(h,"",!0,b.list));break;case g.integer:a.push(f.input.textInt(h,d,b.max,b.min));break;case g.pix:""!==d?a.push('<img src="',d,'" class="img-thumbnail">'):a.push('<p class="">',Evol.i18n.nopix,"</p>"),a.push(f.input.text(h,d,b,null,i))}"mini"===c&&(a.push("</div>"),b.width=e)},renderFieldLabel:function(a,b,c){a.push('<div class="evol-field-label" id="',b.id,'-lbl"><label class="control-label" for="',b.id,'">',b.label),"view"!=c&&b.required&&a.push(Evol.UI.html.required),b.help&&""!==b.help&&a.push(Evol.UI.icon("question-sign","")),a.push("</label></div>")},newItem:function(){return this.clear()._updateTitle(Evol.i18n.NewItem.replace("{0}",this.options.uiModel.entity).replace("{1}",this.getSummary()))},_updateTitle:function(a){if(this._uTitle){var b=this.options,c=b.titleSelector;if(c&&""!==c){var d,e=b.uiModel.leadfield;return d=a?a:void 0!==e&&""!==e?this.getSummary():Evol.UI.capFirstLetter(b.uiModel.entities),$(c).text(d),this._uTitle=!0,this}this._uTitle=!1}return this},validate:function(){var a=this.getFields();return this.clearMessages(),_.isArray(a)?(this.$el.trigger("view.validate"),Evol.UI.Validation.checkFields(this.$el,a,this.prefix)):!1},clearErrors:function(){return this.$(".control-group.error").removeClass("control-group error"),this.$(".has-error").removeClass("has-error"),this.$(".text-danger").remove(),this},commit:function(a,b){var c=this.validate();if(""===c){var d=this,e=Evol.UI.capFirstLetter(this.options.uiModel.entity);if("new"===this.options.mode){var f=this.model&&this.model.collection?this.model.collection:this.collection;f?(f.create(this.getData(),{success:function(b){a(b),d.setMessage("Record saved.",Evol.i18n.status.added.replace("{0}",e).replace("{1}",d.getSummary()),"success"),d.$el.trigger("save","add"),d._updateTitle()},error:b}),this.options.mode="edit"):alert("Can't save record b/c no collection is specified.")}else this.model.set(this.getData()),this.model.save("","",{success:function(b){a(b),d.setMessage("Record saved.",Evol.i18n.status.updated.replace("{0}",e).replace("{1}",d.getSummary()),"success"),d.$el.trigger("save","update"),d._updateTitle()},error:b})}else this.setMessage("Invalid data.",c,"warning");return this},fieldViewId:function(a){return this.prefix+"-"+a},customize:function(){var a=".evol-field-label > label",b=".evol-pnl .panel-title";return this.custOn?(this.$(a+">i, "+b+">i").remove(),this.custOn=!1):(_.each(this.$(a),function(a){var b=$(a),c=b.attr("for");b.append(Evol.UI.iconCustomize(c,"field"))}),this.$(b).append(Evol.UI.iconCustomize("id","panel")),this.custOn=!0),this},showHelp:function(a,b,c){var d=Evol.Dico.getFields(this.options.uiModel),e=_.findWhere(d,{id:a});if(e||e.help){var f=c.closest(".evol-fld"),g=f.find(".help-block");if(g.length>0)g.slideUp(300,function(){g.remove()});else{var h=$('<span class="help-block">'+_.escape(e.help)+"</span>").hide();f.append(h),h.slideDown(300)}}return this},setMessage:function(a,b,c){var d=this.$('[data-id="msg"]');return d.length?d.html("<strong>"+a+"</strong>"+b):this.$el.prepend(Evol.UI.HTMLMsg(a,b,c)),this},clearMessage:function(){var a=this.$('[data-id="msg"]').fadeOut(300,function(){a.remove()});return this},clearMessages:function(){return this.clearErrors().clearMessage()},click_button:function(a){var b=this,c=$(a.currentTarget).data("id");a.stopImmediatePropagation(),"cancel"===c||this.commit(function(a){"save-add"===c?b.newItem():(b.model=a,b.setModel(a))},function(){alert("error")})},click_toggle:function(a){var b,c=$(a.target),d=c.closest(".panel-heading").next(),e=d.data("expState"),f="glyphicon-chevron-up",g="glyphicon-chevron-down";a.preventDefault(),a.stopImmediatePropagation(),a.shiftKey?(c=this.$(".evol-title-toggle"),b="down"===e?g:f,c=this.$(".evol-title-toggle."+b).trigger("click")):"down"===e?(c.closest(".panel").css("height",""),d.slideDown(400).data("expState","up"),c.addClass(f).removeClass(g)):(d.slideUp(400,function(){c.closest(".panel").css("height","40px")}).data("expState","down"),c.removeClass(f).addClass(g)),this.$el.trigger("panel.toggle")},click_tab:function(a){var b=a.target.href,c=b.substring(b.indexOf("#"));a.stopImmediatePropagation(),a.preventDefault(),a.shiftKey?this.$(".tab-content > div").show():this.showTab(c)},click_help:function(a){var b=$(a.currentTarget),c=b.closest("label").attr("for"),d=b.data("type");a.stopImmediatePropagation(),this.showHelp(c,d,b),this.$el.trigger(d+".help",{id:c})},click_customize:function(a){var b=$(a.currentTarget),c=b.data("id"),d=b.data("type");a.stopImmediatePropagation(),Evol.Dico.showDesigner(c,d,b),this.$el.trigger(d+".customize",{id:c,type:d})}});var Evol=Evol||{};Evol.ViewOne.Edit=Evol.ViewOne.extend({viewName:"edit",prefix:"oe",render:function(){var a=[];return this.renderEdit(a),this.$el.html(a.join("")),this.setData(this.model),this.custOn=!1,this}});var Evol=Evol||{};
Evol.ViewOne.JSON=Evol.ViewOne.extend({events:{"click > .evol-buttons > button":"click_button","click .evol-title-toggle":"click_toggle","click .evol-field-label .glyphicon-wrench":"click_customize"},viewName:"json",render:function(){var a=[];if(this.model){var b=JSON.stringify(this.model,null,2);a.push(Evol.UI.input.textMJSON("",b,10))}return this._renderButtons(a,"json"),this.$el.html(a.join("")),this.setData(this.model),this.custOn=!1,this},getData:function(){var a=this.$el.children("textarea").val();return $.parseJSON(a)},setData:function(a){return this.$el.children("textarea").val(JSON.stringify(a,null,2)),this._updateTitle()},clear:function(){return this.$el.children("textarea").val(""),this}});var Evol=Evol||{};Evol.ViewOne.Mini=Evol.ViewOne.extend({events:{"click > .evol-buttons > button":"click_button","click .evol-title-toggle":"click_toggle","click label > .glyphicon-question-sign":"click_help"},viewName:"mini",prefix:"om",getFieldsCondition:function(a){return a.required||a.viewmany||a.viewmini},render:function(){var a=this.options.mode,b=[];return this._renderEdit(b,a),this.$el.html(b.join("")),this.setData(this.model),this.custOn=!1,this},_renderEdit:function(a,b){var c=this.options,d=this.getFields(),e={type:"panel","class":"evol-mini-holder",label:Evol.UI.capFirstLetter(c.uiModel.entity),width:100,elements:d};this.renderPanel(a,e,"evol-one-mini",b),this._renderButtons(a,b)}});var Evol=Evol||{};Evol.ViewToolbar=Backbone.View.extend({events:{"click .nav a":"click_toolbar","list.navigate div":"click_navigate","click #XP":"click_download","save > div":"saveItem"},options:{toolbar:!0,defaultView:"list",style:"panel-info",display:"tooltip",buttons:{edit:!0,mini:!0,json:!0,list:!0,cards:!0,charts:!0,"new":!0,del:!0,filter:!1,"export":!0,group:!1,customize:!0}},modesHash:{edit:"Edit",mini:"Mini",json:"JSON",cards:"Cards",list:"List",charts:"Charts"},views:[],viewsHash:{},curView:null,curViewName:"",_group:!1,initialize:function(a){_.extend(this.options,a),this.render(),this.$(".dropdown-toggle").dropdown()},render:function(){var a=this.$el;a.html(this._toolbarHTML()),this.setView(this.options.defaultView||"list"),this._viewsIcon=this.$(".glyphicon-eye-open")},_toolbarHTML:function(){function a(a,b){return['<li class="dropdown" data-id="',a,'">','<a href="#" class="dropdown-toggle" data-toggle="dropdown">',Evol.UI.icon(b),' <b class="caret"></b></a>','<ul class="dropdown-menu evo-dropdown-icons">'].join("")}function b(a,b,c,e,f){d.push('<li data-id="',a,'"'),e&&d.push(' data-cardi="'+e,'"'),"label"!==f&&d.push(' data-toggle="tooltip" data-placement="bottom" title="" data-original-title="',b,'"'),d.push('><a href="#" data-id="',a,'">',Evol.UI.icon(c)),"tooltip"!==f&&d.push("&nbsp;",b),d.push("</a></li>")}function c(a,c,d,f){e.buttons&&e.buttons[a]&&b(a,c,d,f,"tooltip")}var d=[],e=this.options,f="</ul></li>";return d.push('<div class="evo-toolbar"><ul class="nav nav-pills pull-left" data-id="main">'),c("list",Evol.i18n.All,"th-list"),c("new",Evol.i18n.New,"plus"),c("del",Evol.i18n.Delete,"trash","1"),c("filter","Filter","filter","n"),c("export","Export","cloud-download","n"),e.toolbar&&(b("prev","","chevron-left","1"),b("next","","chevron-right","1"),d.push('</ul><ul class="nav nav-pills pull-right" data-id="views">'),d.push(a("views","eye-open")),c("list","List","th-list","n"),c("cards","Cards","th-large","n"),c("charts","Charts","stats","n"),c("edit","All Fields","th","1"),c("mini","Important Fields only","th-large","1"),c("json","JSON","barcode","1"),d.push(f)),d.push("</ul>",Evol.UI.html.clearer,"</div>"),d.join("")},updateModel:function(){this.refresh()},refresh:function(){return this.viewsHash.list&&this.viewsHash.list.render(),this.viewsHash.cards&&this.viewsHash.cards.render(),this},setView:function(a){var b,c=this.options,d=this.$el,e="evolw-"+a,f=this.$('[data-vid="'+e+'"]'),g=this.curView,h=this.model?this.model.collection:new c.collectionClass;if("new"===a)a=this._prevOne?this._prevOne:"edit",this.setView(a),this._isNew=!0,this.model=new c.modelClass,this.model.collection=h,this.curView.newItem(this.model),this.curView.options.mode="new";else if(this._isNew=!1,f.length)this.model=this.curView.model,this.curView=this.viewsHash[a],this.isNew||(this.curView.setModel?(!this.curView.collection&&m.collection&&(this.curView.collection=this.model.collection),this.curView.setModel(this.model)):this.curView.model=this.model,this.model||(this.curView.collection=h)),this.$('[data-id="views"] > li').removeClass("evo-sel").filter('[data-id="'+a+'"]').addClass("evo-sel"),f.show().siblings().not(".evo-toolbar,.evo-filters,.clearfix").hide();else{switch(f=$('<div data-vid="evolw-'+a+'"></div>'),d.children().not(".evo-toolbar,.evo-filters,.clearfix").hide(),d.append(f),b={el:f,mode:a,model:this.model,collection:this.collection,uiModel:c.uiModel,style:c.style},this.$('[data-id="new"]').show(),this.$('[data-id="views"] > li').removeClass("evo-sel").filter('[data-id="'+a+'"]').addClass("evo-sel"),a){case"edit":case"mini":case"json":g=new Evol.ViewOne[this.modesHash[a]](b).render(),this._prevOne=a;break;case"charts":case"cards":case"list":g=new Evol.ViewMany[this.modesHash[a]](b).render(),this._prevMany=a;break;case"export":g=new Evol.ViewExport(b),f.addClass("panel panel-info").slideDown()}this.curView=g,this.curViewName=a,this.viewsHash[a]=g}return this.setButtons(a),this},getToolbarButtons:function(){if(!this._toolbarButtons){var a=this.$("li");this._toolbarButtons={ones:a.filter('[data-cardi="1"]'),manys:a.filter('li[data-cardi="n"]'),prevNext:this.$('[data-id="prev"],[data-id="next"]'),customize:this.$('a[data-id="customize"]').parent(),views:this.$('[data-id="views"]')}}return this._toolbarButtons},setButtons:function(a){function b(a,b){Evol.UI.setVisible(c.ones,a),Evol.UI.setVisible(c.manys,b)}if(this.$el){var c=this.getToolbarButtons();if(Evol.UI.setVisible(c.customize,"json"!=a),c.prevNext.hide(),Evol.UI.setVisible(c.views,"export"!==a),this._viewsIcon){var d="glyphicon-eye-open",e="glyphicon-eye-close";"mini"===a||"json"===a?this._viewsIcon.removeClass(d).addClass(e):this._viewsIcon.removeClass(e).addClass(d)}this._isNew||"export"===a?(b(!1,!1),this._isNew):"cards"===a||"list"===a||"charts"===a?(this._prevMany=a,b(!1,!0)):(this._prevOne=a,b(!0,!1),c.prevNext.show()),Evol.UI.setVisible(c.manys.filter('[data-id="group"]'),"cards"===a)}},showFilter:function(){if(!this._filters){var a=this,b=$(Evol.UI.HTMLEmptyPanel("filters","evo-filters","info"));this.$(".evo-toolbar").after(b),this._filters=new Evol.ViewFilter({el:b,fields:Evol.Dico.getFields(this.options.uiModel)}).render(),b.on("change.filter",function(){a.curView.setFilter(a._filters.val()).render()})}return this},showGroup:function(){return this._group=!0,this.curView.showGroup(),this},setData:function(a){return this.curView&&this.curView.setData(a),this},getData:function(){return this.curView?this.curView.getData():null},browse:function(a){var b=this.curView.model;if(this.model&&this.model.collection&&this.model.collection.length){var c=this.model.collection,d=c.length-1,e=_.indexOf(c.models,b);e="prev"===a?e>0?e-1:d:d>e?e+1:0,b=c.models[e]}else b=null;return this.model=b,this.curView.setModel(b),this},saveItem:function(a,b){"add"===b&&(this._isNew=!1,this.setButtons("edit"))},newItem:function(){},deleteItem:function(){var a=this.options.uiModel.entity,b=this.curView.getSummary(),c=this.curView.model;if(c&&confirm(Evol.i18n.DeleteEntity.replace("{0}",a).replace("{1}",b))){var d=this,e=this.collection,f=_.indexOf(e.models,c),g=f,h=null;e.length>1&&(g=0===f?1:f<e.length-1?f+1:f-1,h=e.at(g)),h&&(h.collection=e),c.destroy({success:function(){0===e.length?d.curView.clear():(this.model=h,d.curView.setModel(h)),d.curView.setMessage("Record Deleted.",Evol.i18n.status.deleted.replace("{0}",Evol.UI.capFirstLetter(a)).replace("{1}",b),"success")},error:function(){alert("error")}})}},click_toolbar:function(a){var b=$(a.target);"A"!==b.tagName&&(b=b.closest("a"));var c=b.data("id");switch(a.preventDefault(),a.stopImmediatePropagation(),c){case"del":this.deleteItem();break;case"customize":this.curView.customize();break;case"group":this.showGroup();break;case"filter":this.showFilter();break;case"prev":case"next":this.browse(c);break;case"new-field":Evol.Dico.showDesigner("","field",b);break;default:c&&""!==c&&this.setView(c)}a.stopImmediatePropagation(),this.$el.trigger("toolbar."+c)},click_navigate:function(a,b){var c=this.model.collection.get(b.id);this.model=c,this.setView(this._prevOne||"edit"),this.curView.model=c,this.curView.render(),a.stopImmediatePropagation()},click_download:function(){alert("Sorry, no demo server yet...")}});var Evol=Evol||{},evoLangXpt=Evol.i18n.export;Evol.ViewExport=Backbone.View.extend({version:"0.0.1",events:{"change .evol-xpt-format":"click_format","change input":"click_preview","click .evol-xpt-more":"click_toggle_sel","click #XP":"click_submit"},options:{toolbar:!0,model:null,uiModel:null,style:"normal",prefix:"tbr"},many:!0,viewName:"export",initialize:function(a){_.extend(this.options,a),this.render();var b=this.$el;return b.addClass("Panel"),this._preview("CSV"),this},render:function(){return this.$el.html(this._renderHTML()),this._preview("CSV"),this},_renderHTML:function(){var a=[],b=Evol.UI,c=this.options,d=c.prefix||"",e=this.getFields();a.push('<div class="evol-xpt-form"><div class="evol-xpt-flds"><fieldset>'),a.push('<div class="evol-id">',b.fieldLabel("",evoLangXpt.ExportFields),"</div>");for(var f=0,g=e.length;g>f;f++){var h=e[f],i=h.label,j="fx-"+h.id;(null===i||""===i)&&(i="("+j+")"),a.push('<div><input type="checkbox" value="1" id="',j,'" checked="true"><label class="checkbox" for="',j,'">',i,"</label></div>"),10==f&&g>14&&a.push(EvoExport.html_more2(evoLangXpt.AllFields))}g>14&&a.push("</div>"),a.push('</fieldset></div><div class="evol-xpt-para">');var k=d+"evol-xpt-format",l=evoLangXpt.ExportFormats.split("-");return a.push('<label for="',k,'">',evoLangXpt.ExportFormat,"</label>",b.input.select(k,"evol-xpt-format",!1,[{id:"CSV",text:l[0]},{id:"TAB",text:l[3]},{id:"HTML",text:l[1]},{id:"JSON",text:l[5]},{id:"SQL",text:l[2]},{id:"XML",text:l[4]}])),a.push('<div class="evol-xpt-opts">'),k=d+"FLH",a.push('<div class="evol-FLH clearfix">'),a.push(b.input.checkbox(k,!0),b.fieldLabelSpan(k,evoLangXpt.ExportFirstLine)),a.push('</div><div id="',d,'CSV">'),a.push('<div data-id="csv2" class="evol-w120">',b.fieldLabel("FLS_evol",evoLangXpt.ExportSeparator),b.input.text(d+"FLS_evol",",",0),"</div>"),a.push("</div>"),_.each(["XML","HTML","SQL","JSON"],function(b){a.push('<div id="',d,b,'" style="display:none;"></div>')}),a.push("</div>"),a.push('<label>Export Preview</label><div class="evol-xpt-preview"></div>'),a.push("</div>"),a.push('<div class="evol-buttons form-actions">'),a.push('<input class="btn btn-primary" id="XP" type="submit" value="',evoLangXpt.DownloadEntity.replace("{0}",this.options.uiModel.entities),'"/>'),a.push("</div></div>"),a.join("")},setModel:function(a){this.options.model=a},showFormatOpts:function(a){var b="#"+(this.options.prefix||"");switch(this.$el,a){case"TAB":a="CSV",this.$('[data-id="csv2"]').hide();break;case"CSV":this.$('[data-id="csv2"]').show();break;case"HTML":case"XML":case"SQL":case"JSON":var c=this.$(b+a);""===c.html()&&c.html(EvoExport["form"+a](this.options.uiModel.entity))}var d=this.$(b+a).show().siblings().hide(),e=d.filter(".evol-FLH");"TAB"===a||"CSV"===a?e.show():e.hide(),EvoExport.cFormat=a},getFields:function(){var a=this.options;return this.fields||(this.fields=Evol.Dico.getFields(a.uiModel,a.fnFilter,a.mode)),this.fields},_preview:function(a){var b=[];if(this.model&&this.model.collection){var c=this.model.collection.models,d=this.getFields(),e=this.$(".evol-xpt-flds > fieldset input:checked"),f={},g="#"+this.options.prefix,h=this.$(g+"FLH").prop("checked");switch(b.push('<textarea class="Field evol-xpt-val form-control">'),_.each(e,function(a){f[a.id.substring(3)]=""}),d=_.filter(d,function(a){return a.id&&_.has(f,a.id)?!0:void 0}),a){case"CSV":case"TAB":case"TXT":var i=d.length-1,j=Evol.UI.trim(this.$(g+"FLS_evol").val());"TAB"==a&&(j="&#09;"),h&&(_.each(d,function(a,c){b.push(a.label),i>c&&b.push(j)}),b.push("\n")),_.each(c,function(a){_.each(d,function(c,d){var e=a.get(c.id);e&&b.push(e),i>d&&b.push(j)}),b.push("\n")}),b.push("\n");break;case"HTML":b.push("<table>\n"),h&&(b.push("<tr>\n"),_.each(d,function(a){b.push("<th>",a.id,"</th>")}),b.push("</tr>\n")),_.each(c,function(a){b.push("<tr>"),_.each(d,function(c){var d=a.get(c.id);d?b.push("<td>",d,"</td>"):b.push("<td></td>")}),b.push("</tr>\n")}),b.push("</table>");break;case"JSON":b.push(JSON.stringify(this.model.toJSON(),null,2));break;case"SQL":var k=d.length-1,l=this.$("#evoxpTRS1").prop("checked"),m=this.$("#evoxpTRS2").prop("checked"),n=this.$("#evoTable").val().replace(/ /g,"_"),o=["INSERT INTO ",n," ("];""===n&&(n=this.options.uiModel.entity.replace(/ /g,"_")),_.each(d,function(a,b){o.push(a.id),k>b&&o.push(", ")}),o.push(")\n VALUES ("),o=o.join(""),l&&b.push("BEGIN TRANSACTION\n"),m&&b.push("SET IDENTITY_INSERT ",n," ON;\n");for(var p=0,q=c.length;q>p;p++){b.push(o);for(var r=c[p],s=0,t=d.length;t>s;s++){var u=r.get(d[s].id);b.push('"',u,'"'),k>s&&b.push(", ")}b.push(");\n")}m&&b.push("SET IDENTITY_INSERT ",n," OFF;\n"),l&&b.push("COMMIT TRANSACTION\n");break;case"XML":var v=this.$("#evoRoot").val()||this.options.uiModel.entity.replace(/ /g,"_");b.push("<xml>\n"),_.each(c,function(a){b.push("<",v," "),_.each(d,function(c){b.push(c.id,'="',a.get(c.id),'" ')}),b.push("></",v,">\n")}),b.push("</xml>")}b.push("</textarea>")}else b.push(Evol.UI.HTMLMsg(Evol.i18n.nodata,"","info"));this.$(".evol-xpt-preview").html(b.join(""))},val:function(a){return"undefined"==typeof a?this._getValue():(this._setValue(a),this)},_ValFields:function(){for(var a=[],b=this.$(".evol-xpt-flds input:checked").not("#showID"),c=0,d=b.length;d>c;c++){var e=$(b[c]);a.push(e.attr("id"))}return a},_getValue:function(){var a={format:this._bFormat.val(),fields:this._ValFields(),options:{}},b=this.$(".evol-xpt-para input"),c=b.eq(0),d="undefined"!==c.attr("checked");return a.options[c.attr("id")]=d,a},click_format:function(a){var b=$(a.target).val();"XML"===b&&(this.$("#XML").html(EvoExport.formXML(this.options.uiModel.entity)).show().siblings().not(".evol-FLH").hide(),EvoExport.cFormat="XML"),this.showFormatOpts(b),this._preview(b),this.$el.trigger("change.export","format",b)},click_preview:function(){var a=this.$(".evol-xpt-format").val();this._preview(a)},click_toggle_sel:function(a){$(a.currentTarget).hide().next().slideDown()},click_submit:function(){this.$el.trigger("submit.export")}});var EvoExport={cFormat:"CSV",html_more2:function(a){return['<a href="javascript:void(0)" class="evol-xpt-more">',a,'</a><div style="display:none;">'].join("")},formHTML:function(){return""},formXML:function(a){return[EvoExport.html_more2("options"),EvoExport.formEntityName("evoRoot",evoLangXpt.xpXMLroot,a),Evol.UI.fieldLabel("evoxpC2X",evoLangXpt.xpColMap),"</div>"].join("")},formJSON:function(){return""},formSQL:function(a){return[EvoExport.html_more2("options"),EvoExport.formEntityName("evoTable",evoLangXpt.xpSQLTable,a),"<div>",Evol.UI.input.checkbox("evoxpTRS2","0"),Evol.UI.fieldLabelSpan("evoxpTRS2",evoLangXpt.xpSQLId),"</div>","<div>",Evol.UI.input.checkbox("evoxpTRS1","0"),Evol.UI.fieldLabelSpan("evoxpTRS1",evoLangXpt.xpSQLTrans),"</div>","</div>"].join("")},formEntityName:function(a,b,c){return[Evol.UI.fieldLabel(a,b),Evol.UI.input.text(a,c.replace(" ","_"),30),"<br/>"].join("")}};
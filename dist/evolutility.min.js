/*   evolutility v0.2   */
/*   (c) 2014 Olivier Giulieri   */
/*   https://github.com/evoluteur/evolutility   */
var Evol=Evol||{};Evol.hashLov={},Evol.ViewAction={},Evol.UI={html:{trTableEnd:"</tr></table>",TdTrTableEnd:"</td></tr></table>",clearer:'<div class="clearfix"></div>',emptyOption:'<option value=""></option>',glyphicon:"glyphicon glyphicon-",required:'<span class="evol-required">*</span>',buttonClose:'<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>'},label:function(a,b){return['<label for="',a,'">',b,"</label>"].join("")},fieldLabel:function(a,b){return['<div class="evol-field-label">',this.label(a,b),"</div>"].join("")},fieldLabelSpan:function(a,b){return['<span class="evol-field-label">',this.label(a,b),"</span>"].join("")},input:{text:function(a,b,c,d){var e="evo-field form-control "+(d||""),f=['<input type="text" id="',a,'" value="',b];return b.indexOf('"')>-1&&(b=b.replace(/"/g,'"')),c&&(_.each(["id","min","max","maxlength","placeholder"],function(a){_.isUndefined(c[a])||f.push('" ',a,'="',c[a])}),c.readonly&&f.push('" ',item,'="',item),e&&f.push('" class="',e)),f.push('">'),f.join("")},textInt:function(a,b,c,d){var e=['<input class="evo-field form-control" type="number" id="',a,'" value="',b];return _.isUndefined(c)||e.push('" min="',c),_.isUndefined(d)||e.push('" max="',d),e.push('" maxlength="12">'),e.join("")},textM:function(a,b,c,d){return['<textarea id="',a,'" class="evo-field form-control" rows="',d,'">',b,"</textarea>"].join("")},textMJSON:function(a,b,c){return['<textarea id="',a,'" rows="',c,'" class="evol-json">',_.escape(JSON.stringify(b,null,"	")),"</textarea>"].join("")},myType:function(a,b,c){return['<input type="',a,'" id="',b,'" value="',c,'" class="evo-field form-control" size="15">'].join("")},date:function(a,b){return this.myType("date",a,b)},dateTime:function(a,b){return this.myType("datetime-local",a,b)},time:function(a,b){return this.myType("time",a,b)},typeFlag:function(a){return'<span class="input-group-addon">'+a+"</span>"},color:function(a,b){return['<input type="color" id="',a,'" value="',b,'" size="15">'].join("")},colorBox:function(a,b){return['<div class="evo-color-box" id="',a,'" style="background-color:',b,'" title="',b,'"></div>'].join("")},checkbox:function(a,b){var c=['<input type="checkbox" id="',a];return b&&c.push('" checked="checked'),c.push('" value="1">'),c.join("")},checkbox2:function(a,b,c){var d=['<input type="checkbox" data-id="',a,'" class="',c,'"'];return b&&d.push(' checked="checked"'),d.push(' value="1">'),d.join("")},checkboxLOV:function(a){var b=[];for(var c in a){var d=a[c];b.push('<input type="checkbox" id="',d.id,'" value="',d.id,'"/>','<label for="',d.id,'">',d.text,"</label> ")}return b.join("")},radio:function(a,b,c,d,e){return['<label for="',e,'"><input id="',e,'" name="',a,'" type="radio" value="',b,d?'" checked="checked':"",'">',c,"</label>&nbsp;"].join("")},lov:function(a,b,c,d){var e=['<select class="evo-field form-control" id="',a,'"><option value="',b,'" selected>',c,"</option>"];return _.each(d,function(a){e.push(this.option(a.id,a.text))}),e.push("</select>"),e.join("")},img:function(a,b){return['<img id="',a,'" src="',b,'"/>'].join("")},hidden:function(a,b){return['<input type="hidden" name="',a,'" id="',a,'" value="',b,'"/>'].join("")},selectBegin:function(a,b,c){var d=['<select id="',a,'" class="form-control ',b,'">'];return c&&d.push(Evol.UI.html.emptyOption),d.join("")},select:function(a,b,c,d,e){return[this.selectBegin(a,c,d),this.options(e,b),"</select>"].join("")},option:function(a,b){return['<option value="',a,'">',b,"</option>"].join("")},options:function(a,b){var c=Evol.UI.input.option,d=[];return _.each(a,function(a){a.id===b?d.push('<option value="',a.id,'" selected="selected">',a.text,"</option>"):d.push(c(a.id,a.text))}),d.join("")},button:function(a,b,c){return'<button type="button" data-id="'+a+'" class="btn'+(c?" "+c:"")+'">'+b+"</button>"},buttonsPlusMinus:function(){return'<div data-id="bPlus" class="glyphicon glyphicon-plus-sign"></div><div data-id="bMinus" class="glyphicon glyphicon-minus-sign"></div>'}},toggleCheckbox:function(a,b){b?a.prop("checked","checked"):a.prop("checked",!1)},link:function(a,b,c,d){var e=['<a class="evo-field" href="',c];return a&&e.push('" id="',a),d&&e.push('" target="',d),e.push('">',b,"</a>"),e.join("")},linkEmail:function(a,b){return b?(b=_.escape(b),this.link(a,b,"mailto:"+b)):""},icon:function(a,b){return['<i class="',b?b+" ":"",Evol.UI.html.glyphicon,a,'"></i>'].join("")},iconCustomize:function(a,b){return Evol.UI.iconId(a,b,"wrench")},iconId:function(a,b,c){return['<i class="',Evol.UI.html.glyphicon,c,'" data-id="',a,'" data-type="',b,'"></i>'].join("")},menu:{hBegin:function(a,b,c){return["<",b,' class="dropdown" data-id="',a,'">','<a href="#" class="dropdown-toggle" data-toggle="dropdown">',Evol.UI.icon(c),' <b class="caret"></b></a>','<ul class="dropdown-menu evo-dropdown-icons">'].join("")},hEnd:function(a){return"</ul></"+a+">"},hItem:function(a,b,c,d,e){var f=[];return f.push('<li data-id="',a,'"'),d&&f.push(' data-cardi="'+d,'"'),"label"!==e&&f.push(' data-toggle="tooltip" data-placement="bottom" title="" data-original-title="',b,'"'),f.push('><a href="javascript:void(0);" data-id="',a,'">',Evol.UI.icon(c)),"tooltip"!==e&&f.push("&nbsp;",b),f.push("</a></li>"),f.join("")}},HTMLPanelBegin:function(a,b,c){return['<div data-pid="',a,'" class="panel ',c,'">','<div class="panel-heading">',Evol.UI.icon("chevron-up","evol-title-toggle"),'<h3 class="panel-title">',b,"</h3></div>"].join("")},HTMLPanelEnd:function(){return"</div>"},HTMLEmptyPanel:function(a,b,c){return'<div class="'+b+" panel panel-"+c+'" data-id="'+a+'"></div>'},HTMLMsg:function(a,b,c){return['<div data-id="msg" class="evo-msg alert alert-',c||"info",' alert-dismissable">',this.html.buttonClose,"<strong>",a,"</strong><br/><div>",b,"</div></div>"].join("")},formatDate:function(a){if(!_.isUndefined(a)&&null!==a){var b=a.split("-");if(b.length>1)return b[1]+"/"+b[2]+"/"+b[0]}return""},formatTime:function(a){if(!_.isUndefined(a)&&null!==a&&""!==a){var b=a.split(":"),c=parseInt(b[0],10);return c>12?c-12+":"+b[1]+" PM":c+":"+b[1]+" AM"}return""},formatDateTime:function(a){if(!_.isUndefined(a)&&null!==a&&""!==a){var b=a.split("T");return b.length>1?this.formatDate(b[0])+", "+this.formatTime(b[1]):this.formatDate(b[0])}return""},insertCollection:function(a,b){0===a.length&&_.each(b,function(b){a.create(b)})},capitalize:function(a){return a&&a.length>0?a.substring(0,1).toUpperCase()+a.substring(1):""},trim:function(a){return _.isString(a)&&""!==a?a.replace(/^\s+|\s+$/g,""):""},setVisible:function(a,b){b?a.show():a.hide()}},Evol.UI.Charts={URL:"http://chart.apis.google.com/chart",_HTML:function(a,b,c){return['<div class="evol-chart-holder panel ',c,'"><label class="evol-chart-title">',a,'</label><img src="',b,'"><br></div>'].join("")},Pie:function(a,b,c,d,e){var f=e?e:"390x200",g=[this.URL,"?chd=t:",b.join(","),"&amp;chl=",c.join("|"),"&amp;cht=p&amp;chds=0,20&amp;chs=",f].join("");return this._HTML(a,g,d||"panel-default")},Bars:function(a,b,c,d,e){var f=e?e:"360x200",g=_.max(b),h=[this.URL,"?chbh=a&amp;chs=",f,"&cht=bvg&chco=3a87ad,d9edf7&chds=0,",g,"&amp;chd=t:",b.join("|"),"&amp;chp=0.05&amp;chts=676767,10.5&amp;chdl=",c.join("|")].join("");return this._HTML(a,h,d)}};var Evol=Evol||{};Evol.i18n={LOCALE:"EN",getLabel:function(a,b,c){var d;if(a.indexOf(".")>-1){var e=a.split(".");d=this[e[0]][e[1]]}else d=this[a];return b&&(d=d.replace("{0}",b),c&&(d=d.replace("{1}",c))),d},View:"View",bEdit:"Edit",bNew:"New",NewEntity:"New {0}",NewUpload:"New Upload",Selections:"Selections",Selection:"Selection",bExport:"Export",bCharts:"Charts",SearchRes:"Search Result",bDelete:"Delete",bAll:"All",bFilter:"Filter",bSave:"Save",bSaveAdd:"Save and Add Another",Cancel:"Cancel",saved:"Record saved.",unSavedChanges:"You have unsaved changes.\nClick OK to navigate without saving your changes.",DeleteEntity:'Delete {0} "{1}"?',DeleteEntities:"Delete {0} {1}?",NoChange:"No Change",NoX:"No {0}",Back2SearchResults:"Back to search results",yes:"Yes",no:"No",none:"None",na:"N/A",nodata:"No data available.",nopix:"No picture.",nochart:"No charts available.",badchart:"The data structure doesn't allow for auto-generated charts.",range:"{0} - {1} of {2} {3}",selected:"{0} selected",sgn_money:"$",sgn_email:"@",status:{added:'New {0} "{1}" added.',updated:'{0} "{1}" updated.',deleted:'{0} "{1}" removed.'},validation:{incomplete:"Incomplete information",intro:"You are not finished yet:",empty:'"{0}" must have a value.',email:'"{0}" must be a valid email like "abc@company.com".',integer:'"{0}" must only use numbers.',decimal:'"{0}" must be a valid decimal numbers.',money:'"{0}" must be a valid number.',date:'"{0}" must be a valid date, format must be "MM/DD/YYYY" like "12/24/2014".',datetime:'"{0}" must be a valid date/time, format must be "MM/DD/YYYY hh:mm AM/PM" like "12/24/2014 10:30 AM".',time:'"{0}" must be a valid date/time, format must be "hh:mm AM/PM" like "10:30 AM".',max:'"{0}" must be smaller or equal to {1}.',min:'"{0}" must be greater or equal to {1}.',maxlength:'"{0}" must be {1} characters long maximum.',minlength:'"{0}" must be at least {1} characters long.',minmaxlength:'"{0}" must be between {1} and {2} characters long.',regex:'The value "{0}" is not of the expected format.'},charts:{aByB:"{0} by {1}",aB:"{0}: {1}"},"export":{ExportEntity:"Export {0}",ExportEntities:"Export {0}",preview:"Export preview",header:"Header",separator:"Separator",firstLine:"First line for field names",format:"Export format",xpFields:"Fields to include in the export",IDkey:"ID",allFields:"Show all fields",formatCSV:"Comma separated (CSV, TXT, XLS...)",formatHTML:"HTML",formatSQL:"SQL Insert Statements (SQL)",formatTAB:"Tab separated values (TXT)",formatXML:"XML",formatJSON:"Javascript Object Notation (JSON)",XMLroot:"Element name",SQL:"SQL Options",SQLTable:"Table name",SQLTrans:"Inside transaction",SQLId:"Enable identity insert",DownloadEntity:"Download {0}"},filters:{sEqual:"equals",sNotEqual:"not equal",sStart:"starts with",sContain:"contains",sFinish:"finishes with",sInList:"any of",sIsNull:"is empty",sIsNotNull:"is not empty",sBefore:"before",sAfter:"after",sNumEqual:"&#61;",sNumNotEqual:"!&#61;",sGreater:"&#62;",sSmaller:"&#60;",sOn:"on",sNotOn:"not on",sAt:"at",sNotAt:"not at",sBetween:"between",opAnd:"and",yes:"Yes",no:"No",bNewFilter:"New filter",bAddFilter:"Add filter",bUpdateFilter:"Update filter",bSubmit:"Submit",bCancel:"Cancel"},prev:"Previous",next:"Next",finish:"Finish !"};var Evol=Evol||{};Evol.Dico={fieldTypes:{text:"text",textml:"textmultiline",bool:"boolean",dec:"decimal","int":"integer",date:"date",time:"time",datetime:"datetime",pix:"image",doc:"document",lov:"lov",list:"list",money:"money",email:"email",color:"color",hidden:"hidden",url:"url"},getFields:function(a,b){function c(a){a&&a.elements&&a.elements.length>0?_.each(a.elements,function(a){"panel-list"!=a.type&&c(a)}):d.push(a)}var d=[];return c(a),_.isFunction(b)&&(d=_.filter(d,b)),d},getFieldTypedValue:function(a,b){var c=Evol.Dico.fieldTypes;switch(a.type){case c.bool:return b.prop("checked");case c.int:return parseInt(b.val(),10);case c.dec:case c.money:return parseFloat(b.val());case c.list:return b.select2("val");default:return b.val()}},getSubCollecs:function(a){function b(a){"panel-list"===a.type?c[a.attr]=a:"panel"!==a.type&&a.elements&&a.elements.length>0?_.each(a.elements,function(a){"panel-list"===a.type?c[a.attr]=a:"panel"!==a.type&&b(a)}):c[a.attr]=a}var c={};return b(a),c},lovText:function(a,b,c,d){if(a.list&&a.list.length>0&&c){a.id in c||(c[a.id]={});var e=c[a.id];if(b in e)return e[b];var f=_.find(a.list,function(a){return a.id==b});if(f){var g=f.text;return""==f.icon||_.isUndefined(f.icon)||(g='<img src="'+d+f.icon+'"> '+g),e[b]=g,g}}return""},lovTextNoPix:function(a,b){var c=_.find(a.list,function(a){return a.id==b});return c?c.text:""},isTypeDateOrTime:function(a){var b=this.fieldTypes;return a==b.datetime||b.date||a==b.time},filterModels:function(a,b){return b.length?a.filter(function(a){var c,d=!0;for(c=0,iMax=b.length;iMax>c&&d;c++){var e=b[c],f=e.value.value,g=a.get(e.field.value);switch(_.isUndefined(g)&&(g=""),e.operator.value){case"eq":d=f==g;break;case"ne":d=f!=g;break;case"gt":d=g>f;break;case"lt":d=f>g;break;case"bw":var h=e.value.value2;d=!(f>g||g>h);break;case"sw":d=0===g.toLocaleLowerCase().indexOf(f);break;case"ct":d=g.toLocaleLowerCase().indexOf(f)>-1;break;case"fw":var i=g.length,j=f.length;d=i>j?!1:g.toLocaleLowerCase().substring(j-i)===f;break;case"null":d=""==g||_.isUndefined(g);break;case"nn":d=!(_.isUndefined(g)||""==g);break;case"in":d=_.contains(f.split(","),g);break;case 1:d=g;break;case 0:d=!g}}return d}):a},HTMLField4Many:function(a,b,c,d){var e=Evol.Dico.fieldTypes;switch(a.type){case e.bool:if("true"===b||"1"==b)return Evol.UI.icon("ok");break;case e.lov:if(""!==b)return Evol.Dico.lovText(a,b,c,d);break;case e.list:if(_.isString(b)&&(b=b.split(",")),b&&b.length){var f=[];return _.each(b,function(b){f.push(Evol.Dico.lovText(a,b,c,d))}),f.join(", ")}return b;case e.date:return Evol.UI.formatDate(b);case e.time:return Evol.UI.formatTime(b);case e.datetime:return Evol.UI.formatDateTime(b);case e.pix:if(b&&b.length)return Evol.UI.input.img(a.id,d+b);break;case e.money:var g=parseFloat(b);if(!isNaN(g))return"$"+g.toFixed(2);break;case e.email:return Evol.UI.linkEmail(a.id,b);case e.url:return Evol.UI.link(a.id,b,b,a.id);default:return b}return""},HTMLField4One:function(a,b,c,d,e,f){var g=[],h=Evol.UI,i=Evol.Dico.fieldTypes;if("mini"===d){var j=a.width;a.width=100,g.push('<div class="evol-mini-label">',this.HTMLFieldLabel(a,d),'</div><div class="evol-mini-content">')}else f||g.push(this.HTMLFieldLabel(a,d||"edit"));if(a.readonly||"view"===d)g.push('<div class="disabled evo-rdonly" id="',b),a.type===i.textml&&a.height>1&&g.push('" style="height:',a.height,"em;overflow-y: auto;"),g.push('">'),a.type==i.color?g.push('<div id="',b,'" class="form-control">',c,"</div>"):g.push(this.HTMLField4Many(a,c,{},e)),g.push("&nbsp;</div>");else switch(a.type){case i.text:g.push(h.input.text(b,c,a,null));break;case i.int:case i.dec:g.push(h.input.textInt(b,c,a.max,a.min));break;case i.money:g.push('<div class="input-group">',h.input.typeFlag("$"),h.input.textInt(b,c),"</div>");break;case i.bool:g.push(h.input.checkbox(b,c));break;case i.textml:case i.html:if(null===a.height)a.height=5;else{var k=parseInt(a.height,10);1>k&&(a.height=5)}g.push(h.input.textM(b,c,a.maxlength,a.height));break;case i.date:g.push(h.input.date(b,c));break;case i.datetime:g.push(h.input.dateTime(b,c));break;case i.time:g.push(h.input.time(b,c));break;case i.lov:g.push(h.input.select(b,c,"",!0,a.list));break;case i.list:g.push('<div id="',b,'" class="w-100 form-control"></div>');break;case i.email:"view"===d?g.push(h.linkEmail(b,c)):g.push('<div class="input-group">',h.input.typeFlag(Evol.i18n.sgn_email),h.input.text(b,c,a),"</div>");break;case i.url:g.push("view"===d?h.link(b,c,encodeURI(c),b):h.input.text(b,c,a));break;case i.pix:""!==c?g.push('<img src="',e+c,'" class="img-thumbnail">'):g.push('<p class="">',Evol.i18n.nopix,"</p>"),g.push(h.input.text(b,c,a,null));break;case i.color:g.push(h.input.color(b,c));break;case i.hidden:g.push(h.input.hidden(b,c))}return"mini"===d&&(g.push("</div>"),a.width=j),g.join("")},HTMLFieldLabel:function(a,b){var c=[];return c.push('<div class="evol-field-label" id="',a.id,'-lbl"><label class="control-label" for="',a.id,'">',a.label),"view"!=b&&a.required&&c.push(Evol.UI.html.required),a.help&&""!==a.help&&c.push(Evol.UI.icon("question-sign","")),c.push("</label></div>"),c.join("")},HTMLFieldLink:function(a,b,c,d,e,f){var g=[];return e||(f?g.push('<a href="',f,'" id="',a,'" class="evol-nav-id">'):g.push('<a href="javascript:void(0);" id="',a,'" class="evol-nav-id">')),d&&g.push('<img class="evol-many-icon" src="',d,'">'),g.push(c),e||g.push("</a>"),g.join("")},bbComparator:function(a){return function(b){return b.get(a)}},bbComparatorText:function(a){return function(b,c){return(b.get(a)||"").localeCompare(c.get(a)||"")}},getRoute:function(){var a=window.location.href,b=a.indexOf("#");return b>-1?a.substr(b+1):""},setRoute:function(a,b,c,d,e,f){if(_.isUndefined(this._$headTitle)&&(this._$headTitle=$("#headTitle")),this._$headTitle.html(b),!_.isUndefined(a)){var g=c+"/"+d;e&&(g+="/"+e),g!==this.getRoute()&&a.navigate("#"+g,{trigger:f})}}};var Evol=Evol||{};Evol.ViewMany=Backbone.View.extend({viewType:"many",editable:!1,cardinality:"n",options:{style:"panel-info",pageSize:20,pageIndex:0,autoUpdate:!1,selectable:!1,links:!0,iconsPath:"pix/"},events:{"click .evol-sort-icons>i":"click_sort","click .pagination>li":"click_pagination","change .list-sel":"click_selection",'change [data-id="cbxAll"]':"click_checkall"},initialize:function(a){var b=localStorage.getItem(a.uiModel.id+"-sort"),c=this;if(this.options=_.extend({},this.options,a),this.uiModel=this.options.uiModel,this.pageIndex=this.options.pageIndex,this.mode=this.options.mode||"",this._filter=[],this.options.autoUpdate&&this.collection&&this.collection.on("change",function(){c.render()}),this.options.router?this.router=this.options.router:this.$el.on("click",".evol-nav-id",function(a){c.click_navigate(a)}),this._custOn=!1,null!==b){var d=b.split("-"),e=this.getField(d[0]);d.length>1&&!_.isUndefined(e)&&this.sortList(e,"down"===d[1],!0)}},render:function(){var a=this.collection.models;return this.collection.length?(a=Evol.Dico.filterModels(a,this._filter),this._render(a)):this.$el.html(Evol.UI.HTMLMsg(this.options.noDataString||Evol.i18n.nodata,"","info")),this.setTitle()},_HTMLbody:function(a,b,c,d,e,f){var g,h,i=this.collection.models,j=0,k=_.min([i.length,j+c]),l=d?(this.options.iconsPath||"")+d:null,m=this.getRoute();if(e>0&&(j=e*c,k=_.min([i.length,j+c])),k>0)for(h=j;k>h;h++)g=i[h],this.HTMLItem(a,b,g,l,f,m)},_render:function(){alert("_render must be overwritten")},_HTMLCheckbox:function(a){return Evol.UI.input.checkbox2(a,!1,"list-sel")},customize:function(){var a=this.$("th>span");return this._custOn?a.find("i").remove():a.append(Evol.UI.iconCustomize("id","field")),this._custOn=!this._custOn,this},setCollection:function(a){return this.collection=a,this.render()},getCollection:function(){return this.collection},setFilter:function(a){return this._filter=a,this},getFilter:function(){return this._filter},setTitle:function(){return $(this.options.titleSelector).html(this.getTitle()),this},getTitle:function(){return Evol.UI.capitalize(this.uiModel.entities)+" "+this.viewName},getFields:function(){if(!this._fields){this._fields=Evol.Dico.getFields(this.uiModel,function(a){return a.viewmany}),this._fieldHash={};var a=this;_.each(this._fields,function(b){a._fieldHash[b.id]=b})}return this._fields},getField:function(a){return this._fieldHash||this.getFields(),this._fieldHash[a]},setPage:function(a){var b=[],c=this.getFields(),d=this.options,e=d.pageSize,f=this.collection.length,g=this.pageSummary(a,e,f);return this._HTMLbody(b,c,e,this.uiModel.icon,a,d.selectable),this._$body().html(b.join("")),b=[],this._HTMLpaginationBody(b,a,e,f),this.$(".evo-pagination").html(b.join("")),this.$(".evo-many-summary").html(g),this.pageIndex=a,this.$el.trigger("status",g),this},getPage:function(){return this.pageIndex},_HTMLField:function(a,b){return Evol.Dico.HTMLField4Many(a,b,Evol.hashLov,this.options.iconsPath||"")},_$Selection:function(){return this.$(".list-sel:checked").not('[data-id="cbxAll"]')},getSelection:function(){return this.options.selectable?_.map(this._$Selection().toArray(),function(a){return $(a).data("id")}):[]},pageSummary:function(a,b,c){if(0===c)return"";if(1===c)return c+" "+this.uiModel.entity;var d,e=(a||0)*b+1;return d=_.min(1>a?[b,c]:[e+b-1,c]),Evol.i18n.range.replace("{0}",e).replace("{1}",d).replace("{2}",c).replace("{3}",this.uiModel.entities)},_HTMLpagination:function(a,b,c,d){d>c&&(a.push('<ul class="evo-pagination pagination pagination-sm">'),this._HTMLpaginationBody(a,b,c,d),a.push("</ul>"))},_HTMLpaginationBody:function(a,b,c,d){if(d>c){var e,f,g=Math.ceil(d/c),h=b+1;6>g?(e=1,f=g):(e=b+1,f=e+5),a.push('<li data-id="prev"',1===h?' class="disabled"':"",'><a href="#">&laquo;</a></li>');for(var i=e;f+1>i;i++)a.push("<li",h===i?' class="active"':"",' data-id="',i,'"><a href="#">',i,"</a></li>");a.push('<li data-id="next"',d>h*c?"":' class="disabled"','><a href="#">&raquo;</a></li>')}},sortList:function(a,b,c){var d=this.collection,e=Evol.Dico.fieldTypes;if(!_.isUndefined(d)){d.comparator=a.type==e.text||a.type==e.textml||a.type==e.email?Evol.Dico.bbComparatorText(a.id):Evol.Dico.bbComparator(a.id),d.sort(),b&&d.models.reverse(),this.setPage(0);var f=b?"down":"up";c||localStorage.setItem(this.uiModel.id+"-sort",a.id+"-"+f),this.$el.trigger("list.sort",{id:a.id,direction:f})}},getRoute:function(){var a=this.router,b=null;return a&&(b="#"+this.uiModel.id+"/view/"),b},click_navigate:function(a){var b=$(a.currentTarget).closest("[data-mid]").data("mid");a.type="list.navigate",this.$el.trigger(a,{id:b})},click_sort:function(a){var b=$(a.currentTarget),c=b.parent().data("fid"),d=this.getField(c),e=b.attr("class").indexOf("-down")>0;this.sortList(d,e),b.addClass("evol-last-sort")},click_pagination:function(a){this.$el.trigger("list.paginate",{id:$(a.currentTarget).closest("li").data("id")})},click_customize:function(a){var b=$(a.currentTarget),c=b.data("id"),d=b.data("type");Evol.Dico.showDesigner(c,d,b),this.$el.trigger(d+".customize",{id:c,type:d})},click_selection:function(){this.$el.trigger("selection")},click_checkall:function(){var a=this.$('[data-id="cbxAll"]').prop("checked");this.$(".list-sel").prop("checked",a),this.$el.trigger("selection")}}),Evol.ViewMany.Badges=Evol.ViewMany.extend({viewName:"badges",_render:function(a){var b=[],c=this.options,d=c.pageSize||50,e=this.pageSummary(0,d,a.length);return b.push('<div class="evol-many-badges"><div class="evol-badges-body">'),this._HTMLbody(b,this.getFields(),d,this.uiModel.icon,0,c.selectable),b.push("</div>",Evol.UI.html.clearer),this._HTMLpagination(b,0,d,a.length),b.push('<div class="evo-many-summary">',e,"</div>"),b.push("</div>"),this.$el.html(b.join("")),this},_$body:function(){return this.$(".evol-badges-body")},HTMLItem:function(a,b,c,d,e,f){var g=this,h=this.options,i=h.links!==!1;a.push('<div class="panel ',this.options.style,'">'),_.each(b,function(b,h){var j=g._HTMLField(b,c.escape(b.id));0===h?a.push('<div data-mid="',c.id,'"><h4>',e?g._HTMLCheckbox(c.id):"",Evol.Dico.HTMLFieldLink("fg-"+b.id,b,j,d,!i,f?f+c.id:null),"</h4></div>"):a.push("<div><label>",b.label,":</label> ",j,"</div>")}),a.push("</div>")}}),Evol.ViewMany.Charts=Evol.ViewMany.extend({viewName:"charts",options:{style:"panel-info",autoUpdate:!1},events:{"click .evol-field-label .glyphicon-wrench":"click_customize"},render:function(){var a=[];return this.collection&&this.collection.length>0?(a.push('<div class="evol-many-',this.viewName,'">'),this._HTMLcharts(a,this.options.style,this.options.sizes),a.push("</div>")):a.push(Evol.UI.HTMLMsg(Evol.i18n.nodata,"","info")),this.$el.html(a.join("")),this.setTitle()},_HTMLcharts:function(a,b,c){var d=Evol.UI,e=Evol.Dico,f=Evol.i18n,g=e.fieldTypes,h=this.options.uiModel,i=this.collection.models,j=this.options.iconsPath||"",k=e.getFields(h,function(a){return a.viewcharts||a.type==g.lov||a.type==g.bool||a.type==g.int});k&&k.length?_.each(k,function(k){var l,m=_.countBy(i,function(a){return a.get(k.id)}),n=m,o=[],p=[];for(var q in n){var r=n[q];l=_.isUndefined(q)?f.na:""===q||"null"===q?f.none:k.type===g.lov||k.type===g.list?k.list&&k.list.length&&k.list[0].icon?e.lovTextNoPix(k,q):e.lovText(k,q,Evol.hashLov,j):k.type===g.bool?"true"===q?f.yes:f.no:q,o.push(r),p.push(l+" ("+r+")")}var s=d.capitalize(h.entities);a.push(k.type===g.lov?d.Charts.Pie(f.getLabel("charts.aByB",s,k.labelcharts||k.label),o,p,b,c):d.Charts.Bars(f.getLabel("charts.aB",s,k.labelcharts||k.label),o,p,b,c))}):a.push(d.HTMLMsg(f.nochart,f.badchart)),a.push(d.html.clearer)},setPage:function(){}}),Evol.ViewMany.List=Evol.ViewMany.extend({viewName:"list",_render:function(a){var b=[],c=this,d=this.options,e=d.selectable,f=this.getFields(),g=d.pageSize||50,h=this.options.links!==!1;b.push('<div class="evol-many-list">','<table class="table table-bordered',h?" table-hover":"",'"><thead><tr>'),e&&b.push("<th>",this._HTMLCheckbox("cbxAll"),"</th>"),_.each(f,function(a){c._HTMLlistHeader(b,a)}),b.push("</tr></thead><tbody>"),this._HTMLbody(b,f,g,d.uiModel.icon,0,e),b.push("</tbody></table>"),this._HTMLpagination(b,0,g,a.length),b.push('<div class="evo-many-summary">',this.pageSummary(d.pageIndex,g,a.length),"</div>"),b.push("</div>"),this.$el.html(b.join(""))},_$body:function(){return this.$(".table > tbody")},HTMLItem:function(a,b,c,d,e,f){var g,h=this,i=this.options,j=i.links!==!1;a.push('<tr data-mid="',c.id,'">'),e&&a.push('<td class="list-td-sel">',this._HTMLCheckbox(c.id),"</td>"),_.each(b,function(b,e){g=b.type===Evol.Dico.fieldTypes.color?Evol.UI.input.colorBox(b.id,c.escape(b.id)):h._HTMLField(b,c.escape(b.id)),0===e&&(g=Evol.Dico.HTMLFieldLink("fv-"+b.id,b,g,d,!j,f?f+c.id:null)),a.push("<td>",g,"</td>")}),a.push("</tr>")},_HTMLlistHeader:function(a,b){a.push('<th><span id="',b.id,'-lbl">',b.labellist||b.labelmany||b.label,'<span class="evol-sort-icons" data-fid="',b.id,'">',Evol.UI.icon("chevron-up"),Evol.UI.icon("chevron-down"),"</span></span></th>")}});var Evol=Evol||{};Evol.ViewOne=Backbone.View.extend({viewType:"one",cardinality:"1",editable:!0,events:{"click .evol-buttons>button":"click_button","click .evol-title-toggle":"click_toggle","click ul.evol-tabs>li>a":"click_tab","click label>.glyphicon-question-sign":"click_help","click .evol-field-label .glyphicon-wrench":"click_customize",'click [data-id="bPlus"],[data-id="bMinus"]':"click_detailsAddDel"},options:{button_addAnother:!1,style:"panel-info",titleSelector:"#title",iconsPath:"pix/"},initialize:function(a){this.options=_.extend({},this.options,a),this.mode=a.mode||this.options.mode||this.viewName,this.uiModel=this.options.uiModel,this._tabId=!1,this._uTitle=!_.isUndefined(this.options.titleSelector)&&""!==this.options.titleSelector,this._subCollecs=this._subCollecsOK=!1},render:function(){var a=[];return this._render(a,this.mode),this.$el.html(a.join("")),this.custOn=!1,this.postRender(),this.setData(this.model,!0),this},postRender:function(){},getFields:function(){if(!this._fields){this._fields=Evol.Dico.getFields(this.uiModel,this.getFieldsCondition),this._fieldHash={};var a=this;_.each(this._fields,function(b){a._fieldHash[b.id]=b})}return this._fields},getSubCollecs:function(){return this._subCollecsOK||(this._subCollecs=Evol.Dico.getSubCollecs(this.uiModel),this._subCollecsOK=!0),this._subCollecs},setModel:function(a){return this.model=a,this.clearMessages().setData(a,!0)},getModel:function(){return this.model},setUIModel:function(a){return this.uiModel=a,this.clearCache().render()},getUIModel:function(){return this.uiModel},getTitle:function(){if(this.model){var a=this.uiModel.leadfield;return _.isFunction(a)?a(this.model):this.model.get(a)}return Evol.UI.capitalize(this.uiModel.entity)},getData:function(a){var b=this,c=this.getFields(),d={},e=this.getSubCollecs();return _.each(c,function(a){d[a.id]=b.getFieldValue(a)}),e&&_.each(e,function(a){var c,e,f=b.$('[data-pid="'+a.id+'"] tbody tr').not('[data-id="nodata"]').toArray(),g=[];_.each(f,function(b){c={},e=$(b).children(),_.each(a.elements,function(a,b){c[a.id]=Evol.Dico.getFieldTypedValue(a,e.eq(b).find("input,select,textarea").eq(0))}),g.push(c)}),d[a.attr||a.id]=g}),a&&_.each(this.getFields(),function(a){a.readonly&&delete d[a.id]}),d},setData:function(a,b){if(_.isUndefined(a)||null===a)this.clear();else{var c,d,e,f=this.getFields(),g=this,h=Evol.Dico.fieldTypes,i="#"+this.prefix+"-",j=this.getSubCollecs(),k=this.options.iconsPath||"";_.each(f,function(f){if(c=g.$(i+f.id),d=b?a.get(f.attribute||f.id):a[f.attribute||f.id],f.readonly)if(f.type===h.pix)e=d?'<img src="'+k+d+'" class="img-thumbnail">':'<p class="">'+Evol.i18n.nopix+"</p>",c.val(d).prev().remove(),c.before(e);else switch(f.type){case h.lov:case h.bool:case h.email:case h.url:c.html(Evol.Dico.HTMLField4Many(f,d,Evol.hashLov,k));break;case h.pix:c.html(d?'<img src="'+k+d+'" class="img-thumbnail">':"<p>"+Evol.i18n.nopix+"</p>");break;case h.textml:c.html(d.replace(/[\r\n]/g,"<br/>"));break;default:c.text(Evol.Dico.HTMLField4Many(f,d,Evol.hashLov,k)||" ")}else switch(f.type){case h.lov:var j=c.children().removeAttr("selected");""!==d&&j.filter("[value="+d+"]").attr("selected",!0);break;case h.bool:d?c.prop("checked","checked"):c.prop("checked",!1);break;case h.pix:e=d?'<img src="'+k+d+'" class="img-thumbnail">':'<p class="">'+Evol.i18n.nopix+"</p>",c.val(d).prev().remove(),c.before(e);break;case h.list:c.select2("val",d);break;default:c.val(d)}}),j&&_.each(j,function(a){var b=[];g._renderPanelListBody(b,a,d,"edit"),g.$('[data-pid="'+a.id+'"] tbody').html(b.join(""))})}return this.setTitle()},setFieldValue:function(a,b){return this.$("#"+this.fieldViewId(a)).val(b),this},getFieldValue:function(a){return Evol.Dico.getFieldTypedValue(a,this.$field(a))},$field:function(a){return this.$("#"+this.fieldViewId(a.id))},clear:function(){var a,b,c=Evol.Dico.fieldTypes,d=this.getFields(),e=this,f="#"+e.prefix+"-",g=this.getSubCollecs();return this.clearMessages(),_.each(d,function(d){switch(a=e.$(f+d.id),b=d.defaultvalue||"",d.type){case c.bool:a.prop("checked",b?"checked":!1);break;case c.list:a.select2("val",null);break;case c.pix:var g='<p class="">'+Evol.i18n.nopix+"</p>";a.val("").prev().remove(),a.before(g);break;default:d.readonly?a.html(b):a.val(b)}}),g&&_.each(g,function(a){e.$('[data-pid="'+a.id+'"] tbody').html(e._TRnodata(a.elements.length,"edit"))}),this},clearCache:function(){return this._fieldHash=null,this._fields=null,this._subCollecsOK=!1,this},getModelFieldValue:function(a,b,c){return this.model&&this.model.has(a)?"new"!==c?this.model.get(a):b||"":""},isDirty:function(){function a(a){return""===a||_.isUndefined(a)||null===a||a===!1}function b(a){return null===a||_.isUndefined(a)||a===[]}if(this.editable){var c,d,e,f=this.getFields(),g=Evol.Dico.fieldTypes,h=this.getData(),i=this.model,j=f.length,k=this.getSubCollecs();for(c=0;j>c;c++){var l=f[c],m=l.attribute||l.id,n=h[m],o=i.get(m);if(d=a(o),e=a(n)||isNaN(n)&&(l.type===g.int||l.type===g.dec||l.type===g.money),_.isArray(o)){if(!_.isEqual(o,n))return!0}else if(!(n==o||e&&d))return!0}if(k){var p=Object.keys(k);for(j=p.length,c=0;j>c;c++){var q=p[c],r=h[q],s=this.model.get(q),t=k[q].elements;if(b(r)&&(r=[]),b(s)&&(s=[]),r.length!==s.length)return!0;for(var u=0;u<r.length;u++)for(var v=r[u],w=s[u],x=0;x<t.length;x++){var y=t[x].id,z=v[y],A=w[y],B=a(z),C=a(A);if(B!==C||z!==A)return!0}}}}return!1},showTab:function(a){var b=this.$(a);return b.length>0&&(b.siblings(".tab-pane").hide(),b.show()),b=this.$('.evol-tabs > li a[href="'+a+'"]').parent(),b.length>0&&(b.siblings("li").removeClass("active"),b.addClass("active")),this._tabId=a,this.$el.trigger("tab.show",{id:a}),this},_renderButtons:function(a,b){a.push(Evol.UI.html.clearer,'<div class="evol-buttons">',Evol.UI.input.button("cancel",Evol.i18n.Cancel,"btn-default"),Evol.UI.input.button("save",Evol.i18n.bSave,"btn-primary")),this.model&&this.model.isNew()&&this.options.button_addAnother&&"json"!==b&&a.push(Evol.UI.input.button("save-add",Evol.i18n.bSaveAdd,"btn-default")),a.push("</div>")},_render:function(a,b){var c=this,d=-1,e=-1,f=this.uiModel.elements,g=f.length;a.push('<div class="evo-one-',b,'">'),_.each(f,function(h,i){"tab"===h.type?(e>0&&(a.push("</div>"),e=-1),0>d&&(a.push(Evol.UI.html.clearer),c.renderTabs(a,f),a.push('<div class="tab-content">')),d++,a.push('<div id="evol-tab-',i,'" class="tab-pane',1===i?' active">':'">'),c.renderTab(a,h,b),d==g-1&&a.push("</div>")):(0>e&&(a.push('<div class="evol-pnls">'),e=1),"panel-list"===h.type?c.renderPanelList(a,h,b):c.renderPanel(a,h,"p-"+(h.id?h.id:i),b))}),e>0&&a.push("</div>"),a.push("</div>"),this._renderButtons(a,b)},renderTabs:function(a,b){var c=!0;
a.push('<ul class="nav nav-tabs evol-tabs">'),_.each(b,function(b,d){"tab"===b.type&&(c?(a.push('<li class="active">'),c=!1):a.push("<li>"),a.push('<a href="#evol-tab-',d,'">',b.label,"</a></li>"))}),a.push("</ul>")},renderTab:function(a,b,c){var d=this;a.push('<div class="evol-pnls">'),_.each(b.elements,function(b,e){"panel-list"===b.type?d.renderPanelList(a,b,c):d.renderPanel(a,b,b.id||"pl-"+e,c)}),a.push(Evol.UI.html.clearer,"</div></div>")},renderPanel:function(a,b,c,d,e){var f=this,g=Evol.Dico.fieldTypes,h=this.options.iconsPath||"";if("wiz"===d){var i=_.isUndefined(e)?!1:!e;a.push('<div data-p-width="100" class="evol-pnl evo-p-wiz" style="width:100%;',i?"display:none;":"",'">')}else a.push('<div data-p-width="',b.width,'" class="evol-pnl'),"mini"===d?a.push(" w-100 ",b.class||"",'">'):a.push(' pull-left" style="width:',b.width,'%">');return a.push(Evol.UI.HTMLPanelBegin(c,b.label,this.options.style),'<fieldset data-pid="',c,'">'),"mini"===d?_.each(b.elements,function(b){b.type==g.hidden?a.push(Evol.UI.input.hidden(f.fieldViewId(b.id),f.getModelFieldValue(b.id,b.defaultvalue,d))):(a.push('<div class="pull-left evol-fld w-100">'),f.renderField(a,b,d,h),a.push("</div>"))}):_.each(b.elements,function(b){"panel-list"==b.type?f.renderPanelList(a,b,d):b.type==g.hidden?a.push(Evol.UI.input.hidden(f.fieldViewId(b.id),f.getModelFieldValue(b.id,b.defaultvalue,d))):(a.push('<div style="width:',parseInt(b.width,10),'%" class="pull-left evol-fld">'),f.renderField(a,b,d,h),a.push("</div>"))}),a.push("</fieldset>",Evol.UI.HTMLPanelEnd(),"</div>"),this},renderPanelList:function(a,b,c){return a.push('<div style="width:',b.width,'%" class="evol-pnl pull-left" data-pid="',b.id,'">',Evol.UI.HTMLPanelBegin(b.id,b.label,this.options.style),'<table class="table" data-mid="',b.attr,'"><thead><tr>'),_.each(b.elements,function(b){a.push("<th>",b.label,"</th>")}),"edit"===c&&a.push("<th></th>"),a.push("</tr></thead><tbody>"),this._renderPanelListBody(a,b,null,c),a.push("</tbody></table>",Evol.UI.HTMLPanelEnd(),"</div>"),this},_renderPanelListBody:function(a,b,c,d){var e=this,f=b.elements,g=this.options.iconsPath||"";if(this.model){var h=this.model.get(b.attr);if(h&&h.length>0){var i='<td class="evo-td-plusminus">'+Evol.UI.input.buttonsPlusMinus()+"</td>";return void _.each(h,function(c,h){a.push('<tr data-idx="',h,'">'),"edit"===d?(e._TDsFieldsEdit(a,b.elements,c),a.push(i)):_.each(f,function(b){a.push("<td>"),a.push(c[b.id]?b.type!==Evol.Dico.fieldTypes.bool?_.escape(Evol.Dico.HTMLField4Many(b,c[b.id],Evol.hashLov,g)):Evol.Dico.HTMLField4Many(b,c[b.id],Evol.hashLov,g):Evol.Dico.HTMLField4Many(b,"",Evol.hashLov,g)),a.push("</td>")}),a.push("</tr>")})}}a.push(this._TRnodata(f.length,d))},_TRnodata:function(a,b){return['<tr data-id="nodata"><td colspan="',"edit"===b?a+1:a,'" class="evol-pl-nodata">',Evol.i18n.nodata,"edit"===b?'<div data-id="bPlus" class="glyphicon glyphicon-plus-sign"></div>':"","</td></tr>"].join("")},_TDsFieldsEdit:function(a,b,c){var d,e=this.options.iconPath||"";_.each(b,function(b){d=c[b.id],_.isUndefined(d)&&(d=""),a.push("<td>",Evol.Dico.HTMLField4One(b,b.id,d,"edit-details",e,!0),"</td>")})},renderField:function(a,b,c,d){var e=this.fieldViewId(b.id),f="";return this.model&&this.model.has(b.id)&&(f="new"!==c?this.model.get(b.id):b.defaultvalue||""),a.push(Evol.Dico.HTMLField4One(b,e,f,c,d)),this},setTitle:function(a){if(this._uTitle){var b=this.options.titleSelector;if(b&&""!==b){var c,d=this.uiModel.leadfield;return c=a?a:_.isUndefined(d)||""===d?Evol.UI.capitalize(this.uiModel.entities):this.getTitle(),$(b).text(c),this._uTitle=!0,this}this._uTitle=!1}return this},validate:function(a){var b=!0,c=a?a:this.getFields();if(this.clearMessages(),_.isArray(c)&&(b=this.checkFields(this.$el,c)),this._subCollecs);return this.$el.trigger("action","validate",{valid:b}),b},valRegEx:{email:/^[\w\.\-]+@[\w\.\-]+\.[\w\.\-]+$/,integer:/^[-+]?\d+$/,decimalEN:/^\d+(\.\d+)?$/,decimalFR:/^\d+(\,\d+)?$/,decimalDA:/^\d+(\,\d+)?$/},checkFields:function(a,b){function c(a,b){var c=Evol.Dico.fieldTypes,e=Evol.i18n.validation;if(""!==b&&!_.isArray(b))switch(a.type){case c.int:case c.email:f.valRegEx[a.type].test(b)||d(a,e[a.type]);break;case c.dec:case c.money:var g=f.valRegEx[c.dec+Evol.i18n.LOCALE]||f.valRegEx[c.dec+"EN"];g.test(b)||d(a,e[a.type]);break;case c.date:case c.datetime:case c.time:""===b||_.isDate(new Date(b))||d(a,e[a.type])}}function d(a,b,c,d){var e=b.replace("{0}",a.label);null!==c&&(e=e.replace("{1}",c)),null!==d&&(e=e.replace("{2}",d)),_.isArray(i)&&i.push(e);var g=f.$field(a).parent(),h=g.find(".text-danger");h.length?h.html(e):g.append('<p class="text-danger">'+e+"</p>"),g.addClass("has-error")}var e,f=this,g=Evol.Dico.fieldTypes,h=Evol.i18n.validation,i=[],j=this.getData(!0);return _.each(b,function(a){if(e=j[a.id],!a.readonly){if(a.required&&(""===e||a.type===g.int&&isNaN(e)||a.type===g.dec&&isNaN(e)||a.type===g.money&&isNaN(e)||a.type===g.lov&&"0"===e||a.type===g.list&&0===e.length||a.type===g.color&&"#000000"===e))d(a,h.empty);else{if((!isNaN(e)||a.type!==g.int&&a.type!==g.dec&&a.type!==g.money)&&c(a,e),null!==a.regex&&!_.isUndefined(a.regex)){var b=new RegExp(a.regex);e.match(b)||d(a,h.regex,a.label)}(a.type===g.int||a.type===g.dec||a.type===g.money)&&""!==e&&(null!==a.max&&parseFloat(e)>a.max&&d(a,h.max,a.max),null!==a.min&&parseFloat(e)<a.min&&d(a,h.min,a.min))}if(_.isString(e)&&e.length>0){var f=!0,i=e.length;i>0&&(a.maxlength&&(f=i<=a.maxlength,f||(a.minlength?d(a,h.minmaxlength,a.minlength,a.maxlength):d(a,h.maxlength,a.maxlength))),f&&a.minlength&&(f=i>=a.minlength,f||(a.maxlength?d(a,h.minmaxlength,a.minlength,a.maxlength):d(a,h.minlength,a.minlength))))}}}),i.length>0?[h.intro,"<ul><li>",i.join("</li><li>"),"</li></ul>"].join(""):""},clearErrors:function(){return this.$(".control-group.error").removeClass("control-group error"),this.$(".has-error").removeClass("has-error"),this.$(".text-danger").remove(),this},fieldViewId:function(a){return this.prefix+"-"+a},customize:function(){var a=".evol-field-label>label",b=".evol-pnl .panel-title";return this.custOn?(this.$(a+">i, "+b+">i").remove(),this.custOn=!1):(_.each(this.$(a),function(a){var b=$(a),c=b.attr("for");b.append(Evol.UI.iconCustomize(c,"field"))}),this.$(b).append(Evol.UI.iconCustomize("id","panel")),this.custOn=!0),this},showHelp:function(a,b,c){var d=this.getFields(),e=_.findWhere(d,{id:a});if(e&&e.help){var f=c.closest(".evol-fld"),g=f.find(".help-block");g.length>0?g.slideUp(200,function(){g.remove()}):(g=$('<span class="help-block">'+_.escape(e.help)+"</span>").hide(),f.append(g),g.slideDown(200))}return this},clearMessages:function(){return this.$el.trigger("message",null),this.clearErrors()},sendMessage:function(a,b,c){return this.$el.trigger("message",{title:a,content:b,style:c})},setTab:function(a){this._tabId=a,this.showTab(a)},getTab:function(){return this._tabId},click_button:function(a){var b=$(a.currentTarget).data("id");a.stopImmediatePropagation(),this.$el.trigger("action",b)},click_toggle:function(a){var b=$(a.currentTarget),c=b.closest(".panel-heading").next(),d=c.data("expState"),e="glyphicon-chevron-up",f="glyphicon-chevron-down";if(a.preventDefault(),a.stopImmediatePropagation(),a.shiftKey){var g="down"===d?f:e;this.$(".evol-title-toggle."+g).trigger("click")}else"down"===d?(b.closest(".panel").css("height",""),c.slideDown(300).data("expState","up"),b.addClass(e).removeClass(f)):(c.slideUp(300,function(){b.closest(".panel").css("height","40px")}).data("expState","down"),b.removeClass(e).addClass(f));this.$el.trigger("panel.toggle")},click_tab:function(a){var b=a.currentTarget.href,c=b.substring(b.indexOf("#"));a.stopImmediatePropagation(),a.preventDefault(),a.shiftKey?this.$(".tab-content > div").show():this.showTab(c),this._tabId=c},click_help:function(a){var b=$(a.currentTarget),c=b.closest("label").attr("for"),d=b.data("type");a.stopImmediatePropagation(),this.showHelp(c,d,b),this.$el.trigger(d+".help",{id:c})},click_customize:function(a){var b=$(a.currentTarget),c=b.data("id"),d=b.data("type");a.stopImmediatePropagation(),Evol.Dico.showDesigner(c,d,b,this),this.$el.trigger(d+".customize",{id:c,type:d})},click_detailsAddDel:function(a){var b=$(a.currentTarget),c=b.data("id"),d=b.closest("tr");if(a.stopImmediatePropagation(),"bPlus"===c){var e=[],f=this.getSubCollecs(),g=d.closest("table").data("mid"),h=f[g]?f[g].elements:null;e.push("<tr>"),this._TDsFieldsEdit(e,h,{}),e.push('<td class="evo-td-plusminus">',Evol.UI.input.buttonsPlusMinus(),"</td></tr>"),$(e.join("")).insertAfter(d),"nodata"===d.data("id")&&d.remove()}else"bMinus"===c&&(0===d.siblings().length&&$(this._TRnodata(d.children().length,"edit")).insertAfter(d),d.remove())}}),Evol.ViewOne.Edit=Evol.ViewOne.extend({viewName:"edit",prefix:"oe",postRender:function(){var a="#"+this.prefix+"-",b=_.filter(this.getFields(),function(a){return"list"===a.type&&!a.readonly});_.each(b,function(b){this.$(a+b.id).select2({data:b.list,multiple:!0})})}}),Evol.ViewOne.JSON=Evol.ViewOne.extend({events:{"click > .evol-buttons > button":"click_button"},viewName:"json",render:function(){var a=[];if(this.model){var b=JSON.stringify(this.model,null,2);a.push(Evol.UI.input.textMJSON("",b,10))}return this._renderButtons(a,"json"),this.$el.html(a.join("")),this.setData(this.model),this.custOn=!1,this},getData:function(){var a=this._getDOMField().val();return $.parseJSON(a)},setData:function(a){return this._getDOMField().val(JSON.stringify(a,null,2)),this.setTitle()},clear:function(){return this._getDOMField().val(""),this},_getDOMField:function(){return this.$el.children("textarea")}}),Evol.ViewOne.Mini=Evol.ViewOne.Edit.extend({events:{"click > .evol-buttons > button":"click_button","click .evol-title-toggle":"click_toggle","click label > .glyphicon-question-sign":"click_help"},viewName:"mini",prefix:"om",getFieldsCondition:function(a){return a.required||a.viewmany||a.viewmini},_render:function(a,b){var c=this.options,d={type:"panel","class":"evol-mini-holder",label:Evol.UI.capitalize(c.uiModel.entity),width:100,elements:this.getFields()};this.renderPanel(a,d,"evol-one-mini",b),this._renderButtons(a,b)}}),Evol.ViewOne.View=Evol.ViewOne.extend({viewName:"view",editable:!1,prefix:"ovw",getData:function(){return{}},setData:function(a){if(!_.isUndefined(a)&&null!==a){var b,c,d=this.getFields(),e=this,f=Evol.Dico.fieldTypes,g="#"+e.prefix+"-",h=this.getSubCollecs(),i=this.options.iconsPath||"";_.each(d,function(d){if(b=e.$(g+d.id),c=a.get(d.attribute||d.id),a)switch(d.type){case f.lov:case f.bool:case f.email:case f.url:case f.html:b.html(Evol.Dico.HTMLField4Many(d,c,Evol.hashLov,i));break;case f.pix:b.html(c?'<img src="'+i+c+'" class="img-thumbnail">':"<p>"+Evol.i18n.nopix+"</p>");break;case f.textml:b.html(c?_.escape(c).replace(/[\r\n]/g,"</br>"):"");break;default:b.text(Evol.Dico.HTMLField4Many(d,c,Evol.hashLov,i)||" ")}}),h&&_.each(h,function(a){var b=[];e._renderPanelListBody(b,a,c,"view"),e.$('[data-pid="'+a.id+'"] tbody').html(b.join(""))})}return this.setTitle()},clear:function(){var a,b=this.getFields(),c=this,d=Evol.Dico.fieldTypes,e="#"+c.prefix+"-",f=this.getSubCollecs();return this.clearMessages(),_.each(b,function(b){switch(a=c.$(e+b.id),b.type){case d.bool:a.prop("checked",b.defaultvalue?"checked":!1);break;case d.pix:break;default:a.html(b.defaultvalue||"")}}),f&&_.each(f,function(a){c.$('[data-pid="'+a.id+'"] tbody').html(c._TRnodata(a.elements.length,"view"))}),this},_renderButtons:function(a){a.push(Evol.UI.html.clearer,'<div class="evol-buttons">',Evol.UI.input.button("cancel",Evol.i18n.Cancel,"btn-default"),Evol.UI.input.button("edit",Evol.i18n.bEdit,"btn-primary"),"</div>")}});var i18nXpt=Evol.i18n.export;Evol.ViewAction.Export=Backbone.View.extend({viewName:"export",cardinality:"n",events:{"change .evol-xpt-format":"click_format","change input":"click_preview","click .evol-xpt-more":"click_toggle_sel","click button":"click_button"},options:{model:null,uiModel:null,many:!0,sampleMaxSize:20,prefix:"xpt",formats:["CSV","TAB","HTML","XML","SQL","JSON"]},initialize:function(a){return this.options=_.extend({},this.options,a),this.uiModel=this.options.uiModel,this.render(),this},render:function(){return this.$el.html(this._renderHTML()),this._preview("CSV"),this},_renderHTML:function(){var a=[],b=Evol.UI,c=this.options,d=c.prefix||"",e=this.getFields(),f=e.length;a.push('<div class="evol-xpt-form"><div class="evol-xpt-flds"><fieldset>'),_.each(e,function(b,c){var d=b.labelexport||b.label||b.labellist,e="fx-"+b.id;(null===d||""===d)&&(d="("+e+")"),a.push('<div><label class="checkbox"><input type="checkbox" value="1" id="',e,'" checked="checked">',d,"</label></div>"),10==c&&f>14&&a.push(EvoExport.html_more2(i18nXpt.allFields))}),f>14&&a.push("</div>"),a.push('</fieldset></div><div class="evol-xpt-para">');var g=d+"evol-xpt-format",h=[];return a.push('<label for="',g,'">',i18nXpt.format,"</label>"),_.each(c.formats,function(a){h.push({id:a,text:i18nXpt["format"+a]})}),a.push(b.input.select(g,"","evol-xpt-format",!1,h)),g=d+"FLH",a.push('<div class="evol-xpt-opts">','<div class="evol-FLH clearfix">',"<label>",b.input.checkbox(g,!0),i18nXpt.firstLine,"</label>",'</div><div id="',d,'CSV">','<div data-id="csv2" class="evol-w120">',b.fieldLabel(d+"FLS_evol",i18nXpt.separator),b.input.text(d+"FLS_evol",",","0"),"</div>","</div>"),_.each(["XML","HTML","SQL","JSON"],function(b){a.push('<div id="',d,b,'" style="display:none;"></div>')}),a.push("</div>","<label>",i18nXpt.preview,'</label><div class="evol-xpt-preview">','<textarea class="Field evol-xpt-val form-control"></textarea>',"</div></div></div></div>",'<div class="evol-buttons form-actions">',b.input.button("cancel",Evol.i18n.Cancel,"btn-default"),b.input.button("export",i18nXpt.DownloadEntity.replace("{0}",this.uiModel.entities),"btn btn-primary"),"</div>"),a.join("")},setModel:function(a){this.options.model=a},showFormatOpts:function(a){{var b="#"+(this.options.prefix||"");this.$el}switch(a){case"TAB":a="CSV",this.$('[data-id="csv2"]').hide();break;case"CSV":this.$('[data-id="csv2"]').show();break;case"HTML":case"XML":case"SQL":case"JSON":var c=this.$(b+a);""===c.html()&&c.html(EvoExport["opts"+a](this.uiModel.entity))}var d=this.$(b+a).show().siblings().hide(),e=d.filter(".evol-FLH");Evol.UI.setVisible(e,"TAB"===a||"CSV"===a),EvoExport.cFormat=a},getFields:function(){var a=this.options;return this.fields||(this.fields=Evol.Dico.getFields(this.uiModel,a.fnFilter,a.mode)),this.fields},getTitle:function(){return this.options.many?Evol.i18n.getLabel("export.ExportEntities",this.uiModel.entities):Evol.i18n.getLabel("export.ExportEntity",this.uiModel.entity)},_preview:function(a){var b=[],c=this.$(".evol-xpt-val"),d=Evol.Dico.fieldTypes,e=this.options.sampleMaxSize-1;if(this.model&&this.model.collection){var f=this.model.collection.models,g=this.getFields(),h=this.$(".evol-xpt-flds > fieldset input:checked"),i={},j="#"+this.options.prefix,k=this.$(j+"FLH").prop("checked");_.each(h,function(a){i[a.id.substring(3)]=""}),g=_.filter(g,function(a){return a.id&&_.has(i,a.id)?!0:void 0});var l=g.length-1;switch(a){case"CSV":case"TAB":case"TXT":var m=Evol.UI.trim(this.$(j+"FLS_evol").val());"TAB"==a&&(m="&#09;"),k&&(_.each(g,function(a,c){b.push(a.label),l>c&&b.push(m)}),b.push("\n")),_.every(f,function(a,c){return _.each(g,function(c,d){var e=a.get(c.id);e&&b.push(e),l>d&&b.push(m)}),b.push("\n"),e>c}),b.push("\n");break;case"HTML":b.push("<table>\n"),k&&(b.push("<tr>\n"),_.each(g,function(a){b.push("<th>",a.id,"</th>")}),b.push("</tr>\n")),_.every(f,function(a,c){return b.push("<tr>"),_.each(g,function(c){var d=a.get(c.id);_.isUndefined(d)||""===d?b.push("<td></td>"):b.push("<td>",d,"</td>")}),b.push("</tr>\n"),e>c}),b.push("</table>");break;case"JSON":_.every(f,function(a,c){return b.push(JSON.stringify(a.toJSON(),null,2)),e>c});break;case"SQL":var n=this.$("#evoxpTRS1").prop("checked"),o=this.$("#evoxpTRS2").prop("checked"),p=this.$("#evoTable").val().replace(/ /g,"_"),q=["INSERT INTO ",p," ("];""===p&&(p=this.uiModel.entity.replace(/ /g,"_")),_.each(g,function(a,b){q.push(a.id),l>b&&q.push(", ")}),q.push(")\n VALUES ("),q=q.join(""),n&&b.push("BEGIN TRANSACTION\n"),o&&b.push("SET IDENTITY_INSERT ",p," ON;\n");var r;_.every(f,function(a,c){return b.push(q),_.each(g,function(c,e){switch(r=a.get(c.id),c.type){case d.int:case d.dec:case d.money:b.push(r?r:"NULL");break;case d.bool:b.push("boolean"==typeof r?r:"NULL");break;case d.date:case d.datetime:case d.time:_.isUndefined(r)||""===r?b.push("NULL"):b.push('"',r.replace(/"/g,'""'),'"');break;default:_.isUndefined(r)?b.push('""'):b.push('"',r.replace(/"/g,'""'),'"')}l>e&&b.push(", ")}),b.push(");\n"),e>c}),o&&b.push("SET IDENTITY_INSERT ",p," OFF;\n"),n&&b.push("COMMIT TRANSACTION\n");break;case"XML":var s,t=this.$("#evoRoot").val()||this.uiModel.entity.replace(/ /g,"_");b.push("<xml>\n"),_.every(f,function(a,c){return b.push("<",t," "),_.each(g,function(c){b.push(c.id,'="'),c.type===d.text||c.type===d.textml?(s=a.get(c.id),_.isUndefined(s)||b.push(s.replace(/"/g,'\\"'))):b.push(a.get(c.id)),b.push('" ')}),b.push("></",t,">\n"),e>c}),b.push("</xml>")}}else b.push(Evol.i18n.nodata);c.html(this.options.many&&"JSON"===a?"["+b.join(",\n")+"]":b.join(""))},val:function(a){return _.isUndefined(a)?this._getValue():this},_valFields:function(){var a=[],b=this.$(".evol-xpt-flds input:checked");return _.each(b,function(b){a.push(b.id.substr(3))}),a},_getValue:function(){var a={format:EvoExport.cFormat,fields:this._valFields(),options:{}},b=this.$(".evol-xpt-para input"),c=b.eq(0);return a.options[c.attr("id")]=!_.isUndefined(c.prop("checked")),a},click_format:function(a){var b=$(a.currentTarget).val();"XML"===b&&(this.$("#XML").html(EvoExport.optsXML(this.uiModel.entity)).show().siblings().not(".evol-FLH").hide(),EvoExport.cFormat="XML"),this.showFormatOpts(b),this._preview(b),this.$el.trigger("change.export","format",b)},click_preview:function(){var a=this.$(".evol-xpt-format").val();this._preview(a)},click_toggle_sel:function(a){$(a.currentTarget).hide().next().slideDown()},click_button:function(a){var b=$(a.currentTarget).data("id");this.$el.trigger("action",b)}});var EvoExport={cFormat:"CSV",html_more2:function(a){return['<a href="javascript:void(0)" class="evol-xpt-more">',a,'</a><div style="display:none;">'].join("")},optsHTML:function(){return""},optsXML:function(a){return[EvoExport.html_more2("options"),EvoExport.optEntityName("evoRoot",i18nXpt.XMLroot,a),Evol.UI.fieldLabel("evoxpC2X",i18nXpt.xpColMap),"</div>"].join("")},optsJSON:function(){return""},optsSQL:function(a){return[EvoExport.html_more2("options"),EvoExport.optEntityName("evoTable",i18nXpt.SQLTable,a),"<div>",Evol.UI.input.checkbox("evoxpTRS2","0"),Evol.UI.fieldLabelSpan("evoxpTRS2",i18nXpt.SQLId),"</div>","<div>",Evol.UI.input.checkbox("evoxpTRS1","0"),Evol.UI.fieldLabelSpan("evoxpTRS1",i18nXpt.SQLTrans),"</div>","</div>"].join("")},optEntityName:function(a,b,c){return[Evol.UI.fieldLabel(a,b),Evol.UI.input.text(a,c.replace(" ","_"),30),"<br/>"].join("")}},evoLang=Evol.i18n.filters,fOps={sEqual:"eq",sNotEqual:"ne",sStart:"sw",sContain:"ct",sFinish:"fw",sInList:"in",sIsNull:"null",sIsNotNull:"nn",sGreater:"gt",sSmaller:"lt",sBetween:"bw"};_renderMenu=function(a){var b=Evol.UI.menu;a.push(b.hBegin("file","div","cog"),b.hItem("save","Save","",1),b.hItem("open","Open","",1),b.hEnd("div"))},Evol.ViewAction.Filter=Backbone.View.extend({viewName:"filter",events:{"click .evo-bNew":"click_new","click .evo-bAdd":"click_add","click .evo-bSubmit":"click_submit","click .evo-zfilters>a>button":"click_remove"},options:{fields:[],dateFormat:"mm/dd/yyyy",buttonLabels:!1,submitButton:!1,submitReady:!1},initialize:function(a){return _.extend(this.options,a),!this.options.uiModel||this.options.fields&&0!==this.options.fields.length||(this.options.fields=_.map(Evol.Dico.getFields(this.options.uiModel,function(a){return a.type!==Evol.Dico.fieldTypes.hidden}),function(a){return a.type!==Evol.Dico.fieldTypes.list?a:_.extend(a,{type:Evol.Dico.fieldTypes.lov,trueType:Evol.Dico.fieldTypes.list})})),this},render:function(){var a=this.options.buttonLabels,b=this,c=this.$el,d=[];return d.push('<div class="evo-zfilters"></div>','<a class="evo-bNew btn btn-primary" href="javascript:void(0)">',evoLang.bNewFilter,"</a>"),this.options.submitButton&&d.push('<a class="evo-bSubmit btn btn-primary" href="javascript:void(0)">',evoLang.bSubmit,"</a>"),d.push('<div class="evo-editFilter"></div>','<a class="evo-bAdd btn btn-primary" style="display:none;" href="javascript:void(0)">',evoLang.bAddFilter,"</a>",'<a class="evo-bDel btn btn-default" style="display:none;" href="javascript:void(0)">',evoLang.bCancel,"</a>"),this._step=0,_renderMenu(d),c.html(d.join("")),this.options.submitReady&&(this._hValues=$("<span></span>").appendTo(c)),this.options.submitButton&&(this._bSubmit=c.find(".evo-bSubmit").button({text:a})),this._bNew=c.find(".evo-bNew").button({text:a,icons:{secondary:"ui-icon-plusthick"}}),this._bAdd=c.find(".evo-bAdd").button({text:a,icons:{secondary:"ui-icon-check"}}),this._bDel=c.find(".evo-bDel").button({text:a,icons:{secondary:"ui-icon-close"}}).on("click",function(){b._removeEditor()}),this._editor=c.find(".evo-editFilter").on("change","#field",function(a){a.stopPropagation(),b._step>2&&b._editor.find("#value,#value2,.as-Txt").remove(),b._step>1&&(b._editor.find("#operator").remove(),b._bAdd.hide()),b._step=1;var c=$(a.currentTarget).val();if(""!==c){b._field=b._getFieldById(c);var d=b._type=b._field.type;b._setEditorOperator(),(d==Evol.Dico.fieldTypes.lov||d==Evol.Dico.fieldTypes.bool)&&b._setEditorValue()}else b._field=b._type=null}).on("change","#operator",function(a){a.stopPropagation(),b._operator=$(this).val(),b._step>2&&(b._editor.find("#value,#value2,.as-Txt").remove(),b._bAdd.hide(),b._step=2),b._setEditorValue()}).on("change keyup","#value,#value2",function(a){a.stopPropagation();var c=b._type,d=$(this).val(),e=""!==d||c==Evol.Dico.fieldTypes.lov||c==Evol.Dico.fieldTypes.bool;c==Evol.Dico.fieldTypes.number?e=e&&!isNaN(d):b._operator==fOps.sBetween&&(e=""!==b._editor.find("#value").val()&&""!==b._editor.find("#value2").val()),e?(b._bAdd.button("enable"),13==a.which&&b._bAdd.trigger("click")):b._bAdd.button("disable")}).on("click","#checkAll",function(){var a=$(this);Evol.UI.toggleCheckbox(a.siblings(),a.prop("checked"))}),this._filters=c.find(".evo-zfilters").on("click","a",function(){b._editFilter($(this))}).on("click","a>button",function(a){a.stopPropagation();var c=$(this).parent();c.hasClass("ui-state-disabled")||c.fadeOut("slow",function(){c.remove(),b._triggerChange()})}),this},_getFieldById:function(a){if(!this._hash){this._hash={};for(var b=this.options.fields,c=0,d=b.length;d>c;c++)this._hash[b[c].id]=b[c]}return this._hash[a]},_removeEditor:function(){this._editor.empty(),this._bAdd.hide(),this._bDel.hide(),this._enableFilter(null,!1),this._bNew.removeClass("ui-state-active").show().focus(),this._bSubmit&&this._bSubmit.removeClass("ui-state-active").show(),this._step=0,this._field=this._type=this._operator=null},addFilter:function(a){$(['<a href="javascript:void(0)">',this._htmlFilter(a),"</a>"].join("")).prependTo(this._filters).data("filter",a).fadeIn();return this._triggerChange(),this},removeFilter:function(a){return this._filters.children().eq(a).remove(),this._triggerChange(),this},_htmlFilter:function(a){var b=['<span class="evo-lBold">',a.field.label,"</span> ",'<span class="evo-lLight">',a.operator.label,"</span> ",'<span class="evo-lBold">',a.value.label,"</span>"];return a.operator.value==fOps.sBetween&&b.push('<span class="evo-lLight"> ',evoLang.opAnd," </span>",'<span class="evo-lBold">',a.value.label2,"</span>"),b.push(Evol.UI.html.buttonClose),b.join("")},_enableFilter:function(a){this._cFilter&&(this._cFilter.removeClass("disabled"),a?(this._cFilter.data("filter",a).html(this._htmlFilter(a)),this._cFilter=null,this._triggerChange()):this._cFilter=null)},_editFilter:function(a){var b=a.data("filter"),c=b.field.value,d=b.operator.value,e=b.value;this._enableFilter(null,!1),this._removeEditor(),this._cFilter=a.addClass("disabled"),this._setEditorField(c),this._setEditorOperator(d),d==fOps.sBetween?this._setEditorValue(e.value,e.value2):this._setEditorValue(e.value),this._bAdd.find(".ui-button-text").html(evoLang.bUpdateFilter),this._step=3},_setEditorField:function(a){if(this._step<1){if(this._bNew.stop().hide(),this._bSubmit&&this._bSubmit.stop().hide(),this._bDel.show(),!this._fList){for(var b=this.options.fields,c=['<select id="field" class="form-control"><option value=""></option>'],d=0,e=b.length;e>d;d++){var f=b[d];c.push(Evol.UI.input.option(f.id,f.label||f.labellist))}c.push("</select>"),this._fList=c.join("")}$(this._fList).appendTo(this._editor).focus()}a&&(this._field=this._getFieldById(a),this._type=this._field.type,this._editor.find("#field").val(a)),this._step=1},_setEditorOperator:function(a){var b=Evol.UI,c=b.input.option,d=Evol.Dico.fieldTypes,e=this._type;if(this._step<2){var f=[];switch(e){case d.lov:f.push(b.input.hidden("operator",fOps.sInList)),this._operator=fOps.sInList;break;case d.bool:f.push(b.input.hidden("operator",fOps.sEqual)),this._operator=fOps.sEqual;break;default:switch(f.push(b.input.selectBegin("operator","",!0)),e){case d.date:case d.datetime:case d.time:e==d.time?f.push(c(fOps.sEqual,evoLang.sAt),c(fOps.sNotEqual,evoLang.sNotAt)):f.push(c(fOps.sEqual,evoLang.sOn),c(fOps.sNotEqual,evoLang.sNotOn)),f.push(c(fOps.sGreater,evoLang.sAfter),c(fOps.sSmaller,evoLang.sBefore),c(fOps.sBetween,evoLang.sBetween));break;case d.int:case d.dec:case d.money:f.push(c(fOps.sEqual,evoLang.sNumEqual),c(fOps.sNotEqual,evoLang.sNumNotEqual),c(fOps.sGreater,evoLang.sGreater),c(fOps.sSmaller,evoLang.sSmaller));break;default:f.push(c(fOps.sEqual,evoLang.sEqual),c(fOps.sNotEqual,evoLang.sNotEqual),c(fOps.sStart,evoLang.sStart),c(fOps.sContain,evoLang.sContain),c(fOps.sFinish,evoLang.sFinish))}f.push(c(fOps.sIsNull,evoLang.sIsNull),c(fOps.sIsNotNull,evoLang.sIsNotNull)),f.push("</select>")}this._editor.append(f.join(""))}a&&e!=d.lov&&(this._editor.find("#operator").val(a),this._operator=a),this._step=2},_setEditorValue:function(a,b){var c=this._editor,d=Evol.Dico.fieldTypes,e=this._type,f=c.find("#operator").val(),g=!1,h=!0;if(""!==f){if(e==d.lov||f!=fOps.sIsNull&&f!=fOps.sIsNotNull){if(this._step<3){var i=[];switch(g=f==fOps.sBetween,e){case d.lov:i.push('<section id="value">'),this._field.list.length>7&&i.push('(<input type="checkbox" id="checkAll" value="1"/><label for="checkAll">All</label>) '),i.push(Evol.UI.input.checkboxLOV(this._field.list)),i.push("</section>");break;case d.bool:i.push('<span id="value">',Evol.UI.input.radio("value","1",evoLang.yes,"0"!=a,"value1"),Evol.UI.input.radio("value","0",evoLang.no,"0"==a,"value0"),"</span>");break;case d.date:case d.datetime:case d.time:case d.int:case d.dec:case d.money:var j=e==d.date?"text":e;i.push('<input id="value" type="',j,'" class="form-control"/>'),g&&i.push('<span class="as-Txt">',evoLang.opAnd," </span>",'<input id="value2" type="',j,'" class="form-control"/>'),h=!1;break;default:i.push('<input id="value" type="text" class="form-control"/>'),h=!1}c.append(i.join("")),e==d.date&&c.find("#value,#value2").datepicker({dateFormat:this.options.dateFormat})}if(a){var k=c.find("#value");switch(e){case d.lov:k.find("#"+a.split(",").join(",#")).prop("checked","checked");break;case d.bool:k.find("#value"+a).prop("checked","checked");break;default:k.val(a),h=""!==a,g&&(k.next().next().val(b),h=""!==a&&""!==b)}}else h=e==d.lov||e==d.bool}else c.append(Evol.UI.input.hidden("value",""));this._bAdd.button(h?"enable":"disable").show(),this._step=3}},_getEditorData:function(){function a(a){var b=n.split("/");return b.length>2?b[2]+"-"+b[0]+"-"+b[1]:a}var b=this._editor,c=b.find("#field"),d=b.find("#value"),e={field:{label:c.find("option:selected").text(),value:c.val()},operator:{},value:{}},f=e.operator,g=e.value;if(this._type==Evol.Dico.fieldTypes.lov){var h=[],i=[];d.find("input:checked").not("#checkAll").each(function(){h.push(this.value),i.push(this.nextSibling.innerHTML)}),0===h.length?(f.label=evoLang.sIsNull,f.value=fOps.sIsNull,g.label=g.value=""):1==h.length?(f.label=evoLang.sEqual,f.value=fOps.sEqual,g.label='"'+i[0]+'"',g.value=h[0]):(f.label=evoLang.sInList,f.value=fOps.sInList,g.label="("+i.join(", ")+")",g.value=h.join(","))}else if(this._type==Evol.Dico.fieldTypes.bool){f.label=evoLang.sEqual,f.value=fOps.sEqual;var j=d.find("#value1").prop("checked")?1:0;g.label=1==j?evoLang.yes:evoLang.no,g.value=j}else{var k=b.find("#operator"),l=k.val();if(f.label=k.find("option:selected").text(),f.value=l,l==fOps.sIsNull||l==fOps.sIsNotNull)g.label=g.value="";else{var m=Evol.Dico.fieldTypes,n=d.val();switch(this._type){case m.text:g.label=n,g.value=n.toLocaleLowerCase();break;case m.int:case m.dec:case m.time:g.label=n,g.value=n;break;case m.date:case m.datetime:g.value=a(n),g.label=n;break;default:g.label=n,g.value=n}l==fOps.sBetween&&(n=d.next().next().val(),g.label2=n,this._type===m.date||this._type===m.datetime?(g.value2=a(n),g.label2=n):g.value2=n)}}return e},_hiddenValue:function(a,b,c){var d=Evol.UI.hidden;a.push(d("fld-"+c,b.field.value),d("op-"+c,b.operator.value),d("val-"+c,b.value.value));var e=b.value.value2;e&&a.push(d("val2-"+c,e))},_setHiddenValues:function(){for(var a=this.val(),b=a.length,c=[Evol.UI.hidden("elem",b)],d=0;b>d;d++)this._hiddenValue(c,a[d],d+1);this._hValues.html(c.join(""))},_triggerChange:function(){this.options.submitReady&&this._setHiddenValues(),this.$el.trigger("filter.change")},val:function(a){if(_.isUndefined(a)){var b=[];return this._filters.find("a").each(function(){b.push($(this).data("filter"))}),b}this._filters.empty();for(var c=0,d=a.length;d>c;c++)this.addFilter(a[c]);return this._triggerChange(),this},valText:function(){var a=[];return this._filters.find("a").each(function(){a.push(this.text)}),a.join(" "+evoLang.opAnd+" ")},clear:function(){return this._cFilter=null,this._removeEditor(),this._filters.empty(),this._triggerChange(),this},length:function(){return this._filters.children().length},click_new:function(){this._step<1&&(this._setEditorField(),this._step=1),this._bAdd.find(".ui-button-text").html(evoLang.bAddFilter)},click_add:function(){var a=this._getEditorData();this._cFilter?this._enableFilter(a,this.options.highlight):this.addFilter(a),this._removeEditor()},click_remove:function(a){a.stopImmediatePropagation(),a.stopPropagation(),$(a.currentTarget).closest("a").remove(),this._triggerChange()},click_submit:function(){this.$el.trigger("submit.filter")}});var evoLang=Evol.i18n.filters,fOps={sEqual:"eq",sNotEqual:"ne",sStart:"sw",sContain:"ct",sFinish:"fw",sInList:"in",sIsNull:"null",sIsNotNull:"nn",sGreater:"gt",sSmaller:"lt",sBetween:"bw"};Evol.ViewAction.Filter=Backbone.View.extend({viewName:"filter",events:{"click .evo-bNew":"click_new","click .evo-bAdd":"click_add","click .evo-bSubmit":"click_submit","click .evo-zfilters>a>button":"click_remove"},options:{fields:[],dateFormat:"mm/dd/yyyy",buttonLabels:!1,submitButton:!1,submitReady:!1},initialize:function(a){return this.options=_.extend({},this.options,a),this.uiModel=this.options.uiModel,!this.uiModel||this.options.fields&&0!==this.options.fields.length||(this.options.fields=_.map(Evol.Dico.getFields(this.uiModel,function(a){return a.type!==Evol.Dico.fieldTypes.hidden}),function(a){return a.type!==Evol.Dico.fieldTypes.list?a:_.extend(a,{type:Evol.Dico.fieldTypes.lov,trueType:Evol.Dico.fieldTypes.list})})),this},render:function(){var a=this.options.buttonLabels,b=this,c=this.$el,d=['<div class="evo-zfilters"></div>','<a class="evo-bNew btn btn-primary" href="javascript:void(0)">',evoLang.bNewFilter,"</a>"];return this.options.submitButton&&d.push('<a class="evo-bSubmit btn btn-primary" href="javascript:void(0)">',evoLang.bSubmit,"</a>"),d.push('<div class="evo-editFilter"></div>','<a class="evo-bAdd btn btn-primary" style="display:none;" href="javascript:void(0)">',evoLang.bAddFilter,"</a>",'<a class="evo-bDel btn btn-default" style="display:none;" href="javascript:void(0)">',evoLang.bCancel,"</a>"),this._step=0,c.html(d.join("")),this.options.submitReady&&(this._hValues=$("<span></span>").appendTo(c)),this.options.submitButton&&(this._bSubmit=c.find(".evo-bSubmit").button({text:a})),this._bNew=c.find(".evo-bNew").button({text:a,icons:{secondary:"ui-icon-plusthick"}}),this._bAdd=c.find(".evo-bAdd").button({text:a,icons:{secondary:"ui-icon-check"}}),this._bDel=c.find(".evo-bDel").button({text:a,icons:{secondary:"ui-icon-close"}}).on("click",function(){b._removeEditor()
}),this._editor=c.find(".evo-editFilter").on("change","#field",function(a){a.stopPropagation(),b._step>2&&b._editor.find("#value,#value2,.as-Txt").remove(),b._step>1&&(b._editor.find("#operator").remove(),b._bAdd.hide()),b._step=1;var c=$(a.currentTarget).val();if(""!==c){b._field=b._getFieldById(c);var d=b._type=b._field.type;b._setEditorOperator(),(d==Evol.Dico.fieldTypes.lov||d==Evol.Dico.fieldTypes.bool)&&b._setEditorValue()}else b._field=b._type=null}).on("change","#operator",function(a){a.stopPropagation(),b._operator=$(this).val(),b._step>2&&(b._editor.find("#value,#value2,.as-Txt").remove(),b._bAdd.hide(),b._step=2),b._setEditorValue()}).on("change keyup","#value,#value2",function(a){a.stopPropagation();var c=b._type,d=$(this).val(),e=""!==d||c==Evol.Dico.fieldTypes.lov||c==Evol.Dico.fieldTypes.bool;c==Evol.Dico.fieldTypes.number?e=e&&!isNaN(d):b._operator==fOps.sBetween&&(e=""!==b._editor.find("#value").val()&&""!==b._editor.find("#value2").val()),e?(b._bAdd.button("enable"),13==a.which&&b._bAdd.trigger("click")):b._bAdd.button("disable")}).on("click","#checkAll",function(){{var a=$(this);a.prop("checked")}Evol.UI.toggleCheckbox(a.siblings(),a.prop("checked"))}),this._filters=c.find(".evo-zfilters").on("click","a",function(){b._editFilter($(this))}).on("click","a>button",function(a){a.stopPropagation();var c=$(this).parent();c.hasClass("ui-state-disabled")||c.fadeOut("slow",function(){c.remove(),b._triggerChange()})}),this},_getFieldById:function(a){if(!this._hash){this._hash={};for(var b=this.options.fields,c=0,d=b.length;d>c;c++)this._hash[b[c].id]=b[c]}return this._hash[a]},_removeEditor:function(){this._editor.empty(),this._bAdd.hide(),this._bDel.hide(),this._enableFilter(null,!1),this._bNew.removeClass("ui-state-active").show().focus(),this._bSubmit&&this._bSubmit.removeClass("ui-state-active").show(),this._step=0,this._field=this._type=this._operator=null},addFilter:function(a){$(['<a href="javascript:void(0)">',this._htmlFilter(a),"</a>"].join("")).prependTo(this._filters).data("filter",a).fadeIn();return this._triggerChange(),this},removeFilter:function(a){return this._filters.children().eq(a).remove(),this._triggerChange(),this},_htmlFilter:function(a){var b=['<span class="evo-lBold">',a.field.label,"</span> ",'<span class="evo-lLight">',a.operator.label,"</span> ",'<span class="evo-lBold">',a.value.label,"</span>"];return a.operator.value==fOps.sBetween&&b.push('<span class="evo-lLight"> ',evoLang.opAnd," </span>",'<span class="evo-lBold">',a.value.label2,"</span>"),b.push(Evol.UI.html.buttonClose),b.join("")},_enableFilter:function(a){this._cFilter&&(this._cFilter.removeClass("disabled"),a?(this._cFilter.data("filter",a).html(this._htmlFilter(a)),this._cFilter=null,this._triggerChange()):this._cFilter=null)},_editFilter:function(a){var b=a.data("filter"),c=b.field.value,d=b.operator.value,e=b.value;this._enableFilter(null,!1),this._removeEditor(),this._cFilter=a.addClass("disabled"),this._setEditorField(c),this._setEditorOperator(d),d==fOps.sBetween?this._setEditorValue(e.value,e.value2):this._setEditorValue(e.value),this._bAdd.find(".ui-button-text").html(evoLang.bUpdateFilter),this._step=3},_setEditorField:function(a){if(this._step<1){if(this._bNew.stop().hide(),this._bSubmit&&this._bSubmit.stop().hide(),this._bDel.show(),!this._fList){for(var b=this.options.fields,c=['<select id="field" class="form-control"><option value=""></option>'],d=0,e=b.length;e>d;d++){var f=b[d];c.push(Evol.UI.input.option(f.id,f.label||f.labellist))}c.push("</select>"),this._fList=c.join("")}$(this._fList).appendTo(this._editor).focus()}a&&(this._field=this._getFieldById(a),this._type=this._field.type,this._editor.find("#field").val(a)),this._step=1},_setEditorOperator:function(a){var b=Evol.UI,c=b.input.option,d=Evol.Dico.fieldTypes,e=this._type;if(this._step<2){var f=[];switch(e){case d.lov:f.push(b.input.hidden("operator",fOps.sInList)),this._operator=fOps.sInList;break;case d.bool:f.push(b.input.hidden("operator",fOps.sEqual)),this._operator=fOps.sEqual;break;default:switch(f.push(b.input.selectBegin("operator","",!0)),e){case d.date:case d.datetime:case d.time:e==d.time?f.push(c(fOps.sEqual,evoLang.sAt),c(fOps.sNotEqual,evoLang.sNotAt)):f.push(c(fOps.sEqual,evoLang.sOn),c(fOps.sNotEqual,evoLang.sNotOn)),f.push(c(fOps.sGreater,evoLang.sAfter),c(fOps.sSmaller,evoLang.sBefore),c(fOps.sBetween,evoLang.sBetween));break;case d.int:case d.dec:case d.money:f.push(c(fOps.sEqual,evoLang.sNumEqual),c(fOps.sNotEqual,evoLang.sNumNotEqual),c(fOps.sGreater,evoLang.sGreater),c(fOps.sSmaller,evoLang.sSmaller));break;default:f.push(c(fOps.sEqual,evoLang.sEqual),c(fOps.sNotEqual,evoLang.sNotEqual),c(fOps.sStart,evoLang.sStart),c(fOps.sContain,evoLang.sContain),c(fOps.sFinish,evoLang.sFinish))}f.push(c(fOps.sIsNull,evoLang.sIsNull),c(fOps.sIsNotNull,evoLang.sIsNotNull)),f.push("</select>")}this._editor.append(f.join(""))}a&&e!=d.lov&&(this._editor.find("#operator").val(a),this._operator=a),this._step=2},_setEditorValue:function(a,b){var c=this._editor,d=Evol.Dico.fieldTypes,e=this._type,f=c.find("#operator").val(),g=!1,h=!0;if(""!==f){if(e==d.lov||f!=fOps.sIsNull&&f!=fOps.sIsNotNull){if(this._step<3){var i=[];switch(g=f==fOps.sBetween,e){case d.lov:i.push('<section id="value">'),this._field.list.length>7&&i.push('(<input type="checkbox" id="checkAll" value="1"/><label for="checkAll">All</label>) '),i.push(Evol.UI.input.checkboxLOV(this._field.list)),i.push("</section>");break;case d.bool:i.push('<span id="value">',Evol.UI.input.radio("value","1",evoLang.yes,"0"!=a,"value1"),Evol.UI.input.radio("value","0",evoLang.no,"0"==a,"value0"),"</span>");break;case d.date:case d.datetime:case d.time:case d.int:case d.dec:case d.money:var j=e==d.date?"text":e;i.push('<input id="value" type="',j,'" class="form-control"/>'),g&&i.push('<span class="as-Txt">',evoLang.opAnd," </span>",'<input id="value2" type="',j,'" class="form-control"/>'),h=!1;break;default:i.push('<input id="value" type="text" class="form-control"/>'),h=!1}c.append(i.join("")),e==d.date&&c.find("#value,#value2").datepicker({dateFormat:this.options.dateFormat})}if(a){var k=c.find("#value");switch(e){case d.lov:k.find("#"+a.split(",").join(",#")).prop("checked","checked");break;case d.bool:k.find("#value"+a).prop("checked","checked");break;default:k.val(a),h=""!==a,g&&(k.next().next().val(b),h=""!==a&&""!==b)}}else h=e==d.lov||e==d.bool}else c.append(Evol.UI.input.hidden("value",""));this._bAdd.button(h?"enable":"disable").show(),this._step=3}},_getEditorData:function(){function a(a){var b=n.split("/");return b.length>2?b[2]+"-"+b[0]+"-"+b[1]:a}var b=this._editor,c=b.find("#field"),d=b.find("#value"),e={field:{label:c.find("option:selected").text(),value:c.val()},operator:{},value:{}},f=e.operator,g=e.value;if(this._type==Evol.Dico.fieldTypes.lov){var h=[],i=[];d.find("input:checked").not("#checkAll").each(function(){h.push(this.value),i.push(this.nextSibling.innerHTML)}),0===h.length?(f.label=evoLang.sIsNull,f.value=fOps.sIsNull,g.label=g.value=""):1==h.length?(f.label=evoLang.sEqual,f.value=fOps.sEqual,g.label='"'+i[0]+'"',g.value=h[0]):(f.label=evoLang.sInList,f.value=fOps.sInList,g.label="("+i.join(", ")+")",g.value=h.join(","))}else if(this._type==Evol.Dico.fieldTypes.bool){f.label=evoLang.sEqual,f.value=fOps.sEqual;var j=d.find("#value1").prop("checked")?1:0;g.label=1==j?evoLang.yes:evoLang.no,g.value=j}else{var k=b.find("#operator"),l=k.val();if(f.label=k.find("option:selected").text(),f.value=l,l==fOps.sIsNull||l==fOps.sIsNotNull)g.label=g.value="";else{var m=Evol.Dico.fieldTypes,n=d.val();switch(this._type){case m.text:g.label=n,g.value=n.toLocaleLowerCase();break;case m.int:case m.dec:case m.time:g.label=n,g.value=n;break;case m.date:case m.datetime:g.value=a(n),g.label=n;break;default:g.label=n,g.value=n}l==fOps.sBetween&&(n=d.next().next().val(),g.label2=n,this._type===m.date||this._type===m.datetime?(g.value2=a(n),g.label2=n):g.value2=n)}}return e},_hiddenValue:function(a,b,c){var d=Evol.UI.hidden;a.push(d("fld-"+c,b.field.value),d("op-"+c,b.operator.value),d("val-"+c,b.value.value));var e=b.value.value2;e&&a.push(d("val2-"+c,e))},_setHiddenValues:function(){for(var a=this.val(),b=a.length,c=[Evol.UI.hidden("elem",b)],d=0;b>d;d++)this._hiddenValue(c,a[d],d+1);this._hValues.html(c.join(""))},_triggerChange:function(){this.options.submitReady&&this._setHiddenValues(),this.$el.trigger("filter.change")},val:function(a){if(_.isUndefined(a)){var b=[];return this._filters.find("a").each(function(){b.push($(this).data("filter"))}),b}this._filters.empty();for(var c=0,d=a.length;d>c;c++)this.addFilter(a[c]);return this._triggerChange(),this},valText:function(){var a=[];return this._filters.find("a").each(function(){a.push(this.text)}),a.join(" "+evoLang.opAnd+" ")},clear:function(){return this._cFilter=null,this._removeEditor(),this._filters.empty(),this._triggerChange(),this},length:function(){return this._filters.children().length},click_new:function(){this._step<1&&(this._setEditorField(),this._step=1),this._bAdd.find(".ui-button-text").html(evoLang.bAddFilter)},click_add:function(){var a=this._getEditorData();this._cFilter?this._enableFilter(a,this.options.highlight):this.addFilter(a),this._removeEditor()},click_remove:function(a){a.stopImmediatePropagation(),a.stopPropagation(),$(a.currentTarget).closest("a").remove(),this._triggerChange()},click_submit:function(){this.$el.trigger("submit.filter")}}),Evol.ViewToolbar=Backbone.View.extend({events:{"click .nav a":"click_toolbar","list.navigate >div":"click_navigate","list.paginate >div":"paginate","action >div":"action_view","status >div":"status_update","filter.change >div":"change_filter","click .alert-dismissable>button":"clearMessage","message >div":"showMessage"},options:{toolbar:!0,defaultView:"list",style:"panel-info",display:"label",titleSelector:"#title",buttons:{view:!0,edit:!0,mini:!0,json:!0,list:!0,badges:!0,charts:!0,"new":!0,save:!0,del:!0,filter:!0,"export":!0,group:!1,customize:!1},pageSize:20},modesHash:{view:"View",edit:"Edit",mini:"Mini",json:"JSON",badges:"Badges",list:"List",charts:"Charts"},initialize:function(a){this.options=_.extend(this.options,a),this.pageIndex=this.options.pageIndex,this.uiModel=this.options.uiModel,this.router=this.options.router,this.views=[],this.viewsHash={}},render:function(){return this.$el.html(this._toolbarHTML()),this.setView(this.options.defaultView||"list",!1),this._viewsIcon=this.$(".glyphicon-eye-open"),this.$(".dropdown-toggle").dropdown(),this},_toolbarHTML:function(){function a(a,e,f,g){d.buttons&&d.buttons[a]&&b.push(c.hItem(a,e,f,g))}var b=[],c=Evol.UI.menu,d=this.options,e='<li class="divider" data-cardi="1"></li>',f='<li class="divider-h"></li>';return b.push('<div class="evo-toolbar"><ul class="nav nav-pills pull-left" data-id="main">'),a("list","","th-list"),a("new","","plus"),b.push(f),a("edit",Evol.i18n.bEdit,"pencil","1"),a("save",Evol.i18n.bSave,"floppy-disk","1"),a("del",Evol.i18n.bDelete,"trash","1"),a("filter",Evol.i18n.bFilter,"filter","n"),a("charts",Evol.i18n.bCharts,"stats","n"),a("export",Evol.i18n.bExport,"cloud-download","n"),d.toolbar&&(b.push('</ul><ul class="nav nav-pills pull-right" data-id="views">','<li class="evo-tb-status" data-cardi="n"></li>',c.hItem("prev","","chevron-left","x"),c.hItem("next","","chevron-right","x")),b.push(c.hBegin("views","li","eye-open")),a("view","View","file","1"),a("edit","All Fields","th","1"),a("mini","Mini","th-large","1"),a("wiz","Wizard","arrow-right","1"),a("json","JSON","barcode","1"),b.push(e),a("list","List","th-list","x"),a("badges","Badges","th-large","x"),a("charts","Charts","stats","x"),b.push(c.hEnd("li"))),b.push("</ul>",Evol.UI.html.clearer,"</div>"),b.join("")},updateModel:function(){this.refresh()},refresh:function(){return this.viewsHash.list&&this.viewsHash.list.render(),this.viewsHash.badges&&this.viewsHash.badges.render(),this},setView:function(a,b){var c,d=this.options,e=this.$el,f="evolw-"+a,g=this.$('[data-vid="'+f+'"]'),h=this.curView,i=this._curCollec();if("new"===a)a=this._prevOne?this._prevOne:"edit",this.setView(a,!0),this.model=new d.modelClass,this.model.collection=i,this.newItem(),h.options.mode="new";else if(g.length)this.model=h.model,h.model&&(this.model.collection=i),h=this.viewsHash[a],h.setCollection&&h.setCollection(i),this.model&&!this.model.isNew()?(h.setModel?(h.collection||(h.collection=this.model.collection),h.setModel(this.model)):h.model=this.model,h.setTitle&&h.setTitle(),"n"===h.cardinality&&h.setPage&&h.setPage(this.pageIndex)):h.clear&&h.clear(),this.$('[data-id="views"] > li').removeClass("evo-sel").filter('[data-id="'+a+'"]').addClass("evo-sel"),this.curView=h,g.show().siblings().not(".evo-toolbar,.evo-filters,.clearfix").hide();else{switch(g=$('<div data-vid="evolw-'+a+'"></div>'),e.children().not(".evo-toolbar,.evo-filters,.clearfix").hide(),e.append(g),c={el:g,mode:a,model:this.model,collection:i,uiModel:this.uiModel,style:d.style,pageSize:d.pageSize||20,pageIndex:this.pageIndex||0,titleSelector:d.titleSelector,router:this.router},this.$('[data-id="new"]').show(),this.$('[data-id="views"] > li').removeClass("evo-sel").filter('[data-id="'+a+'"]').addClass("evo-sel"),a){case"view":case"edit":case"mini":case"json":case"wiz":var j,k=null;h&&h.editable&&(k=h,j=h.getData()),h=new Evol.ViewOne[this.modesHash[a]](c).render(),this._prevOne=a;break;case"charts":case"badges":case"list":h=new Evol.ViewMany[this.modesHash[a]](c).render(),this._prevMany=a,h.setTitle(),"charts"!=a&&this.pageIndex>0&&h.setPage(this.pageIndex||0);break;case"export":h=new Evol.ViewAction.Export(c),g.addClass("panel panel-info").slideDown()}_.isUndefined(h)?alert("error: invalid route."):(this.curView=h,this.viewsHash[a]=h,$(this.options.titleSelector).html(h.getTitle()))}return"n"===this.curView.cardinality?(this.setRoute("",!1),this._filterOn&&this.showFilter(!1)):(b&&this.setRoute(this.model?this.model.id:null,!1),this.hideFilter()),this.setIcons(a),this},getView:function(){return this.curView},setTitle:function(){this.curView&&("export"===this.curView.viewName?$(this.options.titleSelector).html(this.curView.getTitle()):this.curView.setTitle())},getToolbarButtons:function(){if(!this._toolbarButtons){var a=this.$(".evo-toolbar li");this._toolbarButtons={ones:a.filter('li[data-cardi="1"]'),manys:a.filter('li[data-cardi="n"]'),edit:a.filter('[data-id="main"]>[data-id="edit"]'),del:a.filter('[data-id="del"]'),save:a.filter('[data-id="save"]'),prevNext:this.$('.evo-toolbar [data-id="prev"],.evo-toolbar [data-id="next"]'),customize:this.$('.evo-toolbar a[data-id="customize"]').parent(),views:this.$('.evo-toolbar [data-id="views"]')}}return this._toolbarButtons},setIcons:function(a){function b(a,b){c(d.ones,a),c(d.manys,b)}var c=Evol.UI.setVisible;if(this.$el){var d=this.getToolbarButtons();if(c(d.customize,"json"!=a),d.prevNext.hide(),c(d.views,"export"!==a),d.del.hide(),this._viewsIcon){var e="glyphicon-eye-open",f="glyphicon-eye-close";"mini"===a||"json"===a?this._viewsIcon.removeClass(e).addClass(f):this._viewsIcon.removeClass(f).addClass(e)}this.model&&this.model.isNew()||"export"===a?(b(!1,!1),this.model&&this.model.isNew()&&$('.evo-dropdown-icons>li[data-cardi="1"]').show()):"badges"===a||"list"===a||"charts"===a?(this._prevMany=a,b(!1,!0),"charts"===a?this.setStatus(""):this.collection.length>this.options.pageSize&&d.prevNext.show()):(this._prevOne=a,b(!0,!1),d.prevNext.show(),c(d.save,"view"!==a),c(d.edit,"view"===a)),c(d.manys.filter('[data-id="group"]'),"badges"===a)}},showFilter:function(a){if(this._filters)this._filters.$el.show();else{if(!a)return this;var b=this,c=$(Evol.UI.HTMLEmptyPanel("filters","evo-filters","info"));this.$(".evo-toolbar").after(c),this._filters=new Evol.ViewAction.Filter({el:c,uiModel:this.uiModel}).render(),c.on("change.filter",function(){b.curView.setFilter(b._filters.val()).render()}),this._filterOn=!0}return this},hideFilter:function(){return this._filters&&(this._filters.$el.hide(),this._filterOn=!1),this},toggleFilter:function(){return this._filtersOn=!this._filtersOn,this._filtersOn?this.showFilter(!0):this.hideFilter()},setStatus:function(a){var b=this.$(".evo-toolbar .evo-tb-status");b.html(a)},setData:function(a){return this.curView&&this.curView.setData(a),this},getData:function(a){return this.curView?this.curView.getData(a):null},setModelById:function(a){var b=this.collection.get(a);this.model=b,"1"!=this.curView.cardinality&&this.setView("view"),this.curView.setModel(b)},browse:function(a){var b=this._curCollec(),c=this.curView.model;if(c&&b&&b.length){var d=b.length-1,e=_.indexOf(b.models,c);e="prev"===a?e>0?e-1:d:d>e?e+1:0,c=b.models[e]}else c=null;return this.model=c,this.curView.setModel(c),c&&this.setRoute(c?c.id:null,!1),this.clearMessage()},setRoute:function(a,b){return Evol.Dico.setRoute(this.router,this.curView.getTitle(),this.uiModel.id,this.curView.viewName,a,b),this},saveItem:function(a){function b(b){a?c.newItem():(c.model=b,c._filteredCollection&&c._filteredCollection.add(b),c.setIcons("edit"),d.setModel(b)),d.setTitle()}var c=this,d=this.curView,e=d.validate();if(""===e){var f=this.uiModel.entity;if(this.model.isNew()){var g=this.collection;g?(g.create(this.getData(!0),{success:function(a){b(a),c.setMessage(Evol.i18n.saved,Evol.i18n.getLabel("status.added",f,_.escape(d.getTitle())),"success")},error:function(){alert('error in "saveItem"')}}),this.options.mode="edit"):alert("Can't save record b/c no collection is specified.")}else this.model.set(this.getData(!0)),this.model.save("","",{success:function(a){b(a),c.setMessage(Evol.i18n.saved,Evol.i18n.getLabel("status.updated",Evol.UI.capitalize(f),_.escape(d.getTitle())),"success")},error:function(){alert('error in "saveItem"')}})}else this.setMessage(Evol.i18n.validation.incomplete,e,"warning");return this},newItem:function(){var a=this.curView;return"view"==a.viewName&&this.setView("view"!==this._prevOne?this._prevOne:"edit"),this.curView.clear().setTitle(Evol.i18n.getLabel("NewEntity",this.uiModel.entity,a.getTitle()))},deleteItem:function(){var a=Evol.i18n,b=this.uiModel.entity,c=this.curView.getTitle();if("1"===this.curView.cardinality){var d=this.curView.model;if(d&&confirm(a.getLabel("DeleteEntity",b,c))){var e=this,f=this.collection,g=_.indexOf(f.models,d),h=g,i=null;f.length>1&&(h=0===g?1:g<f.length-1?g+1:g-1,i=f.at(h)),i&&(i.collection=f),d.destroy({success:function(){null===i||0===f.length?e.curView.clear():(this.model=i,e.curView.setModel(i)),e.setMessage("Record Deleted.",a.getLabel("status.deleted",Evol.UI.capitalize(b),c),"success")},error:function(){alert('error in "deleteItem"')}})}}else if(this.curView.getSelection){var j=this.curView.getSelection();j.length>0&&confirm(a.getLabel("DeleteEntities",j.length,this.uiModel.entities))}},setMessage:function(a,b,c){var d=this.$('[data-id="msg"]');return d.length?(d.attr("class","evo-msg alert alert-"+c+" alert-dismissable"),d.find(">strong").text(a),d.find(">span").html(b),d.show()):$(Evol.UI.HTMLMsg(a," "+b,c)).insertAfter(this.$el.children()[0]),this},clearMessage:function(){return this.$('[data-id="msg"]').remove(),this},showMessage:function(a,b){return b?this.setMessage(b.title,b.content,b.style):this.clearMessage()},action_view:function(a,b){switch(b){case"cancel":this.setView("1"!==this.curView.cardinality||this.model.isNew?this._prevMany||"list":this._prevOne||"view");break;case"export":alert("Sorry, no demo server yet...\n\n"+JSON.stringify(this.curView.val(),null,2));break;case"save":case"save-add":this.saveItem("save-add"===b)}},paginate:function(a,b){b&&(a=b.id);var c=this.pageIndex||0;if("prev"===a)c=c>0?c-1:0;else if("next"===a)(c+1)*this.options.pageSize<this.curView.collection.length&&c++;else{var d=parseInt(a,10);d>0&&(c=d-1)}this.pageIndex=c,this.curView.setPage&&this.curView.setPage(c)},status_update:function(a,b){this.setStatus(b)},_curCollec:function(){return this._filteredCollection?this._filteredCollection:this.collection?this.collection:this.model?this.model.collection:new this.options.collectionClass},click_toolbar:function(a){var b=$(a.currentTarget);"A"!==b.tagName&&(b=b.closest("a"));var c=b.data("id");switch(a.preventDefault(),a.stopImmediatePropagation(),c){case"save":this.saveItem(!1);break;case"del":this.deleteItem();break;case"customize":this.curView.customize();break;case"filter":this.toggleFilter();break;case"prev":case"next":"1"===this.curView.cardinality?this.browse(c):"n"===this.curView.cardinality&&this.paginate(c);break;case"new-field":Evol.Dico.showDesigner("","field",b);break;default:c&&""!==c&&this.setView(c,!0)}this.$el.trigger("toolbar."+c)},click_navigate:function(a,b){a.stopImmediatePropagation(),this.setModelById(b.id),this.setRoute(b.id,!1)},change_filter:function(){var a,b=this._filters.val();if(b.length){var c=Evol.Dico.filterModels(this.model.collection.models,b);a=this.collectionClass?new collectionClass(c):new Backbone.Collection(c),this._filteredCollection=a;var d=a.length,e=this.collection.length;this.setStatus(d+" / "+e+" "+this.uiModel.entities)}else a=this.collection,this._filteredCollection=null,this.setStatus(a.length+" "+this.uiModel.entities);this.curView.setCollection(a)}}),Evol.Shell=Backbone.View.extend({events:{},options:{elements:{nav:".evo-head-links",nav2:".evo-head-links2",content:"#evol"},useRouter:!0,pageSize:20},initialize:function(a){this.options=_.extend({},this.options,a),this.options.uiModels=_.flatten(this.options.uiModelsObj),this._tbs={};var b=this.options.elements;this.$nav2=$(b.nav2),this.setupRouter()},render:function(){return this.$nav2.html(this._HTMLentities(this.options.uiModels)),this},setupRouter:function(){var a=this,b=Backbone.Router.extend({routes:{"":"nav",":entity/:view/:id":"nav",":entity/:view":"nav",":entity":"nav","*noroute":a.noRoute},nav:function(b,c,d){b&&a.setEntity(b,c,d)}});this.router=new b,Backbone.history.start()},setRoute:function(a,b){var c=this._curEntity.curView;return c?Evol.Dico.setRoute(this.options.router,c.getTitle(),c.uiModel.id,c.viewName,a,b):alert("TODO: debug it"),this},noRoute:function(a){alert('invalid route "'+a+'".')},setEntity:function(a,b,c){function d(){e._ents[a].show().siblings().hide();var d=e._tbs[a];d&&(e._curEntity=d,d.setView(b).setTitle(),c&&("1"===d.curView.cardinality?(d.setModelById(c),e.setRoute(c,!1)):e.setRoute("",!1)))}var e=this;if(this._ents||(this._ents={}),this._ents[a])d();else{var f=$('<div data-eid="'+a+'"></div>');this._ents[a]=f,this.$el.children().hide(),this.$el.append(f),this.createEntity(f,this.options.uiModelsObj[a],[],b,c,d)}return this._curEntity!==a&&(this.$nav2.find(">li>a").removeClass("sel").filter('[data-id="'+a+'"]').addClass("sel"),this._curEntity=a),this},createEntity:function(a,b,c,d,e,f){var g=new Backbone.LocalStorage("evol-"+b.id),h=Backbone.Model.extend({localStorage:g}),i=Backbone.Collection.extend({model:h,localStorage:g}),j=this,k=new i;k.fetch({success:function(g){0===g.length&&Evol.UI.insertCollection(g,c);var l=k.models[0],m={el:a,mode:"one",model:l,modelClass:h,collection:k,collectionClass:i,uiModel:b,pageSize:20,titleSelector:"#title"};d&&(m.defaultView=d),j.options.useRouter&&(m.router=j.router);var n=new Evol.ViewToolbar(m).render();e&&"1"===n.cardinality&&n.setModelById(e),j._tbs[b.id]=n,f&&f(n)}})},_HTMLentities:function(a){var b=[];return _.each(a,function(a){b.push('<li><a href="#',a.id,'/list" data-id="',a.id,'">',a.entities,"</a></li>")}),b.join("")}});
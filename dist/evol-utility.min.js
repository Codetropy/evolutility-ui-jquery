/*   evol-utility 0.0.1 */

/*   (c) 2013 Olivier Giulieri */

var Evol=Evol||{};Evol.UI={version:"0.0.1",html:{trTableEnd:"</tr></table>",TdTrTableEnd:"</td></tr></table>",clearer:'<div class="clearfix"></div>',emptyOption:'<option value=""></option>'},icons:{customize:function(a,b){return['<i class="glyphicon glyphicon-wrench" data-id="',a,'" data-type="',b,'"></i>'].join("")}},styles:{success:"success",info:"info",warning:"warning",danger:"danger"},html_more:function(a){return['<a href="javascript:void(0)" class="evol-more">',a,"</a>"].join("")},fieldLabel:function(a,b){return['<div class="evol-field-label"><label for="',a,'">',b,"</label></div>"].join("")},fieldLabelSpan:function(a,b){return['<span class="evol-field-label"><label for="',a,'">',b,"</label></span>"].join("")},link:function(a,b,c){return['<a class="Field" href="',c,'" id="',a,'">',b,"</a>"].join("")},linkEmail:function(a,b,c){return EvoUI.link(a,b,c?"mailto:"+c:"")},inputText:function(a,b,c){var d=['<input class="form-control" type="text" id="',a,'" value="',b];return c&&(_.each(["min","max","maxlength","max-width","min-width","placeholder"],function(a){"undefined"!==c[a]&&d.push('" ',a,'="',c[a])}),_.each(["readonly"],function(a){var b=c[a];(b||"1"==b)&&d.push('" ',a,'="',a)})),d.push('" class="Field">'),d.join("")},inputTextInt:function(a,b){return['<input class="form-control" type="number" id="',a,'" value="',b,'" class="Field" maxlength="12">'].join("")},inputTextM:function(a,b,c,d){return['<textarea name="',a,'" id="',a,'" class="Field form-control"" rows="',d,c>0?'" onKeyUp="EvoVal.checkMaxLen(this,'+c+")":"",'">',b,"</textarea>"].join("")},inputTextMJSON:function(a,b,c){return['<textarea rows="',c,'" class="evol-json">',_.escape(JSON.stringify(b,null,"	")),"</textarea>"].join("")},inputAny:function(a,b,c){return['<input type="',a,'" id="',b,'" value="',c,'" class="Field form-control" size="15">'].join("")},inputDate:function(a,b){return EvoUI.inputAny("date",a,b)},inputDateTime:function(a,b){return EvoUI.inputAny("datetime-local",a,b)},inputTime:function(a,b){return EvoUI.inputAny("time",a,b)},inputColor:function(a,b){return['<input type="color" id="',a,'" value="',b,'" size="15">'].join("")},inputCheckbox:function(a,b){var c=['<input type="checkbox" id="',a,'"'];return null!==b&&""!==b&&"0"!==b&&c.push(' checked="checked"'),c.push(' value="1">'),c.join("")},inputCheckboxLOV:function(a){var b=[];for(var c in a){var d=a[c];b.push('<input type="checkbox" id="',d.id,'" value="',d.id,'"/>','<label for="',d.id,'">',d.text,"</label> ")}return b.join("")},inputRadio:function(a,b,c,d,e){return['<label for="',e,'"><input id="',e,'" name="',a,'" type="radio" value="',b,d?'" checked="checked':"",'">',c,"</label>&nbsp;"].join("")},inputLOV:function(a,b,c,d){var e=['<select class="form-control Field" id="',a,'"><option value="',b,'" selected>',c,"</option>"];return _.each(d,function(a){e.push(EvoUI.inputOption(a.id,a.text))}),e.push("</select>"),e.join("")},inputHidden:function(a,b){return['<input type="hidden" name="',a,'" id="',a,'" value="',b,'"/>'].join("")},inputSelectBegin:function(a,b,c){var d=['<select id="',a,'" class="form-control ',b,'">'];return c&&d.push(Evol.UI.html.emptyOption),d.join("")},inputOption:function(a,b){return['<option value="',a,'">',b,"</option>"].join("")},inputOptions:function(a){var b=[];return _.each(a,function(a){b.push(EvoUI.inputOption(a.id,a.text))}),b.join("")},inputButton:function(a,b,c){return'<button type="button" id="'+a+'" class="btn'+(c?" "+c:"")+'">'+b+"</button>"},inputToggle:function(a){var b=['<div class="btn-group" data-toggle="buttons">'];return _.each(a,function(a){b.push('<label class="btn btn-info"><input type="radio" name="options" id="',a.id,'">',a.text,"</label>")}),b.push("</div>"),b.join("")},icon:function(a,b){return['<span class="',b?b+" ":"","glyphicon glyphicon-",a,'"></span>'].join("")},HTMLPanelLabel:function(a){return['<div class="panel-heading">',EvoUI.icon("chevron-up","evol-title-toggle"),'<h3 class="panel-title">',a,"</h3></div>"].join("")},HTMLEmptyPanel:function(a,b,c){return'<div class="'+b+" panel panel-"+c+'" data-id="'+a+'"></div>'},HTMLMsg:function(a,b,c,d){return['<div data-id="msg" class="alert alert-',c||"info",d?' alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>':'">',"<strong>",a,"</strong> ",b,"</div>"].join("")},formatDate:function(a){return a.getMonth()+1+"/"+(a.getDate()+1)+"/"+a.getFullYear()},formatTime:function(a){return a.getHours()+":"+a.getMinutes()},getOrCreate:function(a,b){var c=b.find("#"+a);return 0===c.length&&($('<div id="'+a+'"></div>'),(b||$(body)).append(c),c=b.find("#"+a)),c},insertCollection:function(a,b){0===a.length&&_.each(b,function(b){a.create(b)})},capFirstLetter:function(a){return a&&a.length>0?a.substring(0,1).toUpperCase()+a.substring(1):""},trim:function(a){return a?a.replace(/^\s+|\s+$/g,""):""},setVisible:function(a,b){b?a.show():a.hide()}},Evol.UI.Charts={URL:"http://chart.apis.google.com/chart",_HTML:function(a,b){return['<div class="evol-chart-holder panel panel-info"><label class="evol-chart-title">',a,'</label><img src="',b,'"><br></div>'].join("")},Pie:function(a,b,c){var d=[EvoUI.Charts.URL,"?chd=t:",b.join(","),"&amp;chl=",c.join("|"),"&amp;cht=p&amp;chds=0,20&amp;chs=360x200"].join("");return EvoUI.Charts._HTML(a,d)},Bars:function(a,b,c){var d=_.max(b),e=[EvoUI.Charts.URL,"?chbh=a&amp;chs=350x200&cht=bvg&chco=3a87ad,d9edf7&chds=0,",d,"&amp;chd=t:",b.join("|"),"&amp;chp=0.05&amp;chts=676767,10.5&amp;chdl=",c.join("|")].join("");return EvoUI.Charts._HTML(a,e)}};var Evol=Evol||{};Evol.Dico={fieldTypes:{text:"text",txtm:"textmultiline",bool:"boolean",dec:"decimal",integer:"integer",date:"date",time:"time",datetime:"datetime",pix:"image",lov:"lov",email:"email",url:"url",pwd:"password",color:"color",hidden:"hidden",rating:"rating",tag:"tag"},fields:function(a,b){function c(a){a&&a.elements&&a.elements.length>0?_.each(a.elements,function(a){"panel-list"!=a.type&&c(a)}):d.push(a)}var d=[];return c(a),_.isFunction(b)&&(d=_.filter(d,b)),d},isTypeDateOrTime:function(a){return a==a==EvoDico.fieldTypes.datetime||EvoDico.fieldTypes.date||a==EvoDico.fieldTypes.time},showDesigner:function(a,b,c){var d,e=$('<div class="evol-des-'+b+'"></div>');switch(b){case"field":d=dico_field_ui}return c.closest(".evol-fld").after(e),vw=new Evol.ViewOne({model:null,uiModel:d,defaultView:"edit",el:e,style:"panel-primary",button_addAnother:!1}),e.on("click","button#save,button#cancel",function(){e.remove()}),this},showInfoBox:function(a,b){var c=this.$el.find(".evol-head-info");if(c.length)c.html(a);else{var d=['<div class="evol-head-info alert alert-',b,'">',EvoUI.iconClose(),a,"</div>"].join("");this.$el.prepend(d)}return this},bbComparator:function(a){return function(b){return b.get(a)}},bbComparatorText:function(a){return function(b,c){return(b.get(a)||"").localeCompare(c.get(a)||"")}}};var EvolLang={LOCALE:"EN",View:"View",Edit:"Edit",New:"New",NewItem:"New Item",NewUpload:"New Upload",NewSearch:"New Search",Selections:"Selections",Selection:"Selection",Export:"Export",SearchRes:"Search Result",Delete:"Delete",All:"All",DeleteEntity:"Delete this {0}?",Back2SearchResults:"Back to search results",validation:{intro:"You are not finished yet:",empty:'"{0}" must have a value.',email:'"{0}" must be a valid email.',integer:'"{0}" must only use numbers.',decimal:'"{0}" must be a valid decimal numbers.',date:'"{0}" must be a valid date, format must be "MM/DD/YYYY" like "12/24/2005".',datetime:'"{0}" must be a valid date/time, format must be "MM/DD/YYYY hh:mm am/pm" like "12/24/2005 10:30 am".',time:'"{0}" must be a valid date/time, format must be "hh:mm am/pm" like "10:30 am".',max:'"{0}" must be smaller or equal to {1}.',min:'"{0}" must be greater or equal to {1}.',reg:'"{0}" must match the regular expression pattern "{1}".'},"export":{ExportEntity:"Export this {0}",ExportHeader:"Header",ExportSeparator:"Separator",ExportFirstLine:"First line for field names",ExportFormat:"Export format",ExportFields:"Fields to include in the export",IDkey:"ID (Primary Key)",AllFields:"Show all fields",ExportFormats:"Comma separated (CSV, TXT, XLS...)-HTML-SQL Insert Statements (SQL)-Tab separated values (TXT)-XML-Javascript Object Notation (JSON)",xpXMLroot:"Element name",xpSQL:"SQL Options",xpSQLTable:"Table name",xpSQLTrans:"Inside transaction",xpSQLId:"Enable identity insert",DownloadEntity:"Download {0}"},Save:"Save",SaveAdd:"Save and Add Another",Cancel:"Cancel",NoChange:"No Change",NoX:"No {0}",nodata:"No data.",filters:{sEqual:"equals",sNotEqual:"not equal",sStart:"starts with",sContain:"contains",sFinish:"finishes with",sInList:"any of",sIsNull:"is empty",sIsNotNull:"is not empty",sBefore:"before",sAfter:"after",sNumEqual:"&#61;",sNumNotEqual:"!&#61;",sGreater:"&#62;",sSmaller:"&#60;",sOn:"on",sNotOn:"not on",sAt:"at",sNotAt:"not at",sBetween:"between",opAnd:"and",yes:"Yes",no:"No",bNewFilter:"New filter",bAddFilter:"Add filter",bUpdateFilter:"Update filter",bSubmit:"Submit",bCancel:"Cancel"}},Evol=Evol||{},EvoUI=Evol.UI,EvoDico=Evol.Dico;Evol.ViewMany=Backbone.View.extend({cardinality:"n",options:{style:"panel-info",pageSize:20,title:"#title",selectable:!0},events:{"click a.evol-nav-id":"click_navigate","click .evol-sort-icons > span":"click_sort","click .button.edit":"click_pagination","click .evol-field-label .glyphicon-wrench":"click_customize"},initialize:function(a){var b,c=this;this.options.mode=a.mode,this.options.uiModel=a.uiModel,this.collection?b=this.collection:this.model&&this.model.collection&&(b=this.model.collection),b&&b.on("change",function(){c.render()})},customize:function(){var a=this.$("th > span");return this._custOn?(a.find("i").remove(),this._custOn=!1):(a.append(EvoUI.icons.customize("id","field")),this._custOn=!0),this},render:function(){var a=[];return this.model&&this.model.collection&&this.model.collection.length>0?this.renderList(a,this.options.mode):a.push(EvoUI.HTMLMsg(EvolLang.nodata,"","info")),this._updateTitle(),this.$el.html(a.join("")),this},setModel:function(a){return this.model=a,this.render(),this},updateModel:function(){alert("updateModel")},_updateTitle:function(){},getFields:function(){if(!this._fields){this._fields=EvoDico.fields(this.options.uiModel,function(a){return a.viewmany}),this._fieldHash={};var a=this;_.each(this._fields,function(b){a._fieldHash[b.id]=b})}return this._fields},getField:function(a){return this._fieldHash[a]},_hashLov:{},_lovText:function(a,b){if("list"in a&&a.list.length>0){a.id in this._hashLov||(this._hashLov[a.id]={});var c=this._hashLov[a.id];if(b in c)return c[b];_.each(a.list,function(a){if(a.id==b){var d=a.text;return a.icon&&(d='<img src="'+a.icon+'"> '+d),c[b]=a.text,a.text}})}return""},_HTMLField:function(a,b){switch(a.type){case EvoDico.fieldTypes.bool:if("true"===b||"1"==b)return EvoUI.icon("ok");break;case EvoDico.fieldTypes.lov:if(""!==b)return this._lovText(a,b);break;case EvoDico.fieldTypes.date:case EvoDico.fieldTypes.time:case EvoDico.fieldTypes.datetime:if(""!==b){var c=new Date(b);if(_.isDate(c)){var d="";return a.type!=EvoDico.fieldTypes.time&&(d+=EvoUI.formatDate(c)),a.type==EvoDico.fieldTypes.datetime&&(d+=" "),a.type!=EvoDico.fieldTypes.date&&(d+=EvoUI.formatTime(c)),d}}break;default:return b}return""},_paginationSummaryHTML:function(a,b,c,d,e){var f,g=a*b+1;if(1>a){if(0===c)return c+" "+e;if(1===c)return c+" "+d;f=_.min([b,c])}else f=_.min([g+b,c]);return["<p>",g,"-",f," of ",c," ",e,"</p>"].join("")},_paginationHTML:function(a,b,c){var d=a*b+1,e=parseInt(c/b,10),f=e>5?5:e,g=['<ul class="pagination pagination-sm">'];a>0&&g.push('<li data-id="prev"><a href="#">&laquo;</a></li>');for(var h=d;f>h;h++)g.push('<li data-id="',h,'"><a href="#">',h,"</a></li>");return c>(a+1)*b&&g.push('<li data-id="next"><a href="#">&raquo;</a></li>'),g.push("</ul>"),g.join("")},sortList:function(a,b){var c=this.model.collection;c.comparator=a.type==EvoDico.fieldTypes.text||a.type==EvoDico.fieldTypes.txtm||a.type==EvoDico.fieldTypes.email?EvoDico.bbComparatorText(a.id):EvoDico.bbComparator(a.id),c.sort(),b&&c.models.reverse(),this.render(),this.$el.trigger("list.sort",{id:a.id,direction:b?"down":"up"})},click_navigate:function(a){var b=$(a.currentTarget),c="list"===this.options.mode?"tr":"div";a.type="list.navigate",this.$el.trigger(a,{id:b.closest(c).data("id")})},click_sort:function(a){var b=$(a.currentTarget),c=b.parent().data("fid"),d=this.getField(c),e=b.attr("class").indexOf("-down")>0;this.sortList(d,e),b.addClass("evol-last-sort")},click_pagination:function(a){this.$el.trigger("list.paginate",{id:$(a.currentTarget).closest("li").data("id")})},click_customize:function(a){var b=$(a.currentTarget),c=b.data("id"),d=b.data("type");EvoDico.showDesigner(c,d,b),this.$el.trigger(d+".customize",{id:c,type:d})}});var Evol=Evol||{},EvoUI=Evol.UI,EvoDico=Evol.Dico;Evol.ViewMany.Cards=Evol.ViewMany.extend({viewName:"cards",options:{style:"panel-info",pageSize:20,title:"#title",selectable:!0},customize:function(){var a=this.$("h4 > a.evol-nav-id");return this._custOn?(a.find("i").remove(),this._custOn=!1):(a.append(EvoUI.icons.customize("id","field")),this._custOn=!0),this},render:function(){var a=[];return this.model&&this.model.collection&&this.model.collection.length>0?this._render(a,this.options.mode):a.push(EvoUI.HTMLMsg(EvolLang.nodata,"","info")),this._updateTitle(),this.$el.html(a.join("")),this},_render:function(a,b){var c=this.options,d=c.uiModel,e=this.model.collection.models,f=c.pageSize||50,g=this._paginationSummaryHTML(0,f,e.length,d.entity,d.entities);a.push('<div class="evol-many-',b,'">'),this._HTMLcards(a,this.getFields(),f,d.icon),"charts"!=b&&a.push(g,this._paginationHTML(0,f,e.length)),a.push("</div>")},_HTMLcards:function(a,b,c,d){var e=this.model.collection.models,f=_.min([e.length,c]);if(f>0){for(var g=0;f>g;g++){a.push('<div class="panel ',this.options.style,'">');for(var h=0;h<b.length;h++){var i=b[h],j=e[g],k=j.get(i.id);a.push('<div data-id="',j.id,'">'),0===h?(a.push('<h4><a href="#" id="fg-',i.id,'" class="evol-nav-id">'),d&&a.push('<img class="evol-table-icon" src="pix/',d,'">'),a.push(this._HTMLField(i,k)),a.push("</a></h4>")):a.push(this._HTMLField(i,k)),a.push("</div>")}a.push("</div>")}a.push(EvoUI.html.clearer)}else a.push(EvoUI.HTMLMsg(EvolLang.nodata,"","info"))}});var Evol=Evol||{},EvoUI=Evol.UI,EvoDico=Evol.Dico;Evol.ViewMany.Charts=Evol.ViewMany.extend({viewName:"chart",options:{style:"panel-info",pageSize:20,title:"#title",selectable:!0},events:{"click .evol-field-label .glyphicon-wrench":"click_customize"},render:function(){var a=[];if(this.model&&this.model.collection&&this.model.collection.length>0){var b=this.options,c=b.uiModel,d=b.pageSize||50;a.push('<div class="evol-many-',this.viewName,'">'),this._HTMLcharts(a,this.getFields(),d,c.icon),a.push("</div>")}else a.push(EvoUI.HTMLMsg(EvolLang.nodata,"","info"));return this._updateTitle(),this.$el.html(a.join("")),this},_HTMLcharts:function(a){var b=this,c=this.options.uiModel,d=this.model,e=d.collection.models,f=EvoDico.fields(c,function(a){return a.type==EvoDico.fieldTypes.lov||a.type==EvoDico.fieldTypes.bool});_.each(f,function(d){var f=_.countBy(e,function(a){return a.get(d.id)}),g=f,h=[],i=[];for(var j in g){var k=g[j];h.push(k),EvoDico.isTypeDateOrTime(d)?i.push(b._lovText(d,j)+" ("+k+")"):d.type==EvoDico.fieldTypes.lov?i.push(b._lovText(d,j)+" ("+k+")"):i.push(j+" ("+k+")")}var l=EvoUI.capFirstLetter(c.entities);d.type==EvoDico.fieldTypes.lov?a.push(EvoUI.Charts.Pie(l+" by "+d.label,h,i)):a.push(EvoUI.Charts.Bars(l+": "+d.label,h,i))}),a.push(EvoUI.html.clearer)}});var Evol=Evol||{},EvoUI=Evol.UI,EvoDico=Evol.Dico;Evol.ViewMany.List=Evol.ViewMany.extend({viewName:"list",options:{style:"panel-info",pageSize:20,selectable:!0},render:function(){var a=[];return this.model&&this.model.collection&&this.model.collection.length>0?this._render(a,this.options.mode):a.push(EvoUI.HTMLMsg(EvolLang.nodata,"","info")),this._updateTitle(),this.$el.html(a.join("")),this},_render:function(a,b){var c=this.options,d=c.uiModel,e=this.model.collection.models,f=c.pageSize||50,g=this._paginationSummaryHTML(0,f,e.length,d.entity,d.entities);a.push('<div class="evol-many-',b,'">'),this["_HTML"+b.replace(/-/g,"_")](a,this.getFields(),f,d.icon),"charts"!=b&&a.push(g,this._paginationHTML(0,f,e.length)),a.push("</div>")},_HTMLlist:function(a,b,c,d){a.push('<div class="panel ',this.options.style,'">'),a.push('<table class="table table-bordered table-hover"><thead>');for(var e=0;e<b.length;e++)this._renderListHeader(a,b[e]);a.push("</thead><tbody>"),this._HTMLlistbody(a,b,c,d),a.push("</tbody></table></div>")},_HTMLlistbody:function(a,b,c,d){var e=this.model.collection.models,f=_.min([e.length,c]);if(f>0)for(var g=0;f>g;g++)this._HTMLlistrow(a,b,e[g],d)},_HTMLlistrow:function(a,b,c,d){a.push('<tr data-id="',c.cid,'">');for(var e=0;e<b.length;e++){var f=b[e],g=c.escape(f.id);a.push("<td>"),0===e&&(a.push('<a href="javascript:void(0)" id="fv-',f.id,'" class="evol-nav-id">'),d&&a.push('<img class="evol-table-icon" src="pix/',d,'">')),a.push(this._HTMLField(f,g)),0===e&&a.push("</a>"),a.push("</td>")}a.push("</tr>")},_renderListHeader:function(a,b){a.push('<th><span id="',b.id,'-lbl">',b.label,'<span class="evol-sort-icons" data-fid="',b.id,'">',EvoUI.icon("chevron-up"),EvoUI.icon("chevron-down"),"</span></span></th>")}});var Evol=Evol||{},EvoUI=Evol.UI,EvoDico=Evol.Dico;Evol.ViewOne=Backbone.View.extend({events:{"click .evol-buttons > button":"click_button","click .evol-title-toggle":"click_toggle","click ul.evol-tabs > li > a":"click_tab","click label > .glyphicon-question-sign":"click_help","click .evol-field-label .glyphicon-wrench":"click_customize"},cardinality:"1",options:{button_addAnother:!1,style:"panel-info",titleSelector:""},initialize:function(a){var b=this,c=a.mode;this.options.mode=c,this.options.uiModel=a.uiModel,this.collection=a.collection,this.model&&this.model.on("change",function(a){b.setModel(a)})},render:function(){var a=this.options.mode,b=[];return"json"===a?this.renderJSON(b,a):this.renderEdit(b,a),this.$el.html(b.join("")),this.setData(this.model),this._updateTitle(),this.custOn=!1,this},getFields:function(){if(!this._fields){this._fields=EvoDico.fields(this.options.uiModel,this.getFieldsCondition),this._fieldHash={};var a=this;_.each(this._fields,function(b){a._fieldHash[b.id]=b})}return this._fields},setModel:function(a){this.model=a,this.clearMessages(),this.setData(a)},setUIModel:function(a){this.options.uiModel=a;var b=this.getData();this.render().setData(b)},modelUpdate:function(a){var b=this;_.each(a.changed,function(a,c){b.setFieldValue(c,a)})},getData:function(){var a=this,b={},c=this.getFields();return _.each(c,function(c){b[c.id]=a.getFieldValue(c)}),b},setData:function(a){var b,c=this.getFields(),d=this,e="#"+d.prefix+"-";_.each(c,function(c){if(b=d.$(e+c.id),a)switch(c.type){case"boolean":b.prop("checked",a.get(c.id));break;default:b.val(a.get(c.id))}}),this._updateTitle()},_updateTitle:function(){},clear:function(){var a,b=this.getFields(),c=this,d="#"+c.prefix+"-";return this.clearMessages(),_.each(b,function(b){switch(a=c.$(d+b.id),b.type){case"boolean":a.prop("checked",b.defaultvalue||"");break;default:a.val(b.defaultvalue||"")}}),this},setFieldValue:function(a,b){return this.$("#"+this.fieldViewId(a)).val(b),this},getFieldValue:function(a){var b=this.$("#"+this.prefix+"-"+a.id);switch(a.type){case EvoDico.fieldTypes.bool:return b.prop("checked");default:return b.val()}},showTab:function(a){var b=this.$(a);return b.length>0&&(b.siblings(".tab-pane").hide(),b.show()),b=this.$('.evol-tabs > li a[href="'+a+'"]').parent(),b.length>0&&(b.siblings("li").removeClass("active"),b.addClass("active")),this.$el.trigger("tab.show"),this},_renderButtons:function(a,b){a.push(EvoUI.html.clearer,'<div class="evol-buttons">',EvoUI.inputButton("cancel",EvolLang.Cancel,"btn-default"),EvoUI.inputButton("save",EvolLang.Save,"btn-primary")),this.options.button_addAnother&&"json"!==b&&a.push(EvoUI.inputButton("save-add",EvolLang.SaveAdd,"btn-default")),a.push("</div>")},renderEdit:function(a,b){var c=-1,d=-1,e=this.options,f=e.uiModel.elements;if("mini"===b){var g=EvoDico.fields(e.uiModel,function(a){return a.searchlist||a.required||a.mini},e.mode),h={type:"panel","class":"evo-mini-holder",label:EvoUI.capFirstLetter(e.uiModel.entity),width:100,elements:g};this.renderPanel(a,h,"evo-one-mini",b)}else{a.push('<div class="evo-one-',b,'">');for(var i=0,j=f.length;j>i;i++){var k=f[i];switch(k.type){case"tab":d>0&&(a.push("</div>"),d=-1),0>c&&(a.push(EvoUI.html.clearer),this.renderTabs(a,f),a.push('<div class="tab-content">')),c++,a.push('<div id="evol-tab-',i,'" class="tab-pane',1===i?' active">':'">'),this.renderTab(a,k,b),c==j-1&&a.push("</div>");break;case"panel":0>d&&(a.push('<div class="evol-pnls">'),d=1),this.renderPanel(a,k,"pe-"+i,b);break;case"panel-list":0>d&&(a.push(""),d=1),this.renderPanelList(a,k,"pe-"+i,b)}}d>0&&a.push("</div>"),a.push("</div>")}this._renderButtons(a,b),this._updateTitle()},renderTabs:function(a,b){var c=!0;a.push('<ul class="nav nav-tabs evol-tabs">'),_.each(b,function(b,d){"tab"==b.type&&(c?(a.push('<li class="active">'),c=!1):a.push("<li>"),a.push('<a href="#evol-tab-',d,'">',b.label,"</a></li>"))}),a.push("</ul>")},renderTab:function(a,b,c){var d=this;a.push('<div class="evol-pnls">'),_.each(b.elements,function(b,e){"panel-list"===b.type?d.renderPanelList(a,b,"pl-"+e,c):d.renderPanel(a,b,"pl-"+e,c)}),a.push(EvoUI.html.clearer,"</div></div>")},renderPanel:function(a,b,c,d){var e=this;"mini"===d?(a.push('<div data-p-width="',b.width,'" class="w-100 evol-pnl ',b.class||"",'">','<div class="panel ',this.options.style,'">',EvoUI.HTMLPanelLabel(b.label,c,"PanelLabel"),'<fieldset data-pid="',c,'">'),_.each(b.elements,function(b){a.push('<div class="pull-left evol-fld w-100">'),e.renderField(a,b,d),a.push("</div>")})):(a.push('<div style="width:',b.width,'%" data-p-width="',b.width,'" class="pull-left evol-pnl">','<div class="panel ',this.options.style,'">',EvoUI.HTMLPanelLabel(b.label,c,"PanelLabel"),'<fieldset data-pid="',c,'">'),_.each(b.elements,function(b){a.push('<div style="width:',parseInt(b.width,10),'%" class="pull-left evol-fld">'),e.renderField(a,b,d),a.push("</div>")})),a.push("</fieldset></div></div>")},renderPanelList:function(a,b,c){a.push('<div style="width:',b.width,'%" class="pull-left evol-pnl">','<div class="panel ',this.options.style,'">',EvoUI.HTMLPanelLabel(b.label,c,"PanelLabel"),'<table width="100%" class="table-striped"><tr>'),_.each(b.elements,function(b){a.push("<th>",b.label,"</th>")}),a.push("</tr><tr>"),_.each(b.elements,function(b){a.push("<td>",b.label,"</td>")}),a.push("</tr></table></div></div>")},renderField:function(a,b,c){function d(a){return a.toLocaleLowerCase().replace(/ /g,"_").replace(/\(/g,"").replace(/\)/g,"")}var e,f,g,h=EvoDico.fieldTypes;if(b.id&&""!==b.id?e=b.id:(e=d(b.label),b.id=e),this.model&&this.model.has(e)&&(f="new"!=c?this.model.get(e):b.defaultvalue?b.defaultvalue:""),e=this.fieldViewId(e),"mini"===c?(g=b.width,b.width=100,a.push('<div class="evo-mini-label">'),this.renderFieldLabel(a,b,c),a.push('</div><div class="evo-mini-content">')):this.renderFieldLabel(a,b,c),b.readonly>0)a.push('<div id="',e,'" class="FieldReadOnly">',f,"&nbsp;</div>");else switch(b.type){case h.text:a.push(EvoUI.inputText(e,f,b));break;case h.email:"view"===c?a.push(EvoUI.link(e,f,"mailto:"+HttpUtility.HtmlEncode(f))):a.push(EvoUI.inputText(e,f,b.maxlength));break;case h.url:"view"===c?a.push(EvoUI.link(e,f,HttpUtility.HtmlEncode(f))):a.push(EvoUI.inputText(e,f,b.maxlength));break;case h.integer:case h.dec:a.push(EvoUI.inputTextInt(e,f));break;case h.bool:a.push(EvoUI.inputCheckbox(e,f));break;case h.txtm:case h.html:null===b.height?b.height=5:(fHeight=parseInt(b.height,10),1>fHeight&&(b.height=5)),a.push(EvoUI.inputTextM(e,f,b.maxlength,b.height));break;case h.date:a.push(EvoUI.inputDate(e,f));break;case h.datetime:a.push(EvoUI.inputDateTime(e,f));break;case h.time:a.push(EvoUI.inputTime(e,f));break;case h.color:a.push(EvoUI.inputColor(e,f));break;case h.lov:a.push(EvoUI.inputLOV(e,f,"",b.list||[]));break;case h.integer:a.push(EvoUI.inputTextInt(e,f,b.type,b.max,b.min));break;case h.pix:""===f?a.push('<p class="">No picture</p>'):a.push('<img src="',f,'" class="img-thumbnail">')}"mini"===c&&(a.push("</div>"),b.width=g)},renderFieldLabel:function(a,b,c){a.push('<div class="evol-field-label" id="',b.id,'-lbl"><label class="control-label" for="',b.id,'">',b.label),"view"!=c&&b.required>0&&a.push('<span class="evol-required">*</span>'),b.help&&""!==b.help&&a.push(EvoUI.icon("question-sign","")),a.push("</label></div>")},validate:function(){var a=this.getFields();return this.clearMessages(),_.isArray(a)?(this.$el.trigger("view.validate"),EvoVal.checkFields(this.$el,a,this.prefix)):!1},clearErrors:function(){return this.$(".control-group.error").removeClass("control-group error"),this.$(".has-error").removeClass("has-error"),this.$(".text-danger").remove(),this},commit:function(a,b){var c=this.validate();if(""===c)if("new"===this.options.mode){var d;this.model&&this.model.collection?d=this.model.collection:this.collection&&(d=this.collection),d?d.create(this.getData(),{success:a,error:b}):alert("No collection specified")}else this.model.set(this.getData()),this.model.save({success:a,error:b});else this.setMessage("Invalid data",c,"warning");return this},fieldViewId:function(a){return this.prefix+"-"+a},customize:function(){var a=".evol-field-label > label",b=".evol-pnl .panel-title";return this.custOn?(this.$(a+" > i, "+b+" > i").remove(),this.custOn=!1):(_.each(this.$(a),function(a){var b=$(a),c=b.attr("for");b.append(EvoUI.icons.customize(c,"field"))}),this.$(b).append(EvoUI.icons.customize("id","panel")),this.custOn=!0),this},showHelp:function(a,b,c){var d=EvoDico.fields(this.options.uiModel),e=_.findWhere(d,{id:a});if(e||e.help){var f=c.closest(".evol-fld"),g=f.find(".help-block");if(g.length>0)g.slideUp(300,function(){g.remove()});else{var h=$('<span class="help-block">'+_.escape(e.help)+"</span>").hide();f.append(h),h.slideDown(300)}}return this},setMessage:function(a,b,c){var d=this.$('[data-id="msg"]');d.length?d.html("<strong>"+a+"</strong>"+b):this.$el.prepend(EvoUI.HTMLMsg(a,b,c))},clearMessage:function(){var a=this.$('[data-id="msg"]').fadeOut(300,function(){a.remove()})},clearMessages:function(){return this.clearErrors().clearMessage()},click_button:function(a){{var b=this;$(a.currentTarget).attr("id")}a.stopImmediatePropagation(),this.commit(function(){b.setMessage("Record Saved","Record was saved.","success")},function(){alert("error")})},click_toggle:function(a){var b=$(a.target),c=b.closest(".panel-heading").next(),d=c.data("expState");a.preventDefault(),a.stopImmediatePropagation(),a.shiftKey?(b=this.$(".evol-title-toggle"),b="down"===d?this.$(".evol-title-toggle.glyphicon-chevron-down").trigger("click"):this.$(".evol-title-toggle.glyphicon-chevron-up").trigger("click")):"down"===d?(b.closest(".panel").css("height",""),c.slideDown(400).data("expState","up"),b.addClass("glyphicon-chevron-up").removeClass("glyphicon-chevron-down")):(c.slideUp(400,function(){b.closest(".panel").css("height","40px")}).data("expState","down"),b.removeClass("glyphicon-chevron-up").addClass("glyphicon-chevron-down")),this.$el.trigger("panel.toggle")},click_tab:function(a){var b=a.target.href,c=b.substring(b.indexOf("#"));a.stopImmediatePropagation(),a.preventDefault(),a.shiftKey?this.$(".tab-content > div").show():this.showTab(c)},click_help:function(a){var b=$(a.currentTarget),c=b.closest("label").attr("for"),d=b.data("type");a.stopImmediatePropagation(),this.showHelp(c,d,b),this.$el.trigger(d+".help",{id:c})},click_customize:function(a){var b=$(a.currentTarget),c=b.data("id"),d=b.data("type");a.stopImmediatePropagation(),EvoDico.showDesigner(c,d,b),this.$el.trigger(d+".customize",{id:c,type:d})}});var EvoVal={checkMaxLen:function(a,b){a.value.length>b&&(a.value=a.value.substring(0,b-1))},checkNum:function(a,b){var c,d=a.value;if("i"==b.substring(0,1))c=parseInt(d,10);else{var e=EvolLang.LOCALE;("FR"==e||"DA"==e)&&(d=d.replace(",",".")),c=parseFloat(d)}isNaN(c)?a.value="":d!=c&&(a.value=c)},setValidationFlags:function(a,b){var c=a.find(".text-danger");c.length?c.html(b):a.append('<p class="text-danger">'+b+"</p>"),a.addClass("has-error")},checkFields:function(a,b,c){function d(){var a=EvoDico.fieldTypes,b=EvoUI.trim(l.val());if(""!==b)switch(k.type){case a.integer:case a.email:h[k.type].test(b)||EvoVal.setValidationFlags(l.parent(),g(EvolLang[k.type]));break;case a.dec:var c=h[k.type+EvolLang.LOCALE];null===c&&(c=h[k.type+"EN"]),c.test(b)||EvoVal.setValidationFlags(l.parent(),g(EvolLang[k.type]));break;case a.date:case a.datetime:""===b||_.isDate(new Date(b))||EvoVal.setValidationFlags(l.parent(),g(EvolLang[k.type]))}}function e(a){var b,c=a.tagName;return b="SELECT"==c&&a.get(0).selectedIndex>-1?"0"==f.options[a.get(0).selectedIndex].value:""===EvoUI.trim(a.val())}function g(a,b){var c=a.replace("{0}",k.label);return null!==b&&(c=c.replace("{1}",b)),i.push(c),c}var h={email:/^[\w\.\-]+@[\w\.\-]+\.[\w\.\-]+$/,integer:/^-?\d+$/,decimalEN:/^\d+(\.\d+)?$/,decimalFR:/^\d+(\,\d+)?$/,decimalDA:/^\d+(\,\d+)?$/},i=[];for(var j in b){var k=b[j],l=a.find("#"+c+"-"+k.id).eq(0),m="html"==k.type;if(m&&l.val(nicEditors.findEditor(f.id).getContent()),l.length>0){var n,o,p=!0;if(k.required>0?e(l,m)?(n=l.parent(),o=g(EvolLang.validation.empty),EvoVal.setValidationFlags(n,o),p=!1):(l.parent().removeClass("control-group error").find(".evol-warn-error").remove(),d()):d(),null!==k.rg&&void 0!==k.rg){var q=new RegExp(k.rg);l.val().match(q)||(n=l.parent(),o=g(EvolLang.validation.reg,k.rg),EvoVal.setValidationFlags(l.parent(),o))}if(p){var r=EvoUI.trim(l.val());""!==r&&(null!==k.max&&parseFloat(r)>k.max&&EvoVal.setValidationFlags(l.parent(),g(EvolLang.validation.max,k.max)),null!==k.min&&parseFloat(r)<k.min&&EvoVal.setValidationFlags(l.parent(),g(EvolLang.validation.min,k.min)))}}}return i.length>0?[EvolLang.validation.intro,"<ul><li>",i.join("<li>"),"</li></ul>"].join(""):""}},Evol=Evol||{},EvoUI=Evol.UI,EvoDico=Evol.Dico;Evol.ViewOne.Edit=Evol.ViewOne.extend({viewName:"edit",prefix:"oe",render:function(){var a=[];return this.renderEdit(a,"edit"),this.$el.html(a.join("")),this.setData(this.model),this._updateTitle(),this.custOn=!1,this},renderEdit:function(a){var b=-1,c=-1,d=this.options,e=d.uiModel.elements,f="edit";a.push('<div class="evo-one-',f,'">');for(var g=0,h=e.length;h>g;g++){var i=e[g];switch(i.type){case"tab":c>0&&(a.push("</div>"),c=-1),0>b&&(a.push(EvoUI.html.clearer),this.renderTabs(a,e),a.push('<div class="tab-content">')),b++,a.push('<div id="evol-tab-',g,'" class="tab-pane',1===g?' active">':'">'),this.renderTab(a,i,f),b==h-1&&a.push("</div>");break;case"panel":0>c&&(a.push('<div class="evol-pnls">'),c=1),this.renderPanel(a,i,"pe-"+g,f);break;case"panel-list":0>c&&(a.push(""),c=1),this.renderPanelList(a,i,"pe-"+g,f)}}c>0&&a.push("</div>"),a.push("</div>"),this._renderButtons(a,f),this._updateTitle()}});var Evol=Evol||{},EvoUI=Evol.UI,EvoDico=Evol.Dico;Evol.ViewOne.JSON=Evol.ViewOne.extend({events:{"click > .evol-buttons > button":"click_button","click .evol-title-toggle":"click_toggle","click .evol-field-label .glyphicon-wrench":"click_customize"},viewName:"json",prefix:"oj",render:function(){var a=[];if(this.model){var b=JSON.stringify(this.model.toJSON(),null,2);a.push(EvoUI.inputTextMJSON("",b,10))}return this._renderButtons(a,"json"),this.$el.html(a.join("")),this.setData(this.model),this._updateTitle(),this.custOn=!1,this},getData:function(){var a=this.$el.children("textarea").val();return $.parseJSON(a)},setData:function(a){var b=this;"#"+b.prefix+"-",this.$el.children("textarea").val(JSON.stringify(a,null,2)),this._updateTitle()},clear:function(){return this.$el.children("textarea").val(""),this}});var Evol=Evol||{},EvoUI=Evol.UI,EvoDico=Evol.Dico;Evol.ViewOne.Mini=Evol.ViewOne.extend({events:{"click > .evol-buttons > button":"click_button","click .evol-title-toggle":"click_toggle","click label > .glyphicon-question-sign":"click_help"},viewName:"mini",prefix:"om",getFieldsCondition:function(a){return a.required||a.viewmany||a.viewmini
},render:function(){var a=this.options.mode,b=[];return this.renderEdit(b,a),this.$el.html(b.join("")),this.setData(this.model),this._updateTitle(),this.custOn=!1,this},renderEdit:function(a,b){var c=this.options,d=this.getFields(),e={type:"panel","class":"evo-mini-holder",label:EvoUI.capFirstLetter(c.uiModel.entity),width:100,elements:d};this.renderPanel(a,e,"evo-one-mini",b),this._renderButtons(a,b),this._updateTitle()}});var Evol=Evol||{},EvoUI=Evol.UI,EvoDico=Evol.Dico;Evol.ViewToolbar=Backbone.View.extend({events:{"click .nav a":"click_toolbar","list.navigate div":"click_navigate"},options:{toolbar:!0,defaultView:"list",style:"normal",buttons:{edit:!0,mini:!0,json:!0,list:!0,cards:!0,charts:!0,"new":!0,del:!0,filter:!0,"export":!0,group:!0,customize:!0}},modesHash:{edit:"Edit",mini:"Mini",json:"JSON",cards:"Cards",list:"List",charts:"Charts"},views:[],viewsHash:{},curView:null,curViewName:"",initialize:function(a){var b=this.options;b.mode=a.mode,b.uiModel=a.uiModel,b.defaultView=a.defaultView,this.collection=a.collection,this.render(),this.$('[data-cid="views"] > li').tooltip(),this.$(".dropdown-toggle").dropdown()},render:function(){var a=this.$el;a.html(this._toolbarHTML()),this.setView(this.options.defaultView||"list")},_toolbarHTML:function(){function a(a,b,d,e,f){c.push('<li data-id="',a,'"'),e&&c.push(' data-cardi="'+e,'"'),f&&""!==f&&c.push(' data-toggle="tooltip" data-placement="bottom" title="" data-original-title="',f,'"'),c.push('><a href="#" data-id="',a,'">',EvoUI.icon(d)),b&&""!==b&&c.push("&nbsp;",b),c.push("</a></li>")}function b(b,c,e,f,g){d.buttons&&d.buttons[b]&&a(b,c,e,f,g)}var c=[],d=this.options;return endMenu="</ul></li>",menuDevider='<li role="presentation" class="divider"></li>',c.push('<div class="evo-toolbar"><ul class="nav nav-pills pull-left" data-cid="main">'),b("list",EvolLang.All,"th-list"),b("new",EvolLang.New,"plus"),b("del",EvolLang.Delete,"trash","1"),d&&(a("prev","","chevron-left","1"),a("next","","chevron-right","1"),c.push('</ul><ul class="nav nav-pills pull-right" data-cid="views">'),b("list","","th-list","n","List"),b("cards","","th-large","n","Cards"),b("charts","","stats","n","Charts"),b("edit","","th","1","All Fields"),b("mini","","th-large","1","Important Fields only"),b("json","","barcode","1","JSON")),c.push("</ul>",EvoUI.html.clearer,"</div>"),c.join("")},updateModel:function(){this.refresh()},refresh:function(){return this.viewsHash.list&&this.viewsHash.list.render(),this.viewsHash.cards&&this.viewsHash.cards.render(),this},setView:function(a){var b,c=this.$el,d="evolw-"+a,e=this.$('[data-vid="'+d+'"]'),f=this.curView;if("new"===a)a=this._prevOne?this._prevOne:"edit",this.setView(a),this._isNew=!0,this.curView.clear(),this.curView.options.mode="new";else{if(this._isNew=!1,e.length)this.curView=this.viewsHash[a],this.isNew||this.curView.setModel(this.model),this.$('[data-cid="views"] > li').removeClass("evo-sel").filter('[data-id="'+a+'"]').addClass("evo-sel"),e.show().siblings().not(".evo-toolbar,.evo-filters,.clearfix").hide();else{switch(e=$('<div data-vid="evolw-'+a+'"></div>'),c.children().not(".evo-toolbar,.evo-filters,.clearfix").hide(),c.append(e),b={el:e,mode:a,model:this.model,collection:this.collection,uiModel:this.options.uiModel},this.$('[data-id="new"]').show(),this.$('[data-cid="views"] > li').removeClass("evo-sel").filter('[data-id="'+a+'"]').addClass("evo-sel"),a){case"edit":case"mini":case"json":f=new Evol.ViewOne[this.modesHash[a]](b).render(),this._prevOne=a;break;case"charts":case"cards":case"list":f=new Evol.ViewMany[this.modesHash[a]](b).render(),this._prevMany=a;break;case"export":f=new Evol.ViewExport(b)}this.curView=f,this.curViewName=a,this.viewsHash[a]=f}this.curView.options.mode=a}return this.setToolbar(a,this._isNew),this},getToolbarButtons:function(){if(!this._toolbarButtons){var a=this.$("li");this._toolbarButtons={ones:a.filter('[data-cardi="1"]'),manys:a.filter('li[data-cardi="n"]'),prevNext:this.$('[data-id="prev"],[data-id="next"]'),customize:this.$('a[data-id="customize"]').parent()}}return this._toolbarButtons},setToolbar:function(a){function b(a,b){EvoUI.setVisible(c.ones,a),EvoUI.setVisible(c.manys,b)}if(this.$el){var c=this.getToolbarButtons();EvoUI.setVisible(c.customize,"json"!=a),c.prevNext.hide(),this._isNew||"export"===a?b(!1,!1):"cards"===a||"list"===a||"charts"===a?(this._prevMany=a,b(!1,!0)):(this._prevOne=a,b(!0,!1),c.prevNext.show()),"cards"===a?c.manys.filter('[data-id="group"]').show():c.manys.filter('[data-id="group"]').hide()}},setData:function(a){return this.curView&&this.curView.setData(a),this},getData:function(){return this.curView?this.curView.getData():null},browse:function(a){var b=this.curView.model;if(this.model&&this.model.collection&&this.model.collection.length){var c=this.model.collection,d=c.length-1,e=_.indexOf(c.models,b);e="prev"===a?e>0?e-1:d:d>e?e+1:0,b=c.models[e]}else b=null;return this.model=b,this.curView.setModel(b),this},click_toolbar:function(a){var b=this,c=$(a.target);"A"!==c.tagName&&(c=c.closest("a"));var d=c.data("id");switch(a.preventDefault(),a.stopImmediatePropagation(),d){case"del":if(confirm("Are you sure you want to delete this record?")){var e=this.curView.model,f=e.collection.at(0);this.model=f,b.curView.setModel(f),e.destroy({success:function(){b.curView.setMessage("Record Deleted","Record was removed.","success")},error:function(){alert("error")}})}break;case"customize":this.curView.customize();break;case"group":this.showGroup();break;case"filter":this.showFilter();break;case"prev":case"next":this.browse(d);break;case"new-field":case"new-panel":EvoDico.showDesigner("id","field",c);break;default:d&&""!==d&&this.setView(d)}a.stopImmediatePropagation(),this.$el.trigger("toolbar."+d)},click_navigate:function(a,b){var c=this.model.collection.get(b.id);this.model=c,this.setView(this._prevOne||"edit"),this.curView.model=c,this.curView.render(),a.stopImmediatePropagation()}});var Evol=Evol||{},EvoUI=Evol.UI,EvoDico=Evol.Dico,evoLangXpt=EvolLang.export;Evol.ViewExport=Backbone.View.extend({version:"0.0.1",events:{"change select.evol-xpt-format":"click_format","change input":"click_preview","click .evol-more":"click_toggle_sel","click #XP":"click_submit"},options:{toolbar:!0,cardinality:"one",model:null,uiModel:null,defaultView:"list",style:"normal",prefix:"tbr"},many:!0,viewName:"export",initialize:function(a){this.options.fields=a.fields,this.options.uiModel=a.uiModel,this.options.prefix=a.prefix,this.render();var b=this.$el;return b.addClass("Panel"),this._preview("CSV"),this},render:function(){return this.$el.html(this._renderHTML()),this._preview("CSV"),this},_renderHTML:function(){var a=[],b=this.options,c=b.prefix||"",d=this.getFields();a.push('<table class="evol-xpt-form"><tr><td class="evol-xpt-flds"><fieldset>'),a.push('<div class="evol-id">',EvoUI.fieldLabel("",evoLangXpt.ExportFields),EvoUI.inputCheckbox("showID","1"),'<label for="showID">',evoLangXpt.IDkey,"</label>","</div>");for(var e=0,f=d.length;f>e;e++){var g=d[e],h=g.label,i="fx-"+g.id;(null===h||""===h)&&(h="("+i+")"),a.push('<div><input type="checkbox" value="1" id="',i,'" checked="true"><label class="checkbox" for="',i,'">',h,"</label></div>"),12==e&&f>16&&a.push(EvoExport.html_more2(evoLangXpt.AllFields))}f>16&&a.push("</div>"),a.push('</fieldset></td><td class="evol-xpt-para">');var j=c+"evol-xpt-format",k=evoLangXpt.ExportFormats.split("-");return a.push('<label for="',j,'">',evoLangXpt.ExportFormat,"</label>"),a.push(EvoUI.inputSelectBegin(j,"evol-xpt-format"),EvoUI.inputOption("CSV",k[0]),EvoUI.inputOption("TAB",k[3]),EvoUI.inputOption("HTML",k[1]),EvoUI.inputOption("JSON",k[5]),EvoUI.inputOption("SQL",k[2]),EvoUI.inputOption("XML",k[4]),"</select>"),a.push('<div class="evol-xpt-opts">'),j=c+"FLH",a.push('<div class="evol-FLH clearfix">'),a.push(EvoUI.inputCheckbox(j,!0),EvoUI.fieldLabelSpan(j,evoLangXpt.ExportFirstLine)),a.push('</div><div id="',c,'CSV">'),a.push('<div id="',c,'csv2" class="evol-w120">',EvoExport.html_more2("options"),EvoUI.fieldLabel("FLS_evol",evoLangXpt.ExportSeparator),EvoUI.inputText("FLS_evol",",",0),"</div></div>"),a.push("</div>"),_.each(["XML","HTML","SQL","JSON"],function(b){a.push('<div id="',c,b,'" style="display:none;"></div>')}),a.push("</div>"),a.push('<label>Export Preview</label><div class="evol-xpt-preview"></div>'),a.push("</td></tr></table>"),a.push('<div class="evol-buttons form-actions">'),a.push('<input class="btn btn-primary" id="XP" type="submit" value="',evoLangXpt.DownloadEntity.replace("{0}",this.options.uiModel.entities),'">'),a.push("</div>"),a.join("")},showFormatOpts:function(a){var b="#"+(this.prefix||"");switch(this.$el,a){case"TAB":a="CSV",this.$("#csv2").hide();break;case"CSV":this.$("#csv2").show();break;case"HTML":case"XML":case"SQL":case"JSON":var c=this.$(b+a);""===c.html()&&c.html(EvoExport["form"+a](this.options.uiModel.entity))}var d=this.$(b+a).show().siblings().hide(),e=d.filter(".evol-FLH");"TAB"===a||"CSV"===a?e.show():e.hide(),EvoExport.cFormat=a},getFields:function(){var a=this.options;return this.fields||(this.fields=EvoDico.fields(a.uiModel,a.fnFilter,a.mode)),this.fields},_preview:function(a){var b=this.model.collection.models,c=this.getFields(),d=['<textarea class="Field evol-xpt-val form-control">'],e=this.$(".evol-xpt-flds > fieldset input:checked"),f={};switch(_.each(e,function(a){f[a.id.substring(3)]=""}),c=_.filter(c,function(a){return a.id&&_.has(f,a.id)?!0:void 0}),a){case"CSV":case"TAB":case"TXT":var g=c.length-1,h=this.$("#FLS_evol").val().trim(),i=this.$("#FLH").prop("checked");"TAB"==a&&(h="&#09;"),i&&(_.each(c,function(a,b){d.push(a.label),g>b&&d.push(h)}),d.push("\n")),_.each(b,function(a){_.each(c,function(b,c){var e=a.get(b.id);e&&d.push(e),g>c&&d.push(h)}),d.push("\n")}),d.push("\n");break;case"HTML":d.push("<table>\n<tr>"),_.each(c,function(a){d.push("<th>",a.id,"</th>")}),d.push("</tr>\n"),_.each(b,function(a){d.push("<tr>"),_.each(c,function(b){var c=a.get(b.id);c?d.push("<td>",c,"</td>"):d.push("<td></td>")}),d.push("</tr>\n")}),d.push("</table>");break;case"JSON":d.push(JSON.stringify(this.model.toJSON(),null,2));break;case"SQL":var j=c.length-1,k=this.$("#evoxpTRS1").prop("checked"),l=this.$("#evoxpTRS2").prop("checked"),m=this.$("#evoTable").val().replace(/ /g,"_"),n=["INSERT INTO ",m," ("];_.each(c,function(a,b){n.push(a.id),j>b&&n.push(", ")}),n.push(")\n VALUES ("),n=n.join(""),k&&d.push("BEGIN TRANSACTION\n"),l&&d.push("SET IDENTITY_INSERT ",m," ON;\n");for(var o=0,p=b.length;p>o;o++){d.push(n);for(var q=b[o],r=0,s=c.length;s>r;r++){var t=q.get(c[r].id);d.push('"',t,'"'),j>r&&d.push(", ")}d.push(");\n")}l&&d.push("SET IDENTITY_INSERT ",m," OFF;\n"),k&&d.push("COMMIT TRANSACTION\n");break;case"XML":var u=this.$("#evoRoot").val();d.push("<xml>\n"),_.each(b,function(a){d.push("<",u," "),_.each(c,function(b){d.push(b.id,'="',a.get(b.id),'" ')}),d.push("></",u,">\n")}),d.push("</xml>")}d.push("</textarea>"),this.$(".evol-xpt-preview").html(d.join(""))},val:function(a){return"undefined"==typeof a?this._getValue():(this._setValue(a),this)},_ValFields:function(){for(var a=[],b=this.$(".evol-xpt-flds input:checked").not("#showID"),c=0,d=b.length;d>c;c++){var e=$(b[c]);a.push(e.attr("id"))}return a},_getValue:function(){var a={format:this._bFormat.val(),fields:this._ValFields(),options:{}},b=this.$(".evol-xpt-para input"),c=b.eq(0),d="undefined"!==c.attr("checked");return a.options[c.attr("id")]=d,a},click_format:function(){var a=this.$(".evol-xpt-format").val();"XML"===a?(this.$("#XML").html(EvoExport.formXML(this.options.uiModel.entity)).show().siblings().not(".evol-FLH").hide(),EvoExport.cFormat="XML"):this.showFormatOpts(a),this._preview(a),this.$el.trigger("change.export","format",a)},click_preview:function(){var a=this.$(".evol-xpt-format").val();this._preview(a)},click_toggle_sel:function(a){$(a.currentTarget).hide().next().slideDown()},click_submit:function(){this.$el.trigger("submit.export")}});var EvoExport={cFormat:"CSV",html_more2:function(a){return['<a href="javascript:void(0)" class="evol-more">',a,'</a><div class="evol-more-content">'].join("")},formHTML:function(){return""},formXML:function(a){var b="evoxpC2X";return[EvoExport.html_more2("options"),EvoExport.formEntityName("evoRoot",evoLangXpt.xpXMLroot,a),EvoUI.fieldLabel(b,evoLangXpt.xpColMap),"</div>"].join("")},formJSON:function(){return""},formSQL:function(a){return[EvoExport.html_more2("options"),EvoExport.formEntityName("evoTable",evoLangXpt.xpSQLTable,a),"<div>",EvoUI.inputCheckbox("evoxpTRS2","0"),EvoUI.fieldLabelSpan("evoxpTRS2",evoLangXpt.xpSQLId),"</div>","<div>",EvoUI.inputCheckbox("evoxpTRS1","0"),EvoUI.fieldLabelSpan("evoxpTRS1",evoLangXpt.xpSQLTrans),"</div>","</div>"].join("")},formEntityName:function(a,b,c){return[EvoUI.fieldLabel(a,b),EvoUI.inputText(a,c.replace(" ","_"),30),"<br/>"].join("")}},Evol=Evol||{},EvoUI=Evol.UI,EvoDico=Evol.Dico,evoLang=EvolLang.filters,evoAPI={sEqual:"eq",sNotEqual:"ne",sStart:"sw",sContain:"ct",sFinish:"fw",sInList:"in",sIsNull:"null",sIsNotNull:"nn",sGreater:"gt",sSmaller:"lt",sBetween:"bw"};Evol.ViewFilter=Backbone.View.extend({events:{"click .evo-filters > button > .glyphicon-remove":"click_remove"},options:{fields:[],dateFormat:"mm/dd/yy",buttonLabels:!1,submitButton:!1,submitReady:!1},initialize:function(a){return this.options.fields=a.fields,this},render:function(){var a="btn btn-sm",b=this.options.buttonLabels,c=this,d=this.$el,e=['<div class="evo-filters"></div>','<button class="evo-bNew btn-primary ',a,'">',evoLang.bNewFilter,"</button>"];return this.options.submitButton&&e.push('<button class="evo-bSubmit">',evoLang.bSubmit,"</button>"),e.push('<div class="evo-editFilter"></div>','<button class="evo-bAdd btn-primary ',a,'" style="display:none;">',EvoUI.icon("ok"),"</button>",'<button class="evo-bDel ',a,'" style="display:none;">',EvoUI.icon("remove"),"</button>"),this._step=0,d.html(e.join("")),this.options.submitReady&&(this._hValues=$("<span></span>").appendTo(d)),this.options.submitButton&&(this._bSubmit=d.find(".evo-bSubmit").button({text:b}).on("click",function(){c.$el.trigger("submit.filter")})),this._bNew=d.find(".evo-bNew").button().on("click",function(){c._step<1&&(c._setEditorField(),c._step=1),c._bAdd.find(".ui-button-text").html(evoLang.bAddFilter)}),this._bAdd=d.find(".evo-bAdd").button().on("click",function(){var a=c._getEditorData();c._cFilter?c._enableFilter(a,c.options.highlight):c.addFilter(a),c._removeEditor()}),this._bDel=d.find(".evo-bDel").button().on("click",function(){c._removeEditor()}),this._editor=d.find(".evo-editFilter").on("change","#field",function(a){a.stopPropagation(),c._step>2&&c._editor.find("#value,#value2,.as-Txt").remove(),c._step>1&&(c._editor.find("#operator").remove(),c._bAdd.hide()),c._step=1;var b=$(a.currentTarget).val();if(""!==b){c._field=c._getFieldById(b);var d=c._type=c._field.type;c._setEditorOperator(),(d==EvoDico.fieldTypes.lov||d==EvoDico.fieldTypes.bool)&&c._setEditorValue()}else c._field=c._type=null}).on("change","#operator",function(a){a.stopPropagation(),c._operator=$(this).val(),c._step>2&&(c._editor.find("#value,#value2,.as-Txt").remove(),c._bAdd.hide(),c._step=2),c._setEditorValue()}).on("change keyup","#value,#value2",function(a){a.stopPropagation();var b=c._type,d=$(this).val(),e=""!==d||b==EvoDico.fieldTypes.lov||b==EvoDico.fieldTypes.bool;b==EvoDico.fieldTypes.number?e=e&&!isNaN(d):c._operator==evoAPI.sBetween&&(e=""!==c._editor.find("#value").val()&&""!==c._editor.find("#value2").val()),e?(c._bAdd.button("enable"),13==a.which&&c._bAdd.trigger("click")):c._bAdd.button("disable")}).on("click","#checkAll",function(){var a=$(this),b=a.attr("checked"),c=a.siblings();"checked"==b?c.attr("checked",b):c.removeAttr("checked")}),this._filters=d.find(".evo-filters").on("click","a",function(){c._editFilter($(this))}).on("click","a .ui-button-icon-secondary",function(a){a.stopPropagation();var b=$(this).parent();b.hasClass("ui-state-disabled")||b.fadeOut("slow",function(){b.remove(),c._triggerChange()})}),this},_getFieldById:function(a){if(!this._hash){this._hash={};for(var b=this.options.fields,c=0,d=b.length;d>c;c++)this._hash[b[c].id]=b[c]}return this._hash[a]},_removeEditor:function(){this._editor.empty(),this._bAdd.hide(),this._bDel.hide(),this._enableFilter(null,!1),this._bNew.removeClass("ui-state-active").show().focus(),this._bSubmit&&this._bSubmit.removeClass("ui-state-active").show(),this._step=0,this._field=this._type=this._operator=null},addFilter:function(a){return $(['<button class="btn btn-default btn-sm">',this._htmlFilter(a),"</button>"].join("")).prependTo(this._filters).button({icons:{secondary:"ui-icon-close"}}).data("filter",a).fadeIn(),this._triggerChange(),this},removeFilter:function(a){return this._filters.children().eq(a).remove(),this._triggerChange(),this},_htmlFilter:function(a){var b=['<span class="evo-lBold">',a.field.label,"</span> ",'<span class="evo-lLight">',a.operator.label,"</span> ",'<span class="evo-lBold">',a.value.label,"</span>"];return a.operator.value==evoAPI.sBetween&&b.push('<span class="evo-lLight"> ',evoLang.opAnd," </span>",'<span class="evo-lBold">',a.value.label2,"</span>"),b.push(EvoUI.icon("remove")),b.join("")},_enableFilter:function(a){this._cFilter&&(this._cFilter.button("enable").removeClass("ui-state-hover ui-state-active"),a?(this._cFilter.data("filter",a).find(":first-child").html(this._htmlFilter(a)),this._cFilter=null,this._triggerChange()):this._cFilter=null)},_editFilter:function(a){var b=a.data("filter"),c=b.field.value,d=b.operator.value,e=b.value;this._enableFilter(null,!1),this._removeEditor(),this._cFilter=a.button("disable"),this._setEditorField(c),this._setEditorOperator(d),d==evoAPI.sBetween?this._setEditorValue(e.value,e.value2):this._setEditorValue(e.value),this._bAdd.find(".ui-button-text").html(evoLang.bUpdateFilter),this._step=3},_setEditorField:function(a){if(this._step<1){if(this._bNew.stop().hide(),this._bSubmit&&this._bSubmit.stop().hide(),this._bDel.show(),!this._fList){var b=this.options.fields,c=[EvoUI.inputSelectBegin("field",null,!0)];_.each(b,function(a){c.push(EvoUI.inputOption(a.id,a.label))}),c.push("</select>"),this._fList=c.join("")}$(this._fList).appendTo(this._editor).focus()}a&&(this._field=this._getFieldById(a),this._type=this._field.type,this._editor.find("#field").val(a)),this._step=1},_setEditorOperator:function(a){var b=EvoDico.fieldTypes,c=this._type;if(this._step<2){var d=[];switch(c){case b.lov:d.push(EvoUI.inputHidden("operator",evoAPI.sInList)),this._operator=evoAPI.sInList;break;case b.bool:d.push(EvoUI.inputHidden("operator",evoAPI.sEqual)),this._operator=evoAPI.sEqual;break;default:switch(d.push(EvoUI.inputSelectBegin("operator","",!0)),c){case b.date:case b.time:c==b.time?d.push(EvoUI.inputOption(evoAPI.sEqual,evoLang.sAt),EvoUI.inputOption(evoAPI.sNotEqual,evoLang.sNotAt)):d.push(EvoUI.inputOption(evoAPI.sEqual,evoLang.sOn),EvoUI.inputOption(evoAPI.sNotEqual,evoLang.sNotOn)),d.push(EvoUI.inputOptions([{id:evoAPI.sGreater,text:evoLang.sAfter},{id:evoAPI.sSmaller,text:evoLang.sBefore},{id:evoAPI.sBetween,text:evoLang.sBetween}]));break;case b.number:d.push(EvoUI.inputOptions([{id:evoAPI.sEqual,text:evoLang.sNumEqual},{id:evoAPI.sNotEqual,text:evoLang.sNumNotEqual},{id:evoAPI.sGreater,text:evoLang.sGreater},{id:evoAPI.sSmaller,text:evoLang.sSmaller}]));break;default:d.push(EvoUI.inputOptions([{id:evoAPI.sEqual,text:evoLang.sEqual},{id:evoAPI.sNotEqual,text:evoLang.sNotEqual},{id:evoAPI.sStart,text:evoLang.sStart},{id:evoAPI.sContain,text:evoLang.sContain},{id:evoAPI.sFinish,text:evoLang.sFinish}]))}d.push(EvoUI.inputOption(evoAPI.sIsNull,evoLang.sIsNull),EvoUI.inputOption(evoAPI.sIsNotNull,evoLang.sIsNotNull)),d.push("</select>")}this._editor.append(d.join(""))}a&&c!=b.lov&&(this._editor.find("#operator").val(a),this._operator=a),this._step=2},_setEditorValue:function(a,b){var c=this._editor,d=this._type,e=EvoDico.fieldTypes,f=c.find("#operator").val(),g=!1,h=!0;if(""!==f){if(d==e.lov||f!=evoAPI.sIsNull&&f!=evoAPI.sIsNotNull){if(this._step<3){var i=[];switch(g=f==evoAPI.sBetween,d){case e.lov:i.push('<span id="value">'),this._field.list.length>7&&i.push(EvoUI.inputCheckbox("checkAll",!0),'<label for="checkAll">',EvolLang.All,"</label>"),i.push(EvoUI.inputCheckboxLOV(this._field.list)),i.push("</span>");break;case e.bool:i.push('<span id="value">',EvoUI.inputRadio("value","1",evoLang.yes,"0"!=a,"value1"),EvoUI.inputRadio("value","0",evoLang.no,"0"==a,"value0"),"</span>");break;case e.date:case e.time:case e.number:var j=d;i.push('<input id="value" type="',d,'"/>'),g&&i.push('<span class="as-Txt">',evoLang.opAnd," </span>",'<input id="value2" type="',j,'"/>'),h=!1;break;default:i.push(EvoUI.inputText("value","","evo-w-")),h=!1}c.append(i.join(""))}if(a){var k=c.find("#value");switch(d){case e.lov:k.find("#"+a.split(",").join(",#")).attr("checked","checked");break;case e.bool:k.find("#value"+a).attr("checked","checked");break;default:k.val(a),h=""!==a,g&&(k.next().next().val(b),h=""!==a&&""!==b)}}else h=d==e.lov||d==e.bool}else c.append(EvoUI.inputHidden("value",""));this._bAdd.button(h?"enable":"disable").show(),this._step=3}},_getEditorData:function(){var a=this._editor,b=a.find("#field"),c=a.find("#value"),d={field:{label:b.find("option:selected").text(),value:b.val()},operator:{},value:{}},e=EvoDico.fieldTypes,f=d.operator,g=d.value;if(this._type==e.lov){var h=[],i=[];c.find("input:checked").not("#checkAll").each(function(){h.push(this.value),i.push(this.nextSibling.innerHTML)}),0===h.length?(f.label=evoLang.sIsNull,f.value=evoAPI.sIsNull,g.label=g.value=""):1==h.length?(f.label=evoLang.sEqual,f.value=evoAPI.sEqual,g.label='"'+i[0]+'"',g.value=h[0]):(f.label=evoLang.sInList,f.value=evoAPI.sInList,g.label="("+i.join(", ")+")",g.value=h.join(","))}else if(this._type==e.bool){f.label=evoLang.sEqual,f.value=evoAPI.sEqual;var j="checked"==c.find("#value1").attr("checked")?1:0;g.label=1==j?evoLang.yes:evoLang.no,g.value=j}else{var k=a.find("#operator"),l=k.val();f.label=k.find("option:selected").text(),f.value=l,l==evoAPI.sIsNull||l==evoAPI.sIsNotNull?g.label=g.value="":(g.label=this._type==e.number||this._type==e.date||this._type==e.time?c.val():'"'+c.val()+'"',g.value=c.val(),l==evoAPI.sBetween&&(g.label2=g.value2=c.next().next().val()))}return d},_hiddenValue:function(a,b,c){a.push(EvoUI.inputHidden("fld-"+c,b.field.value),EvoUI.inputHidden("op-"+c,b.operator.value),EvoUI.inputHidden("val-"+c,b.value.value));var d=b.value.value2;d&&a.push(EvoUI.inputHidden("val2-"+c,d))},_setHiddenValues:function(){for(var a=this.val(),b=a.length,c=[EvoUI.inputHidden("elem",b)],d=0;b>d;d++)this._hiddenValue(c,a[d],d+1);this._hValues.html(c.join(""))},_triggerChange:function(){this.options.submitReady&&this._setHiddenValues(),this.$el.trigger("change.filter")},val:function(a){if("undefined"==typeof a){var b=[];return this._filters.find("a").each(function(){b.push($(this).data("filter"))}),b}this._filters.empty();for(var c=0,d=a.length;d>c;c++)this.addFilter(a[c]);return this._triggerChange(),this},valText:function(){var a=[];return this._filters.find("a").each(function(){a.push(this.text)}),a.join(" "+evoLang.opAnd+" ")},valUrl:function(){var a=this.val(),b=a.length,c=["filters=",b];if(1>b)return"";for(var d=0;b>d;d++){var e=a[d];c.push("&field-",d,"=",e.field.value,"&operator-",d,"=",e.operator.value,"&value-",d,"=",encodeURIComponent(e.value.value)),e.operator==evoAPI.sBetween&&c.push("&value2-",d,"=",encodeURIComponent(e.value.value2))}return c.push("&label=",encodeURIComponent(this.valText())),c.join("")},clear:function(){return this._cFilter=null,this._removeEditor(),this._filters.empty(),this._triggerChange(),this},length:function(){return this._filters.children().length},destroy:function(){var a=this.$el.off();a.find(".evo-bNew,.evo-bAdd,.evo-bDel,.evo-filters").off(),this._editor.off(),a.empty()}});var dico_field_ui={icon:"edi_fld.png",entity:"property",entities:"properties",elements:[{type:"panel",label:"Field",width:100,elements:[{id:"label",label:"Label",type:"text",cssclass:"FieldMain",cssclassview:"FieldMain",help:"Field title for the user",maxlength:100,required:!0,viewmany:!0,width:100}]},{type:"tab",label:"Definition",elements:[{type:"panel",label:"Validation",width:100,elements:[{id:"type",label:"Type",help:"User Type for the field on screen. Text, or emails can be char, varchar or nvarchar...",type:"lov",list:[{id:"text",text:"text",icon:"pix/ft-txt.gif"},{id:"textmultiline",text:"textmultiline",icon:"pix/ft-txtml.gif"},{id:"boolean",text:"boolean",icon:"pix/ft-bool.gif"},{id:"decimal",text:"decimal",icon:"pix/ft-dec.gif"},{id:"integer",text:"integer",icon:"pix/ft-int.gif"},{id:"date",text:"date",icon:"pix/ft-date.gif"},{id:"time",text:"time",icon:"pix/ft-time.gif"},{id:"datetime",text:"datetime",icon:"pix/ft-datehm.gif"},{id:"image",text:"image",icon:"pix/ft-img.gif"},{id:"lov",text:"lov",icon:"pix/ft-lov.gif"},{id:"email",text:"email",icon:"pix/ft-email.gif"},{id:"url",text:"url",icon:"pix/ft-url.gif"}],maxlength:100,required:!0,viewmany:!0,width:62},{id:"required",label:"Required",defaultvalue:!1,help:"Mandatory field",type:"boolean",maxlength:100,viewmany:!0,width:38,img:"checkr.gif"},{id:"maxlength",label:"Max. length",help:"Maximum number of characters allowed",type:"integer",maxlength:100,width:62},{id:"readonly",label:"Read only",defaultvalue:!1,help:"Users can view this field value but cannot modify it",type:"boolean",maxlength:100,width:38,img:"checkr.gif"},{id:"maxvalue",label:"Maximum value",conditions:[{visible:function(a){return"integer"===a.get("type")||"decimal"===a.get("type")}}],labellist:"Max.",type:"integer",maxlength:4,width:62},{id:"minvalue",label:"Minimum value",conditions:[{visible:function(a){return"integer"===a.get("type")||"decimal"===a.get("type")}}],labellist:"Min.",type:"integer",maxlength:4,width:38}]}]},{type:"tab",label:"Display",elements:[{type:"panel",label:"Display",width:100,elements:[{id:"position",label:"Position",help:"Integer (do not have to be consecutive)",type:"integer",maxlength:3,width:38},{id:"height",label:"Height",help:"Height in number of lines (for ''Textmultiline'' fields)",type:"integer",maxlength:3,defaultvalue:1,max:30,width:32},{id:"width",label:"Width",defaultvalue:100,help:"Relative width of the field (in percentage)",type:"integer",format:"0 '%'",maxlength:3,width:30},{id:"format",label:"Format",type:"text",help:"example '$ 0.00'",maxlength:"30",width:"38"},{id:"css",label:"CSS Field Edit",labellist:"CSS Edit",help:"Stylesheet class name for the field in edit mode.",type:"text",maxlength:20,width:32},{id:"viewmany",label:"List",help:"Field shows in lists",labellist:"List",type:"boolean",viewmany:!0,width:100}]}]},{type:"tab",id:"tab-model",label:"Model",elements:[{type:"panel",id:"map",optional:"1",label:"Model",width:100,elements:[{id:"attribute",label:"Attribute",help:"Attribute name in the Backbone model",required:!0,type:"text",maxlength:100,width:100},{id:"colpix",label:"UI name",type:"text",maxlength:100,width:100}]}]},{type:"tab",label:"User Help",elements:[{type:"panel",label:"Field Help",width:100,elements:[{etype:"field",id:"help",label:"Help",help:"Help on the field for edition",type:"textmultiline",maxlength:500,width:100,height:8}]}]}]};
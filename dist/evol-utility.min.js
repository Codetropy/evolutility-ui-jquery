/*   evol-utility 0.0.1 */

/*   (c) 2013 Olivier Giulieri */

var Evol=Evol||{};Evol.Dico={fieldTypes:{text:"text",txtm:"textmultiline",bool:"boolean",dec:"decimal",integer:"integer",date:"date",time:"time",datetime:"datetime",pix:"image",lov:"lov",email:"email",url:"url",pwd:"password",color:"color",hidden:"hidden",rating:"rating",tag:"tag"},fields:function(a,b){function c(a){a&&a.elements&&a.elements.length>0?_.each(a.elements,function(a){c(a)}):d.push(a)}var d=[];return c(a),_.isFunction(b)&&(d=_.filter(d,b)),d},showDesigner:function(a,b,c){var d,e=$('<div class="evol-des-'+b+'"></div>');switch(b){case"field":d=dico_field_ui}return c.closest(".evol-fld").append(e),vw=new Evol.ViewOne({toolbar:!0,model:null,uiModel:d,defaultView:"edit",el:e,button_addAnother:!1}),vw.render(),e.on("click","button#save,button#cancel",function(){alert("fld click button"),e.remove()}),this},showInfoBox:function(a,b){var c=this.$el.find(".evol-head-info");if(c.length)c.html(a);else{var d=['<div class="evol-head-info alert alert-',b,'">',EvoUI.iconClose(),a,"</div>"].join("");this.$el.prepend(d)}return this}};var Evol=Evol||{};Evol.UI={html:{trTableEnd:"</tr></table>",TdTrTableEnd:"</td></tr></table>",clearer:'<div class="clearfix"></div>'},icons:{customize:function(a,b){return['<i class="glyphicon glyphicon-wrench" data-id="',a,'" data-type="',b,'"></i>'].join("")}},html_more:function(a){return['<a href="javascript:void(0)" class="evol-more">',a,"</a>"].join("")},fieldLabel:function(a,b){return['<div class="evol-field-label"><label for="',a,'">',b,"</label></div>"].join("")},fieldLabelSpan:function(a,b){return['<span class="evol-field-label"><label for="',a,'">',b,"</label></span>"].join("")},link:function(a,b,c){return['<a class="Field" href="',c,'" id="',a,'">',b,"</a>"].join("")},linkEmail:function(a,b,c){return['<a class="Field" href="mailto:',c,'" id="',a,'">',b,"</a>"].join("")},inputText:function(a,b,c){var d=['<input class="form-control" type="text" id="',a,'" value="',b];return c&&(_.each(["min","max","maxlength","max-width","min-width","placeholder"],function(a){void 0!=c[a]&&d.push('" ',a,'="',c[a])}),_.each(["readonly"],function(a){var b=c[a];(b||"1"==b)&&d.push('" ',a,'="',a)})),d.push('" class="Field">'),d.join("")},inputTextInt:function(a,b){return['<input class="form-control" type="number" id="',a,'" value="',b,'" class="Field" maxlength="12">'].join("")},inputTextM:function(a,b,c,d){return['<textarea name="',a,'" id="',a,'" class="Field form-control"" rows="',d,c>0?'" onKeyUp="EvoVal.checkMaxLen(this,'+c+")":"",'">',b,"</textarea>"].join("")},inputTextMJSON:function(a,b,c){return['<textarea rows="',c,'" class="evol-json">',_.escape(JSON.stringify(b,null,"	")),"</textarea>"].join("")},inputAny:function(a,b,c){return['<input type="',a,'" id="',b,'" value="',c,'" class="Field form-control" size="15">'].join("")},inputDate:function(a,b){return EvoUI.inputAny("date",a,b)},inputDateTime:function(a,b){return EvoUI.inputAny("datetime-local",a,b)},inputTime:function(a,b){return EvoUI.inputAny("time",a,b)},inputColor:function(a,b){return['<input type="color" id="',a,'" value="',b,'" size="15">'].join("")},inputCheckbox:function(a,b){var c=['<input type="checkbox" id="',a,'"'];return null!=b&&""!=b&&"0"!=b&&c.push(' checked="checked"'),c.push(' value="1">'),c.join("")},inputRadio:function(a,b,c,d,e){return['<label for="',e,'"><input id="',e,'" name="',a,'" type="radio" value="',b,d?'" checked="checked':"",'">',c,"</label>&nbsp;"].join("")},inputLOV:function(a,b,c,d){var e=['<select class="form-control Field" id="',a,'"><option value="',b,'" selected>',c,"</option>"];return _.each(d,function(a){e.push(EvoUI.inputOption(a.id,a.text))}),e.push("</select>"),e.join("")},inputHidden:function(a,b){return['<input type="hidden" name="',a,'" id="',a,'" value="',b,'"/>'].join("")},inputOption:function(a,b){return['<option value="',a,'">',b,"</option>"].join("")},inputButton:function(a,b,c){return'<button type="button" id="'+a+'" class="btn'+(c?" "+c:"")+'">'+b+"</button>"},inputToggle:function(a){var b=['<div class="btn-group" data-toggle="buttons">'];return _.each(a,function(a){b.push('<label class="btn btn-info"><input type="radio" name="options" id="',a.id,'">',a.text,"</label>")}),b.push("</div>"),b.join("")},icon:function(a,b){return['<span class="',b?b+" ":"","glyphicon glyphicon-",a,'"></span>'].join("")},HTMLPanelLabel:function(a){return['<div class="panel-heading">',EvoUI.icon("chevron-up","evol-title-toggle"),'<h3 class="panel-title">',a,"</h3></div>"].join("")},HTMLMsg:function(a,b,c,d){return['<div class="alert alert-',c,d?' alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>':'">',"<strong>",a,"</strong> ",b,"</div>"].join("")},formatDate:function(a){return a.getMonth()+1+"/"+(a.getDate()+1)+"/"+a.getFullYear()},formatTime:function(a){return a.getHours()+":"+a.getMinutes()},getOrCreate:function(a){var b=$("#"+a);return null==b&&(b=$('<div id="'+a+"></div>"),$(body).append(b)),b},insertCollection:function(a,b){0==a.length&&_.each(b,function(b){a.create(b)})},capFirstLetter:function(a){return a&&a.length>0?a.substring(0,1).toUpperCase()+a.substring(1):""},setVisible:function(a,b){b?a.show():a.hide()}},Evol.UI.Charts={URL:"http://chart.apis.google.com/chart",_HTML:function(a,b){return['<div class="evol-chart-holder panel panel-info"><label class="evol-chart-title">',a,'</label><img src="',b,'"><br></div>'].join("")},Pie:function(a,b,c){var d=[EvoUI.Charts.URL,"?chd=t:",b.join(","),"&amp;chl=",c.join("|"),"&amp;cht=p&amp;chds=0,20&amp;chs=360x200"].join("");return EvoUI.Charts._HTML(a,d)},Bars:function(a,b,c){var d=_.max(b),e=[EvoUI.Charts.URL,"?chbh=a&amp;chs=350x200&cht=bvg&chco=3a87ad,d9edf7&chds=0,",d,"&amp;chd=t:",b.join("|"),"&amp;chp=0.05&amp;chts=676767,10.5&amp;chdl=",c.join("|")].join("");return EvoUI.Charts._HTML(a,e)}};var Evol=Evol||{},EvoUI=Evol.UI,EvoDico=Evol.Dico;Evol.ViewMany=Backbone.View.extend({cardinality:"n",viewName:"list",className:"evol-many-list",options:{style:"panel-info",pageSize:20},events:{"click a.evol-nav-id":"click_navigate","click .evol-sort-icons > span":"click_sort","click .button.edit":"click_pagination","click .evol-field-label .glyphicon-wrench":"click_customize"},initialize:function(a){var b=this;this.options.mode=a.mode,this.options.uiModel=a.uiModel,this.render(),this.model&&this.model.collection.on("change",function(){b.render()})},customize:function(){var a;return a="cards"==this.options.mode?this.$("h4 > a.evol-nav-id"):this.$("th > span"),this._custOn?(a.find("i").remove(),this._custOn=!1):(a.append(EvoUI.icons.customize("id","field")),this._custOn=!0),this},render:function(){var a=[];return this.model?this.renderList(a,this.options.mode):a.push(EvoUI.HTMLMsg(EvolLang.nodata,"","info")),this.$el.html(a.join("")),this},setModel:function(a){this.model=a,this.render()},updateModel:function(){alert("updateModel")},renderList:function(a,b){var c=this.options,d=c.uiModel,e=this.model.collection.models,f=c.pageSize||50,g=this._paginationSummaryHTML(0,f,e.length,d.entity,d.entities);a.push('<div class="evol-many-',b,'">'),"charts"!=b&&a.push(g,EvoUI.html.clearer),this["_HTML"+b.replace(/-/g,"_")](a,this.getFields(),f,d.icon),"charts"!=b&&a.push(g,this._paginationHTML(0,f,e.length)),a.push("</div>")},getFields:function(){return this._fields||(this._fields=EvoDico.fields(this.options.uiModel,function(a){return a.searchlist})),this._fields},_HTMLlist:function(a,b,c,d){a.push('<div class="panel ',this.options.style,'">'),a.push('<table class="table table-bordered table-hover"><thead>');for(var e=0;e<b.length;e++)this._renderListHeader(a,b[e]);a.push("</thead><tbody>"),this._HTMLlistbody(a,b,c,d),a.push("</tbody></table></div>")},_HTMLlistbody:function(a,b,c,d){var e=this.model.collection.models,f=_.min([e.length,c]);if(f>0)for(var g=0;f>g;g++)this._HTMLlistrow(a,b,e[g],d)},_hashLov:{},_lovText:function(a,b){if("list"in a&&a.list.length>0){a.id in this._hashLov||(this._hashLov[a.id]={});var c=this._hashLov[a.id];if(b in c)return c[b];for(var d=0,e=a.list.length;e>d;d++){var f=a.list[d];if(f.id==b)return c[b]=f.text,f.text}}return""},_HTMLlistrow:function(a,b,c,d){a.push('<tr data-id="',c.cid,'">');for(var e=0;e<b.length;e++){var f=b[e],g=c.get(f.id);a.push("<td>"),0==e&&(a.push('<a href="javascript:void(0)" id="fv-',f.id,'" class="evol-nav-id">'),d&&a.push('<img class="evol-table-icon" src="pix/',d,'">')),a.push(this._HTMLField(f,g)),0==e&&a.push("</a>"),a.push("</td>")}a.push("</tr>")},_HTMLcards:function(a,b,c,d){var e=this.model.collection.models,f=_.min([e.length,c]);if(f>0){for(var g=0;f>g;g++){a.push('<div class="panel ',this.options.style,'">');for(var h=0;h<b.length;h++){var i=b[h],j=e[g],k=j.get(i.id);a.push('<div data-id="',j.id,'">'),0==h?(a.push('<h4><a href="#" id="fg-',i.id,'" class="evol-nav-id">'),d&&a.push('<img class="evol-table-icon" src="pix/',d,'">'),a.push(this._HTMLField(i,k)),a.push("</a></h4>")):a.push(this._HTMLField(i,k)),a.push("</div>")}a.push("</div>")}a.push(EvoUI.html.clearer)}else a.push(EvoUI.HTMLMsg(EvolLang.nodata,"","info"))},_HTMLField:function(a,b){switch(a.type){case EvoDico.fieldTypes.bool:if(b>0||"True"==b)return EvoUI.icon("ok");break;case EvoDico.fieldTypes.lov:if(""!=b)return this._lovText(a,b);break;case EvoDico.fieldTypes.date:case EvoDico.fieldTypes.time:case EvoDico.fieldTypes.datetime:if(""!=b){var c=new Date(b);if(_.isDate(c)){var d="";return a.type!=EvoDico.fieldTypes.time&&(d+=EvoUI.formatDate(c)),a.type==EvoDico.fieldTypes.datetime&&(d+=" "),a.type!=EvoDico.fieldTypes.date&&(d+=EvoUI.formatTime(c)),d}}break;default:return b}return""},_HTMLcharts:function(a){var b=this,c=this.options.uiModel,d=this.model,e=d.collection.models,f=EvoDico.fields(c,function(a){return a.type==EvoDico.fieldTypes.lov||a.type==EvoDico.fieldTypes.bool});_.each(f,function(d){var f=_.countBy(e,function(a){return a.get(d.id)}),g=f,h=[],i=[];for(var j in g){var k=g[j];h.push(k),d.type==EvoDico.fieldTypes.lov?i.push(b._lovText(d,j)+" ("+k+")"):i.push(j+" ("+k+")")}var l=EvoUI.capFirstLetter(c.entities);d.type==EvoDico.fieldTypes.lov?a.push(EvoUI.Charts.Pie(l+" by "+d.label,h,i)):a.push(EvoUI.Charts.Bars(l+": "+d.label,h,i))}),a.push(EvoUI.html.clearer)},_renderListHeader:function(a,b){a.push('<th><span id="',b.id,'-lbl">',b.label,'<span class="evol-sort-icons" data-fid="',b.id,'">',EvoUI.icon("chevron-up"),EvoUI.icon("chevron-down"),"</span></span></th>")},_paginationSummaryHTML:function(a,b,c,d,e){var f,g=a*b+1;if(1>a){if(0===c)return c+" "+e;if(1===c)return c+" "+d;f=_.min([b,c])}else f=_.min([g+b,c]);return["<p>",g,"-",f," of ",c," ",e,"</p>"].join("")},_paginationHTML:function(a,b,c){var d=a*b+1,e=parseInt(c/b,10),f=e>5?5:e,g=['<ul class="pagination pagination-sm">'];a>0&&g.push('<li data-id="prev"><a href="#">&laquo;</a></li>');for(var h=d;f>h;h++)g.push('<li data-id="',h,'"><a href="#">',h,"</a></li>");return c>(a+1)*b&&g.push('<li data-id="next"><a href="#">&raquo;</a></li>'),g.push("</ul>"),g.join("")},click_navigate:function(a){var b=$(a.currentTarget),c="list"===this.options.mode?"tr":"div";a.type="list.navigate",this.$el.trigger(a,{id:b.closest(c).data("id")})},click_sort:function(a){var b=this.model.collection,c=$(a.currentTarget),d=c.parent().data("fid"),e=c.attr("class").indexOf("-up")>0;b.comparator=function(a){return a.get(d)},b.sort(),e&&b.models.reverse(),this.render(),c.addClass("evol-last-sort"),this.$el.trigger("list.sort",{id:d,up:e})},click_pagination:function(a){this.$el.trigger("list.paginate",{id:$(a.currentTarget).closest("li").data("id")})},click_customize:function(a){var b=$(a.currentTarget),c=b.data("id"),d=b.data("type");EvoDico.showDesigner(c,d,b),this.$el.trigger(d+".customize",{id:c,type:d})}}),String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")};var Evol=Evol||{},EvoUI=Evol.UI,EvoDico=Evol.Dico;Evol.ViewOne=Backbone.View.extend({events:{"click .evol-buttons > button":"click_button","click .evol-title-toggle":"click_toggle","click ul.evol-tabs > li > a":"click_tab","click label > .glyphicon-question-sign":"click_help","click .evol-field-label .glyphicon-wrench":"click_customize"},cardinality:"1",viewName:"list",prefix:"fe",options:{mode:"edit",compactView:!1,button_addAnother:!0,style:"panel-info"},initialize:function(a){var b=this,c=a.mode;this.options.mode=c,this.options.uiModel=a.uiModel,this.render(),this.model&&this.model.on("change",function(a){b.setModel(a)}),("new"===c||"edit"===c)&&(this.windowSize="big",$(window).resize(function(){var a=b.$(".evol-pnl");$(window).width()>480?"big"!==b.windowSize&&(_.each(a,function(a){var b=$(a),c=b.data("p-width");b.attr("style","width:"+c+"%;")}),b.windowSize="big"):"small"!==b.windowSize&&(a.attr("style","width:100%"),b.windowSize="small")}))},render:function(){var a=this.options.mode,b=[];return"json"===a?this.renderJSON(b,a):this.renderEdit(b,a),this.$el.html(b.join("")),this.setData(this.model),this.custOn=!1,this},getFields:function(){return this._fields||(this._fields=EvoDico.fields(this.options.uiModel)),this._fields},setModel:function(a){this.model=a,this.clearErrors(),this.setData(a)},modelUpdate:function(a){var b=this;_.each(a.changed,function(a,c){b.setFieldValue(c,a)})},getData:function(){var a=this.options.mode,b=EvoDico.fieldTypes,c={},d=this.getFields(),e=this.$el,f="#"+this.prefix+"-";if(a&&"json"===a){var g=e.children("textarea").val();c=$.parseJSON(g)}else _.each(d,function(a){var d=e.find(f+a.id);switch(a.type){case b.bool:c[a.id]=d.prop("checked");break;default:c[a.id]=d.val()}});return c},setData:function(a){var b,c=this.getFields(),d=this.options.mode,e=this,f="#"+e.prefix+"-";d&&"json"===d?this.$el.children("textarea").val(JSON.stringify(a,null,2)):_.each(c,function(c){if(b=e.$(f+c.id),a)switch(c.type){case"boolean":b.prop("checked",a.get(c.id));break;default:b.val(a.get(c.id))}})},clear:function(){var a,b=this.getFields(),c=this.options.mode,d=this,e="#"+d.prefix+"-";c&&"json"===c?this.$el.children("textarea").val(""):_.each(b,function(b){switch(a=d.$(e+b.id),b.type){case"boolean":a.prop("checked",b.default||"");break;default:a.val(b.default||"")}})},setFieldValue:function(a,b){this.$("#"+this.fieldViewId(a)).val(b)},showTab:function(a){var b=this.$(a);return b.length>0&&(b.siblings(".tab-pane").hide(),b.show()),b=this.$('.evol-tabs > li a[href="'+a+'"]').parent(),b.length>0&&(b.siblings("li").removeClass("active"),b.addClass("active")),this.$el.trigger("tab.show"),this},_renderButtons:function(a,b){a.push(EvoUI.html.clearer,'<div class="evol-buttons form-actions">',EvoUI.inputButton("save",EvolLang.Save,"btn-primary")),this.options.button_addAnother&&"json"!==b&&a.push(EvoUI.inputButton("save-add",EvolLang.SaveAdd)),a.push(EvoUI.inputButton("cancel",EvolLang.Cancel),"</div>")},renderEdit:function(a,b){var c=-1,d=-1,e=this.options,f=e.uiModel.elements;if("mini"===b){var g=EvoDico.fields(e.uiModel,function(a){return a.searchlist||a.required||a.mini},e.mode),h={type:"panel","class":"evo-mini-holder",label:EvoUI.capFirstLetter(e.uiModel.entity),width:100,elements:g};this.renderPanel(a,h,"evo-one-mini",b)}else{a.push('<div class="evo-one-',b,'">');for(var i=0,j=f.length;j>i;i++){var k=f[i];switch(k.type){case"tab":d>0&&(a.push("</div>"),d=-1),0>c&&(a.push(EvoUI.html.clearer),this.renderTabs(a,f),a.push('<div class="tab-content">')),c++,a.push('<div id="evol-tab-',i,'" class="tab-pane',1===i?' active">':'">'),this.renderTab(a,k,b),c==j-1&&a.push("</div>");break;case"panel":0>d&&(a.push('<div class="evol-pnls">'),d=1),this.renderPanel(a,k,"pe-"+i,b);break;case"panel-list":0>d&&(a.push(""),d=1),this.renderPanelList(a,k,"pe-"+i,b)}}d>0&&a.push("</div>"),a.push("</div>")}this._renderButtons(a,b)},renderJSON:function(a,b){if(this.model){var c=JSON.stringify(this.model.toJSON(),null,2);a.push(EvoUI.inputTextMJSON("",c,10))}this._renderButtons(a,b)},renderTabs:function(a,b){var c=!0;a.push('<ul class="nav nav-tabs evol-tabs">'),_.each(b,function(b,d){"tab"==b.type&&(c?(a.push('<li class="active">'),c=!1):a.push("<li>"),a.push('<a href="#evol-tab-',d,'">',b.label,"</a></li>"))}),a.push("</ul>")},renderTab:function(a,b,c){var d=this;a.push('<div class="evol-pnls">'),_.each(b.elements,function(b,e){"panel-list"===b.type?d.renderPanelList(a,b,"pl-"+e,c):d.renderPanel(a,b,"pl-"+e,c)}),a.push(EvoUI.html.clearer,"</div></div>")},renderPanel:function(a,b,c,d){var e=this;"mini"===d?(a.push('<div data-p-width="',b.width,'" class="w-100 evol-pnl ',b.class||"",'">','<div class="panel ',this.options.style,'">',EvoUI.HTMLPanelLabel(b.label,c,"PanelLabel"),'<fieldset data-pid="',c,'">'),_.each(b.elements,function(b){a.push('<div class="pull-left evol-fld w-100">'),e.renderField(a,b,d),a.push("</div>")})):(a.push('<div style="width:',b.width,'%" data-p-width="',b.width,'" class="pull-left evol-pnl">','<div class="panel ',this.options.style,'">',EvoUI.HTMLPanelLabel(b.label,c,"PanelLabel"),'<fieldset data-pid="',c,'">'),_.each(b.elements,function(b){a.push('<div style="width:',parseInt(b.width),'%" class="pull-left evol-fld">'),e.renderField(a,b,d),a.push("</div>")})),a.push("</fieldset></div></div>")},renderPanelList:function(a,b,c){a.push('<div style="width:',b.width,'%" class="pull-left evol-pnl">','<div class="panel ',this.options.style,'">',EvoUI.HTMLPanelLabel(b.label,c,"PanelLabel"),'<table width="100%" class="table-striped"><tr>'),_.each(b.elements,function(b){a.push("<th>",b.label,"</th>")}),a.push("</tr><tr>"),_.each(b.elements,function(b){a.push("<td>",b.label,"</td>")}),a.push("</tr></table></div></div>")},renderField:function(a,b,c){function d(a){return a.toLocaleLowerCase().replace(/ /g,"_").replace(/\(/g,"").replace(/\)/g,"")}var e,f,g,h=EvoDico.fieldTypes;if(b.id&&""!=b.id?e=b.id:(e=d(b.label),b.id=e),this.model&&this.model.has(e)&&(f="new"!=c?this.model.get(e):b.default?b.default:""),e=this.fieldViewId(e),"mini"===c?(g=b.width,b.width=100,a.push('<div class="evo-mini-label">'),this.renderFieldLabel(a,b,c),a.push('</div><div class="evo-mini-content">')):this.renderFieldLabel(a,b,c),b.readonly>0)a.push('<div id="',e,'" class="FieldReadOnly">',f,"&nbsp;</div>");else switch(b.type){case h.text:a.push(EvoUI.inputText(e,f,b));break;case h.email:"view"===c?a.push(EvoUI.link(e,f,"mailto:"+HttpUtility.HtmlEncode(f))):a.push(EvoUI.inputText(e,f,b.maxlength));break;case h.url:"view"===c?a.push(EvoUI.link(e,f,HttpUtility.HtmlEncode(f))):a.push(EvoUI.inputText(e,f,b.maxlength));break;case h.integer:case h.dec:a.push(EvoUI.inputTextInt(e,f));break;case h.bool:a.push(EvoUI.inputCheckbox(e,f));break;case h.txtm:case h.html:null==b.height?b.height=5:(fHeight=parseInt(b.height),1>fHeight&&(b.height=5)),a.push(EvoUI.inputTextM(e,f,b.maxlength,b.height));break;case h.date:a.push(EvoUI.inputDate(e,f));break;case h.datetime:a.push(EvoUI.inputDateTime(e,f));break;case h.time:a.push(EvoUI.inputTime(e,f));break;case h.color:a.push(EvoUI.inputColor(e,f));break;case h.lov:a.push(EvoUI.inputLOV(e,f,"",b.list||[]));break;case h.integer:a.push(EvoUI.inputTextInt(e,f,b.type,b.max,b.min));break;case h.pix:""==f?a.push('<p class="">No picture</p>'):a.push('<img src="',f,'" class="img-thumbnail">')}"mini"===c&&(a.push("</div>"),b.width=g)},renderFieldLabel:function(a,b,c){a.push('<div class="evol-field-label" id="',b.id,'-lbl"><label class="control-label" for="',b.id,'">',b.label),"view"!=c&&b.required>0&&a.push('<span class="evol-required">*</span>'),b.help&&""!=b.help&&a.push(EvoUI.icon("question-sign","")),a.push("</label></div>")},validate:function(){var a=this.getFields();return this.clearErrors(),_.isArray(a)?(this.$el.trigger("view.validate"),EvoVal.checkFields(this.$el,a,this.prefix)):!1},clearErrors:function(){this.$(".control-group.error").removeClass("control-group error"),this.$(".has-error").removeClass("has-error"),this.$(".text-danger").remove()},fieldViewId:function(a){return this.prefix+"-"+a},customize:function(){var a=".evol-field-label > label",b=".evol-pnl .panel-title";return this.custOn?(this.$(a+" > i, "+b+" > i").remove(),this.custOn=!1):(_.each(this.$(a),function(a){var b=$(a),c=b.attr("for");b.append(EvoUI.icons.customize(c,"field"))}),this.$(b).append(EvoUI.icons.customize("id","panel")),this.custOn=!0),this},showHelp:function(a,b,c){var d=EvoDico.fields(this.options.uiModel),e=_.findWhere(d,{id:a});if(e||e.help){var f=c.closest(".evol-fld"),g=f.find(".help-block");if(g.length>0)g.remove();else{var h=$('<span class="help-block">'+_.escape(e.help)+"</span>");f.append(h)}}return this},click_button:function(a){a.preventDefault();var b=$(a.currentTarget).attr("id"),c=this.validate();""==c&&("new"===this.options.mode?this.model.collection.create(this.getData(),{success:function(){},error:function(){}}):(this.model.set(this.getData()),this.model.save({success:function(){},error:function(){}})),this.$el.trigger("button."+b))},click_toggle:function(a){var b=$(a.target),c=b.closest(".panel-heading").next(),d=c.data("expState");a.preventDefault(),a.stopImmediatePropagation(),a.shiftKey?(b=this.$(".evol-title-toggle"),b="down"===d?this.$(".evol-title-toggle.glyphicon-chevron-down").trigger("click"):this.$(".evol-title-toggle.glyphicon-chevron-up").trigger("click")):"down"===d?(b.closest(".panel").css("height",""),c.slideDown(400).data("expState","up"),b.addClass("glyphicon-chevron-up").removeClass("glyphicon-chevron-down")):(c.slideUp(400,function(){b.closest(".panel").css("height","40px")}).data("expState","down"),b.removeClass("glyphicon-chevron-up").addClass("glyphicon-chevron-down")),this.$el.trigger("panel.toggle")},click_tab:function(a){var b=a.target.href,c=b.substring(b.indexOf("#"));a.stopImmediatePropagation(),a.preventDefault(),a.shiftKey?this.$(".tab-content > div").show():this.showTab(c)},click_help:function(a){var b=$(a.currentTarget),c=b.closest("label").attr("for"),d=b.data("type");this.showHelp(c,d,b),this.$el.trigger(d+".help",{id:c})},click_customize:function(a){var b=$(a.currentTarget),c=b.data("id"),d=b.data("type");EvoDico.showDesigner(c,d,b),this.$el.trigger(d+".customize",{id:c,type:d})}});var EvoVal={checkMaxLen:function(a,b){a.value.length>b&&(a.value=a.value.substring(0,b-1))},checkNum:function(a,b){var c,d=a.value;if("i"==b.substring(0,1))c=parseInt(d,10);else{var e=EvolLang.LOCALE;("FR"==e||"DA"==e)&&(d=d.replace(",",".")),c=parseFloat(d)}isNaN(c)?a.value="":d!=c&&(a.value=c)},setValidationFlags:function(a,b){var c=a.find(".text-danger");c.length?c.html(b):a.append('<p class="text-danger">'+b+"</p>"),a.addClass("has-error")},checkFields:function(holder,fds,prefix){function typeCheck(){var a=EvoDico.fieldTypes,b=$f.val().trim();if(""!=b)switch(fd.type){case a.integer:case a.email:evoRegEx[fd.type].test(b)||EvoVal.setValidationFlags($f.parent(),labMsg(EvolLang[fd.type]));break;case a.dec:var c=evoRegEx[fd.type+EvolLang.LOCALE];null==c&&(c=evoRegEx[fd.type+"EN"]),c.test(b)||EvoVal.setValidationFlags($f.parent(),labMsg(EvolLang[fd.type]));break;case a.date:case a.datetime:""==b||_.isDate(new Date(b))||EvoVal.setValidationFlags($f.parent(),labMsg(EvolLang[fd.type]))}}function isEmpty(a){var b,c=a.tagName;return b="SELECT"==c&&a.get(0).selectedIndex>-1?"0"==f.options[a.get(0).selectedIndex].value:""==a.val().trim()}function labMsg(a,b){var c=a.replace("{0}",fd.label);return null!=b&&(c=c.replace("{1}",b)),msgs.push(c),c}var evoRegEx={email:/^[\w\.\-]+@[\w\.\-]+\.[\w\.\-]+$/,integer:/^-?\d+$/,decimalEN:/^\d+(\.\d+)?$/,decimalFR:/^\d+(\,\d+)?$/,decimalDA:/^\d+(\,\d+)?$/},msgs=[],ff=null;for(var i in fds){var fd=fds[i],$f=holder.find("#"+prefix+"-"+fd.id).eq(0),isHTML="html"==fd.type;if(isHTML&&$f.val(nicEditors.findEditor(f.id).getContent()),$f.length>0){var noErr=!0;if(fd.required>0)if(isEmpty($f,isHTML)){var msgf=labMsg(EvolLang.empty),p=$f.parent();EvoVal.setValidationFlags(p,msgf),noErr=!1}else $f.parent().removeClass("control-group error").find(".evol-warn-error").remove(),typeCheck();else typeCheck();if(null!=fd.rg){var rg=new RegExp(fd.rg);if(!$f.val().match(rg)){var msgf=labMsg(EvolLang.reg,fd.rg),p=$f.parent();EvoVal.setValidationFlags($f.parent(),msgf)}}if(null!=fd.jsv&&(p=eval([fd.jsv,'("',Evol.prefix,fd.id,'","',fd.label,'")'].join("")),null!=p&&p.length>0&&EvoVal.setValidationFlags($f.parent(),labMsg(p))),noErr){var fv=$f.val().trim();""!=fv&&(null!=fd.max&&parseFloat(fv)>fd.max&&EvoVal.setValidationFlags($f.parent(),labMsg(EvolLang.max,fd.max)),null!=fd.min&&parseFloat(fv)<fd.min&&EvoVal.setValidationFlags($f.parent(),labMsg(EvolLang.min,fd.min)))}}}return msgs.length>0?[EvolLang.intro,"<ul><li>",msgs.join("<li>"),"</li></ul>"].join(""):""}},Evol=Evol||{},EvoUI=Evol.UI;Evol.ViewToolbar=Backbone.View.extend({events:{"click .nav a":"click_toolbar","list.navigate div":"click_navigate"},prefix:"tbr",version:"0.0.1",options:{toolbar:!0,cardinality:"one",defaultView:"list",style:"normal",customize:!1},state:{},views:[],viewsHash:{},curView:null,curViewName:"",initialize:function(a){this.options.mode=a.mode,this.options.uiModel=a.uiModel,this.options.defaultView=a.defaultView,this.render(),$(".dropdown-toggle").dropdown()},render:function(){var a=this.$el;a.html(this._toolbarHTML()),this.setView(this.options.defaultView||"list")},_toolbarHTML:function(){function a(a){return['<li class="dropdown">','<a href="#" class="dropdown-toggle" data-toggle="dropdown">',EvoUI.icon(a),' <b class="caret"></b></a>','<ul class="dropdown-menu">'].join("")}function b(a,b,c,d){var e=[];return d?e.push('<li data-cardi="'+d,'">'):e.push("<li>"),e.push('<a href="#" data-id="',a,'">',EvoUI.icon(c),b,"</a></li>"),e.join("")}var c="</ul></li>",d='<li role="presentation" class="divider"></li>',e=(this.options,['<ul class="nav nav-pills" style="float:left;">',b("new","","plus"),b("del","","trash","1"),b("list","","th-list"),b("charts","","stats")]);return this.options&&this.options.customize&&e.push(a("wrench"),b("customize","Customize this view","wrench"),d,b("new-field","New Field","plus"),b("new-panel","New Panel","plus"),c),e.push(b("prev","","chevron-left","1"),b("next","","chevron-right","1"),'</ul><ul class="nav nav-pills" style="float:right;">',b("list","","th-list","n"),b("cards","","th-large","n"),b("edit","","th","1"),b("mini","","th-large","1"),b("json","","barcode","1"),"</ul>",EvoUI.html.clearer),e.join("")},updateModel:function(){this.refresh()},refresh:function(){this.viewsHash.list&&this.viewsHash.list.render(),this.viewsHash.cards&&this.viewsHash.cards.render()},setView:function(a){var b=a,c=this.$el,d="evolw-"+a,e=this.$('[data-vid="'+d+'"]'),f=this.curView;if("customize"===a)f&&f.customize&&f.customize();else if("filter"===a){var g=$("#evol-filter");0===g.length&&(g=$('<div id="evol-filter" class="table table-bordered"><button type="button" class="close" data-dismiss="alert">&times;</button><div class="evol-filter-content"></div></div>'),c.prepend(g),g.find(".evol-filter-content").advancedSearch({fields:contacts_search}))}else if(this.curView&&this.curView.$el.hide(),e.length)this.curView=this.viewsHash[a],this.curViewName=a,this.curView.options.mode=a,this.curView.setModel(this.model),"new"===b&&this.curView.clear(),e.show(),this.setToolbar(a);else{e=$('<div data-vid="evolw-'+a+'"></div>'),c.append(e);var h={el:e,mode:b,model:this.model,uiModel:this.options.uiModel};switch(a){case"new":case"edit":case"mini":case"view":case"json":f=new Evol.ViewOne(h),this.viewsHash[b]=f,this.views.push(f),"new"===a&&f.clear();break;case"charts":case"cards":case"list":f=new Evol.ViewMany(h)}this.curView=f,this.curViewName=a,this.viewsHash[a]=f,this.setToolbar(a)}},getToolbarButtons:function(){return this._toolbarButtons||(this._toolbarButtons={ones:this.$el.find('li[data-cardi="1"]'),manys:this.$el.find('li[data-cardi="n"]'),prevNext:this.$el.find('[data-id="prev"],[data-id="next"]'),customize:this.$el.find('a[data-id="customize"]').parent()}),this._toolbarButtons},setToolbar:function(a){function b(a,b){EvoUI.setVisible(c.ones,a),EvoUI.setVisible(c.manys,b)}if(this.$el){var c=this.getToolbarButtons(),d=a.indexOf("search")>-1;EvoUI.setVisible(c.customize,"json"!=a&&!d),c.prevNext.hide(),"new"===a?b(!1,!1):"cards"===a||"list"===a||"charts"===a?b(!1,!0):d?b(!1,!1):(b(!0,!1),c.prevNext.show())}},setData:function(a){return this.curView&&this.curView.setData(a),this},getData:function(){return this.curView?this.curView.getData():null},click_toolbar:function(a){var b=$(a.target);"A"!==b.tagName&&(b=b.closest("a"));var c=b.data("id");switch(a.preventDefault(),a.stopImmediatePropagation(),c){case"del":if(confirm("Are you sure you want to delete this record?")){var d=this.model.collection;this.model.destroy({success:function(){},error:function(){alert("error")}}),this.model=d.models[0],this.curView.setModel(d.models[0])}break;case"customize":this.curView.customize();break;case"prev":case"next":if(this.model){var d=this.model.collection,e=d.length-1,f=this.curView.model,g=_.indexOf(d.models,f);g="prev"===c?g>0?g-1:e:e>g?g+1:0,this.model=f=d.models[g],_.each(this.views,function(a){a.setModel(f)})}break;case"new-field":case"new-panel":EvoDico.showDesigner("id","field",b);break;default:c&&""!==c&&this.setView(c)}a.stopImmediatePropagation()},click_navigate:function(a,b){var c=this.model.collection.get(b.id);this.model=c,this.setView("edit"),this.curView.model=c,this.curView.render(),a.stopImmediatePropagation()}});var EvolLang={LOCALE:"EN",nodata:"No data.",intro:"You are not finished yet:",empty:'"{0}" must have a value.',email:'"{0}" must be a valid email.',integer:'"{0}" must only use numbers.',decimal:'"{0}" must be a valid decimal numbers.',date:'"{0}" must be a valid date, format must be "MM/DD/YYYY" like "12/24/2005".',datetime:'"{0}" must be a valid date/time, format must be "MM/DD/YYYY hh:mm am/pm" like "12/24/2005 10:30 am".',time:'"{0}" must be a valid date/time, format must be "hh:mm am/pm" like "10:30 am".',max:'"{0}" must be smaller or equal to {1}.',min:'"{0}" must be greater or equal to {1}.',reg:'"{0}" must match the regular expression pattern "{1}".',Save:"Save",SaveAdd:"Save and Add Another",Cancel:"Cancel",NoChange:"No Change",NoX:"No {0}",View:"View",Edit:"Edit",New:"New",NewItem:"New Item",NewUpload:"New Upload",Search:"Search",NewSearch:"New Search",Selections:"Selections",Selection:"Selection",Export:"Export",SearchRes:"Search Result",MassUpdate:"Mass Update",Delete:"Delete",ListAll:"List All",Print:"Print",DeleteEntity:"Delete this {0}?",Back2SearchResults:"Back to search results",DownloadEntity:"Download {0}"};